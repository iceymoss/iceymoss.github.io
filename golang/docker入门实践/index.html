<!doctype html>
<html lang="zh-cn">
  <head>
    <title>docker入门实践 // iceymoss - 刻意练习，卷无止境</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.111.3">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="iceymoss" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="docker入门实践"/>
<meta name="twitter:description" content="[toc] docker docker安装 安装的话直接去官网下载即可，或者可以查看菜鸟教程的安装。 docker容器 docker命令 docker 使用docker查看所以命令，"/>

    <meta property="og:title" content="docker入门实践" />
<meta property="og:description" content="[toc] docker docker安装 安装的话直接去官网下载即可，或者可以查看菜鸟教程的安装。 docker容器 docker命令 docker 使用docker查看所以命令，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iceymoss.github.io/golang/docker%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5/" /><meta property="article:section" content="golang" />
<meta property="article:published_time" content="2023-05-06T22:03:06+08:00" />
<meta property="article:modified_time" content="2023-05-06T22:03:06+08:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://iceymoss.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="iceymoss" /></a>
      <span class="app-header-title">iceymoss - 刻意练习，卷无止境</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">首页</a>
             - 
          
          <a class="app-header-menu-item" href="/archives/">归档</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">标签</a>
             - 
          
          <a class="app-header-menu-item" href="/categories/">类别</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">关于</a>
      </nav>
      <p>iceymoss&#39;s blog, Golang Python Developer Life</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">docker入门实践</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          May 6, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          59 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://iceymoss.github.io/tags/docker/">docker</a>
              <a class="tag" href="https://iceymoss.github.io/tags/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">容器技术</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>[toc]</p>
<h1 id="docker">docker</h1>
<h2 id="docker安装">docker安装</h2>
<p>安装的话直接去<a href="https://www.docker.com/">官网下载</a>即可，或者可以查看<a href="https://www.runoob.com/docker/ubuntu-docker-install.html">菜鸟教程</a>的安装。</p>
<h2 id="docker容器">docker容器</h2>
<h3 id="docker命令">docker命令</h3>
<blockquote>
<p>docker</p>
</blockquote>
<p>使用docker查看所以命令，命令格式：<code>docker 一级命令 二级命令</code></p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker ps -a
</span></span></code></pre></div><p>查看所有容器(正在运行，退出)</p>
<blockquote>
<p>docker version</p>
</blockquote>
<p><code>docker version</code>查看docker版本相关的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker version                                                                                                                                                                                14:47:03
</span></span><span style="display:flex;"><span>Client:
</span></span><span style="display:flex;"><span> Cloud integration: v1.0.31
</span></span><span style="display:flex;"><span> Version:           20.10.23
</span></span><span style="display:flex;"><span> API version:       1.41
</span></span><span style="display:flex;"><span> Go version:        go1.18.10
</span></span><span style="display:flex;"><span> Git commit:        <span style="color:#ae81ff">7155243</span>
</span></span><span style="display:flex;"><span> Built:             Thu Jan <span style="color:#ae81ff">19</span> 17:35:19 <span style="color:#ae81ff">2023</span>
</span></span><span style="display:flex;"><span> OS/Arch:           darwin/arm64
</span></span><span style="display:flex;"><span> Context:           desktop-linux
</span></span><span style="display:flex;"><span> Experimental:      true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server: Docker Desktop 4.17.0 <span style="color:#f92672">(</span>99724<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> Engine:
</span></span><span style="display:flex;"><span>  Version:          20.10.23
</span></span><span style="display:flex;"><span>  API version:      1.41 <span style="color:#f92672">(</span>minimum version 1.12<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Go version:       go1.18.10
</span></span><span style="display:flex;"><span>  Git commit:       6051f14
</span></span><span style="display:flex;"><span>  Built:            Thu Jan <span style="color:#ae81ff">19</span> 17:31:28 <span style="color:#ae81ff">2023</span>
</span></span><span style="display:flex;"><span>  OS/Arch:          linux/arm64
</span></span><span style="display:flex;"><span>  Experimental:     false
</span></span><span style="display:flex;"><span> containerd:
</span></span><span style="display:flex;"><span>  Version:          1.6.18
</span></span><span style="display:flex;"><span>  GitCommit:        2456e983eb9e37e47538f59ea18f2043c9a73640
</span></span><span style="display:flex;"><span> runc:
</span></span><span style="display:flex;"><span>  Version:          1.1.4
</span></span><span style="display:flex;"><span>  GitCommit:        v1.1.4-0-g5fd4c4d
</span></span><span style="display:flex;"><span> docker-init:
</span></span><span style="display:flex;"><span>  Version:          0.19.0
</span></span><span style="display:flex;"><span>  GitCommit:        de40ad0
</span></span></code></pre></div><blockquote>
<p>docker info</p>
</blockquote>
<p><code>docker info</code> 显示容器运行情况等信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker info                                                                                                                                                                                   14:47:54
</span></span><span style="display:flex;"><span>Client:
</span></span><span style="display:flex;"><span> Context:    desktop-linux
</span></span><span style="display:flex;"><span> Debug Mode: false
</span></span><span style="display:flex;"><span> Plugins:
</span></span><span style="display:flex;"><span>  buildx: Docker Buildx <span style="color:#f92672">(</span>Docker Inc., v0.10.3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  compose: Docker Compose <span style="color:#f92672">(</span>Docker Inc., v2.15.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  dev: Docker Dev Environments <span style="color:#f92672">(</span>Docker Inc., v0.1.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  extension: Manages Docker extensions <span style="color:#f92672">(</span>Docker Inc., v0.2.18<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  sbom: View the packaged-based Software Bill Of Materials <span style="color:#f92672">(</span>SBOM<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> an image <span style="color:#f92672">(</span>Anchore Inc., 0.6.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  scan: Docker Scan <span style="color:#f92672">(</span>Docker Inc., v0.25.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  scout: Command line tool <span style="color:#66d9ef">for</span> Docker Scout <span style="color:#f92672">(</span>Docker Inc., v0.6.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server:
</span></span><span style="display:flex;"><span> Containers: <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>  Running: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  Paused: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  Stopped: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span> Images: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span> Server Version: 20.10.23
</span></span><span style="display:flex;"><span> Storage Driver: overlay2
</span></span><span style="display:flex;"><span>  Backing Filesystem: extfs
</span></span><span style="display:flex;"><span>  Supports d_type: true
</span></span><span style="display:flex;"><span>  Native Overlay Diff: true
</span></span><span style="display:flex;"><span>  userxattr: false
</span></span><span style="display:flex;"><span> Logging Driver: json-file
</span></span><span style="display:flex;"><span> Cgroup Driver: cgroupfs
</span></span><span style="display:flex;"><span> Cgroup Version: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> ……
</span></span><span style="display:flex;"><span> ……
</span></span><span style="display:flex;"><span> ……
</span></span></code></pre></div><blockquote>
<p>docker image ls</p>
</blockquote>
<p>可以简写为<code>docker images</code></p>
<p>查看所有容器镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker images                                                                                                                                                                                 14:49:55
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>redis        latest    cedd18a74eff   <span style="color:#ae81ff">2</span> weeks ago     111MB
</span></span><span style="display:flex;"><span>alpine/git   latest    9793ee61fc75   <span style="color:#ae81ff">4</span> months ago    43.4MB
</span></span><span style="display:flex;"><span>ubuntu       latest    d5ca7a445605   <span style="color:#ae81ff">18</span> months ago   65.6MB
</span></span><span style="display:flex;"><span>ubuntu       15.10     9b9cb95443b5   <span style="color:#ae81ff">6</span> years ago     137MB
</span></span></code></pre></div><blockquote>
<p>docker pull imagename</p>
</blockquote>
<p>去远程拉取镜像，这里的远程指<code>docker Hub</code></p>
<blockquote>
<p>docker images rm imagename</p>
</blockquote>
<p>删除镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image rm ubuntu
</span></span></code></pre></div><blockquote>
<p>docker container ls</p>
</blockquote>
<p>查看正在运行在容器，也可以使用：<code>docker ps</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container ls                                                                                                                                                                           15:19:39
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED       STATUS      PORTS                    NAMES
</span></span><span style="display:flex;"><span>5a6f69f16a45   cedd18a74eff   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago    Up <span style="color:#ae81ff">9</span> days   6379/tcp                 angry_euler
</span></span><span style="display:flex;"><span>1e3b9cd32745   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">10</span> days ago   Up <span style="color:#ae81ff">4</span> days   0.0.0.0:6379-&gt;6379/tcp   competent_wilson
</span></span></code></pre></div><blockquote>
<p>docker container run imagename</p>
</blockquote>
<p>使用镜像创建容器并运行容器，如果本地没有镜像，则去远程拉取并创建运行</p>
<blockquote>
<p>docker container stop containerID/name</p>
</blockquote>
<p>停止容器运行</p>
<h3 id="docker镜像和容器">Docker镜像和容器</h3>
<h4 id="docker镜像">docker镜像</h4>
<p>docker是一个<code>read-only</code>文件</p>
<p>包含文件系统，源码，库函数，依赖和工具等application所需要的文件</p>
<p>可以理解为是一个模版</p>
<h4 id="docker容器-1">docker容器</h4>
<p>docker的容器可以理解为是docker镜像的一个运行态</p>
<p>实质是复制docker镜像并在镜像上层加了<code>read-write</code></p>
<p>一个镜像可以创建多个容器</p>
<h4 id="docker镜像的获取">docker镜像的获取</h4>
<ul>
<li>通过自己制作</li>
<li>拉取镜像（例如在docker hub）</li>
</ul>
<h3 id="创建容器">创建容器</h3>
<p>在docker创建容器，就是指把对应docker进行image运行起来，可以使用命令，该命令指，创建某一个容器并运行， 如果在本地没有找到对应镜像就回去远程拉取镜像，然后使用该镜像创建容器并运行：</p>
<pre tabindex="0"><code>docker container run imagename
</code></pre><p>例如我们创建一个Nginx容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container run nginx                                                                                                                                                                    15:24:39
</span></span><span style="display:flex;"><span>Unable to find image <span style="color:#e6db74">&#39;nginx:latest&#39;</span> locally
</span></span><span style="display:flex;"><span>latest: Pulling from library/nginx
</span></span><span style="display:flex;"><span>927a35006d93: Pull complete
</span></span><span style="display:flex;"><span>fc3910c70f9c: Pull complete
</span></span><span style="display:flex;"><span>e11bfbf9fd54: Pull complete
</span></span><span style="display:flex;"><span>fbb8b547daa2: Pull complete
</span></span><span style="display:flex;"><span>0f1992aeebd8: Pull complete
</span></span><span style="display:flex;"><span>f929dacee378: Pull complete
</span></span><span style="display:flex;"><span>Digest: sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31
</span></span><span style="display:flex;"><span>Status: Downloaded newer image <span style="color:#66d9ef">for</span> nginx:latest
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Looking <span style="color:#66d9ef">for</span> shell scripts in /docker-entrypoint.d/
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Configuration complete; ready <span style="color:#66d9ef">for</span> start up
</span></span></code></pre></div><p>当我们终端输入<code>docker container ls  </code>就可以看到，对应的容器。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container ls                                                                                                                                                                           15:29:10
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                    NAMES
</span></span><span style="display:flex;"><span>c814bb0656c2   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">3</span> minutes ago   Up <span style="color:#ae81ff">3</span> minutes   80/tcp                   modest_euler
</span></span><span style="display:flex;"><span>5a6f69f16a45   cedd18a74eff   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago      Up <span style="color:#ae81ff">9</span> days      6379/tcp                 angry_euler
</span></span><span style="display:flex;"><span>1e3b9cd32745   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">10</span> days ago     Up <span style="color:#ae81ff">4</span> days      0.0.0.0:6379-&gt;6379/tcp   competent_wilson
</span></span></code></pre></div><p>这里需要解释一些东西：</p>
<ul>
<li>
<p>CONTAINER ID</p>
<p>容器的id</p>
</li>
<li>
<p>IMAGE</p>
<p>创建容器使用的镜像</p>
</li>
<li>
<p>COMMAND</p>
<pre><code>  执行的命令
</code></pre>
</li>
<li>
<p>CREATED</p>
<pre><code>  创建时间
</code></pre>
</li>
<li>
<p>STATUS</p>
</li>
</ul>
<p>容器状态</p>
<ul>
<li>
<p>PORTS</p>
<p>运行端口</p>
</li>
<li>
<p>NAMES</p>
<p>名字是系统随机给我们当前容器的</p>
</li>
</ul>
<h3 id="批量操作容器">批量操作容器</h3>
<p>当有多个容器时，我们可以使用命令：</p>
<pre tabindex="0"><code>docker container rm id1 id2 id3 id4                                                 
</code></pre><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps -a                                                                                                                                                                                  15:55:07
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS                   PORTS                    NAMES
</span></span><span style="display:flex;"><span>46f2f834f206   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">6</span> minutes ago    Up <span style="color:#ae81ff">6</span> minutes             80/tcp                   hardcore_blackburn
</span></span><span style="display:flex;"><span>cbbdae41ada5   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">6</span> minutes ago    Up <span style="color:#ae81ff">6</span> minutes             80/tcp                   nifty_sammet
</span></span><span style="display:flex;"><span>eb028035b1f2   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">6</span> minutes ago    Up <span style="color:#ae81ff">6</span> minutes             80/tcp                   pensive_bohr
</span></span><span style="display:flex;"><span>c814bb0656c2   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">33</span> minutes ago   Up <span style="color:#ae81ff">33</span> minutes            80/tcp                   modest_euler
</span></span><span style="display:flex;"><span>b0a8203fc448   ubuntu:15.10   <span style="color:#e6db74">&#34;/bin/echo &#39;Hello wo…&#34;</span>   <span style="color:#ae81ff">9</span> days ago       Exited <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#ae81ff">9</span> days ago                             quirky_curie
</span></span><span style="display:flex;"><span>2529798509bc   d5ca7a445605   <span style="color:#e6db74">&#34;bash&#34;</span>                   <span style="color:#ae81ff">9</span> days ago       Exited <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#ae81ff">9</span> days ago                             gifted_johnson
</span></span><span style="display:flex;"><span>06eecc8dce25   ubuntu         <span style="color:#e6db74">&#34;bash&#34;</span>                   <span style="color:#ae81ff">9</span> days ago       Exited <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#ae81ff">9</span> days ago                             nifty_wing
</span></span><span style="display:flex;"><span>9232372963cb   d5ca7a445605   <span style="color:#e6db74">&#34;bash&#34;</span>                   <span style="color:#ae81ff">9</span> days ago       Exited <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#ae81ff">9</span> days ago                             dreamy_jones
</span></span><span style="display:flex;"><span>5a6f69f16a45   cedd18a74eff   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago       Up <span style="color:#ae81ff">9</span> days                6379/tcp                 angry_euler
</span></span><span style="display:flex;"><span>1e3b9cd32745   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">11</span> days ago      Up <span style="color:#ae81ff">4</span> days                0.0.0.0:6379-&gt;6379/tcp   competent_wilson
</span></span><span style="display:flex;"><span>22e1fbf2426c   alpine/git     <span style="color:#e6db74">&#34;git clone https://g…&#34;</span>   <span style="color:#ae81ff">11</span> days ago      Exited <span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> <span style="color:#ae81ff">11</span> days ago                            repo
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container rm b0a8203fc44 06eecc8dce25 9232372963cb 2529798509bc                                                                                                                        15:58:58
</span></span><span style="display:flex;"><span>b0a8203fc44
</span></span><span style="display:flex;"><span>06eecc8dce25
</span></span><span style="display:flex;"><span>9232372963cb
</span></span><span style="display:flex;"><span>2529798509bc
</span></span></code></pre></div><p>但是这样所还是不方便，接下来介绍另一种方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker ps -aq
</span></span></code></pre></div><p>进行批量操作，<code>docker ps -aq</code>返回所有容器id</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps -aq                                                                                                                                                                                 16:00:31
</span></span><span style="display:flex;"><span>46f2f834f206
</span></span><span style="display:flex;"><span>cbbdae41ada5
</span></span><span style="display:flex;"><span>eb028035b1f2
</span></span><span style="display:flex;"><span>c814bb0656c2
</span></span><span style="display:flex;"><span>5a6f69f16a45
</span></span><span style="display:flex;"><span>1e3b9cd32745
</span></span><span style="display:flex;"><span>22e1fbf2426c
</span></span></code></pre></div><p>比如我们要停止所有容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps                                                                                                                                                                                    16:02:11
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                    NAMES
</span></span><span style="display:flex;"><span>46f2f834f206   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">10</span> minutes ago   Up <span style="color:#ae81ff">10</span> minutes   80/tcp                   hardcore_blackburn
</span></span><span style="display:flex;"><span>cbbdae41ada5   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">10</span> minutes ago   Up <span style="color:#ae81ff">10</span> minutes   80/tcp                   nifty_sammet
</span></span><span style="display:flex;"><span>eb028035b1f2   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">10</span> minutes ago   Up <span style="color:#ae81ff">10</span> minutes   80/tcp                   pensive_bohr
</span></span><span style="display:flex;"><span>c814bb0656c2   nginx          <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">37</span> minutes ago   Up <span style="color:#ae81ff">37</span> minutes   80/tcp                   modest_euler
</span></span><span style="display:flex;"><span>5a6f69f16a45   cedd18a74eff   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago       Up <span style="color:#ae81ff">9</span> days       6379/tcp                 angry_euler
</span></span><span style="display:flex;"><span>1e3b9cd32745   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">11</span> days ago      Up <span style="color:#ae81ff">4</span> days       0.0.0.0:6379-&gt;6379/tcp   competent_wilson
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container stop <span style="color:#66d9ef">$(</span>docker ps -aq<span style="color:#66d9ef">)</span>                                                                                                                                                        16:02:58
</span></span><span style="display:flex;"><span>46f2f834f206
</span></span><span style="display:flex;"><span>cbbdae41ada5
</span></span><span style="display:flex;"><span>eb028035b1f2
</span></span><span style="display:flex;"><span>c814bb0656c2
</span></span><span style="display:flex;"><span>5a6f69f16a45
</span></span><span style="display:flex;"><span>1e3b9cd32745
</span></span><span style="display:flex;"><span>22e1fbf2426c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps                                                                                                                                                                                     16:03:35
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</span></span></code></pre></div><p>当然也可以将容器运行起来：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps -aq                                                                                                                                                                                 16:03:56
</span></span><span style="display:flex;"><span>46f2f834f206
</span></span><span style="display:flex;"><span>cbbdae41ada5
</span></span><span style="display:flex;"><span>eb028035b1f2
</span></span><span style="display:flex;"><span>c814bb0656c2
</span></span><span style="display:flex;"><span>5a6f69f16a45
</span></span><span style="display:flex;"><span>1e3b9cd32745
</span></span><span style="display:flex;"><span>22e1fbf2426c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container start <span style="color:#66d9ef">$(</span>docker ps -aq<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>46f2f834f206
</span></span><span style="display:flex;"><span>cbbdae41ada5
</span></span><span style="display:flex;"><span>eb028035b1f2
</span></span><span style="display:flex;"><span>c814bb0656c2
</span></span><span style="display:flex;"><span>5a6f69f16a45
</span></span><span style="display:flex;"><span>1e3b9cd32745
</span></span><span style="display:flex;"><span>22e1fbf2426c
</span></span></code></pre></div><h3 id="容器的attached和detached模式">容器的attached和detached模式</h3>
<h4 id="attached">attached</h4>
<p>attached模式就是指将容器在前台运行，窗口不能退出，假如我们使用命令<code>control+c</code>退出前台，那么对应的容器也就停止运行了</p>
<p>例如: 当我们这样运行容器后，日志都会输出在终端里</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container run -p 80:80 nginx     <span style="color:#75715e">#运行容器，将docker运行端口映射到宿主机器端口，我们可以在浏览器中127.0.0.1进行访问                                                                                                                                                 16:15:53</span>
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Looking <span style="color:#66d9ef">for</span> shell scripts in /docker-entrypoint.d/
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Configuration complete; ready <span style="color:#66d9ef">for</span> start up
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: using the <span style="color:#e6db74">&#34;epoll&#34;</span> event method
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: nginx/1.21.5
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: built by gcc 10.2.1 <span style="color:#ae81ff">20210110</span> <span style="color:#f92672">(</span>Debian 10.2.1-6<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: OS: Linux 5.15.49-linuxkit
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: getrlimit<span style="color:#f92672">(</span>RLIMIT_NOFILE<span style="color:#f92672">)</span>: 1048576:1048576
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker processes
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:16:28 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>172.17.0.1 - - <span style="color:#f92672">[</span>10/Apr/2023:08:16:45 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">615</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span>
</span></span><span style="display:flex;"><span>172.17.0.1 - - <span style="color:#f92672">[</span>10/Apr/2023:08:16:46 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /favicon.ico HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> <span style="color:#ae81ff">555</span> <span style="color:#e6db74">&#34;http://127.0.0.1/&#34;</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:16:46 <span style="color:#f92672">[</span>error<span style="color:#f92672">]</span> 32#32: *1 open<span style="color:#f92672">()</span> <span style="color:#e6db74">&#34;/usr/share/nginx/html/favicon.ico&#34;</span> failed <span style="color:#f92672">(</span>2: No such file or directory<span style="color:#f92672">)</span>, client: 172.17.0.1, server: localhost, request: <span style="color:#e6db74">&#34;GET /favicon.ico HTTP/1.1&#34;</span>, host: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, referrer: <span style="color:#e6db74">&#34;http://127.0.0.1/&#34;</span>
</span></span></code></pre></div><h4 id="detached">detached</h4>
<p>就是让容器在后台运行，不会占用终端，不会输出日志，当终端退出后，容器依然会运行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container run -d -p 80:80 nginx                                                                                                                                                        16:21:10
</span></span><span style="display:flex;"><span>d2dbfc20f9f0e79c53c1c96d1999e2af9a4eaeb58983956629649735c470497b
</span></span></code></pre></div><p>当然我们可以将detached转到attached</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container run -d -p 80:80 nginx                                                                                                                                                        16:21:10
</span></span><span style="display:flex;"><span>d2dbfc20f9f0e79c53c1c96d1999e2af9a4eaeb58983956629649735c470497b
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker attach d2d                                                                                                                                                                             16:21:28
</span></span><span style="display:flex;"><span>172.17.0.1 - - <span style="color:#f92672">[</span>10/Apr/2023:08:24:44 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">304</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span>
</span></span></code></pre></div><h3 id="容器的交互模式">容器的交互模式</h3>
<p>有时候需要进行容器的交互，例如调试，日志等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps  <span style="color:#75715e">#查看运行的容器                                                                                                                                                                                   16:30:21</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                NAMES
</span></span><span style="display:flex;"><span>23efdbab4810   nginx     <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">48</span> seconds ago   Up <span style="color:#ae81ff">47</span> seconds   0.0.0.0:80-&gt;80/tcp   admiring_bouman
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container logs 23e    <span style="color:#75715e">#查看容器日志                                                                                                                                                               16:30:28</span>
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Looking <span style="color:#66d9ef">for</span> shell scripts in /docker-entrypoint.d/
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Configuration complete; ready <span style="color:#66d9ef">for</span> start up
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: using the <span style="color:#e6db74">&#34;epoll&#34;</span> event method
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: nginx/1.21.5
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: built by gcc 10.2.1 <span style="color:#ae81ff">20210110</span> <span style="color:#f92672">(</span>Debian 10.2.1-6<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: OS: Linux 5.15.49-linuxkit
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: getrlimit<span style="color:#f92672">(</span>RLIMIT_NOFILE<span style="color:#f92672">)</span>: 1048576:1048576
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker processes
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container logs -f 23e  <span style="color:#75715e">#动态监控日志</span>
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Looking <span style="color:#66d9ef">for</span> shell scripts in /docker-entrypoint.d/
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
</span></span><span style="display:flex;"><span>/docker-entrypoint.sh: Configuration complete; ready <span style="color:#66d9ef">for</span> start up
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: using the <span style="color:#e6db74">&#34;epoll&#34;</span> event method
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: nginx/1.21.5
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: built by gcc 10.2.1 <span style="color:#ae81ff">20210110</span> <span style="color:#f92672">(</span>Debian 10.2.1-6<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: OS: Linux 5.15.49-linuxkit
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: getrlimit<span style="color:#f92672">(</span>RLIMIT_NOFILE<span style="color:#f92672">)</span>: 1048576:1048576
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker processes
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span>2023/04/10 08:29:40 <span style="color:#f92672">[</span>notice<span style="color:#f92672">]</span> 1#1: start worker process <span style="color:#ae81ff">34</span>
</span></span></code></pre></div><blockquote>
<p>docker container run -it imagename sh</p>
</blockquote>
<p>使用该命令当容器运行后，进入容器shell，注意：当我们退出后，整个容器就退出了</p>
<blockquote>
<p>docker exec -it id or name sh</p>
</blockquote>
<p>进入正在运行的容器shell</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker ps                                                                                                                                                                                     16:41:00
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                NAMES
</span></span><span style="display:flex;"><span>23efdbab4810   nginx     <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">11</span> minutes ago   Up <span style="color:#ae81ff">11</span> minutes   0.0.0.0:80-&gt;80/tcp   admiring_bouman
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker exec -it 23e sh                                                                                                                                                                        16:41:03
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>bin  boot  dev	docker-entrypoint.d  docker-entrypoint.sh  etc	home  lib  media  mnt  opt  proc  root	run  sbin  srv	sys  tmp  usr  var
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pwd</span>
</span></span><span style="display:flex;"><span>/
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span></code></pre></div><p>当使用<code>control+c</code>退出shell后，容器依然会运行</p>
<h3 id="容器和虚拟机">容器和虚拟机</h3>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/containers-vs-virtual-machines.jpg" alt=""></p>
<p>我们要知道容器不等于虚拟机</p>
<ul>
<li>
<p>容器其实是进程Containers are just processes</p>
</li>
<li>
<p>容器中的进程被限制了对CPU内存等资源的访问</p>
</li>
<li>
<p>当进程停止后，容器就退出了</p>
</li>
</ul>
<h3 id="docker-container-run-背后发生了什么">docker container run 背后发生了什么？</h3>
<p>前面介绍了容器的创建，只是简单是说明了一下run背后的工作，现在来详细介绍一下，以下面命令为例：</p>
<pre tabindex="0"><code>$ docker container run -d --publish 80:80 --name webhost nginx
</code></pre><ul>
<li>
<ol>
<li>在本地查找是否有nginx这个image镜像，但是没有发现</li>
</ol>
</li>
<li>
<ol>
<li>去远程的image registry查找nginx镜像（默认的registry是Docker Hub)</li>
</ol>
</li>
<li>
<ol>
<li>下载最新版本的nginx镜像 （nginx:latest 默认)</li>
</ol>
</li>
<li>
<ol>
<li>基于nginx镜像来创建一个新的容器，并且准备运行</li>
</ol>
</li>
<li>
<ol>
<li>docker engine分配给这个容器一个虚拟IP地址</li>
</ol>
</li>
<li>
<ol>
<li>在宿主机上打开80端口并把容器的80端口转发到宿主机上</li>
</ol>
</li>
<li>
<ol>
<li>启动容器，运行指定的命令（这里是一个shell脚本去启动nginx）</li>
</ol>
</li>
</ul>
<h2 id="docker镜像-1">docker镜像</h2>
<h3 id="镜像的获取">镜像的获取</h3>
<ul>
<li>通过registry去拉取
<ul>
<li>公有：比如docker hub别人都能拉取</li>
<li>私有：比如企业内部制作的镜像，需要企业自己搭建一个registry</li>
</ul>
</li>
<li>基于dockerfile自己构建</li>
<li>load from <code>file</code> (offline) 文件导入</li>
</ul>
<!-- raw HTML omitted -->
<h3 id="通过registry去拉取">通过registry去拉取</h3>
<h4 id="镜像拉取">镜像拉取</h4>
<blockquote>
<p>docker image pull imagename</p>
</blockquote>
<p>使用上面命令进行镜像的拉取。如果没有指定版本，则默然是最新版本：latest</p>
<p>我们的registry默认是使用docker hub， 如果我们需要某一个镜像，可以直接去<a href="https://hub.docker.com/">docker hub</a>查找，找到需要的版本，使用registry提供的命令直接拉取即可。</p>
<p>例如：我现在我找MongoDB的镜像，直接去docker hub搜索即可，找到需要的版本(这里我以最新版本）然后运行hub提供的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull mongo
</span></span></code></pre></div><p>假如我们要拉取指定版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull mongo:4.4.20-rc0
</span></span></code></pre></div><h4 id="镜像删除">镜像删除</h4>
<blockquote>
<p>docker image rm imageid</p>
</blockquote>
<p><strong>注意：当需要删除的镜像有运行容器，或者退出的容器状态，他都是不可以删除的，我们需要将使用的容器删除后，才可以删除对应的镜像。</strong></p>
<h3 id="镜像的导入导出">镜像的导入导出</h3>
<p>有的时候我们的其他设备没有网络但需要使用镜像或者是你只想把某一个镜像发给别人，可以使用进行的导入/导出。</p>
<h4 id="导出">导出</h4>
<blockquote>
<p>docker image save imagename:x.x.x -o outname.image</p>
</blockquote>
<p>假如现在要导出ubuntu:15.10</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker images                                                                                                                                                                                 17:58:55
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>redis        latest    cedd18a74eff   <span style="color:#ae81ff">2</span> weeks ago     111MB
</span></span><span style="display:flex;"><span>alpine/git   latest    9793ee61fc75   <span style="color:#ae81ff">4</span> months ago    43.4MB
</span></span><span style="display:flex;"><span>nginx        latest    eeb9db34b331   <span style="color:#ae81ff">15</span> months ago   134MB
</span></span><span style="display:flex;"><span>mongo        latest    b66a51a1f0e6   <span style="color:#ae81ff">16</span> months ago   657MB
</span></span><span style="display:flex;"><span>ubuntu       latest    d5ca7a445605   <span style="color:#ae81ff">18</span> months ago   65.6MB
</span></span><span style="display:flex;"><span>ubuntu       15.10     9b9cb95443b5   <span style="color:#ae81ff">6</span> years ago     137MB
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker image save ubuntu:15.10 -o ubuntu.image   <span style="color:#75715e">#导出镜像，保存在当前目录                                                                                                                                           17:58:58</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> ls                                                                                                                                                                                            18:00:52
</span></span><span style="display:flex;"><span>Desktop         Downloads       Library         Music           Postman         ubuntu.image
</span></span><span style="display:flex;"><span>Documents       GolandProjects
</span></span></code></pre></div><h4 id="导入">导入</h4>
<blockquote>
<p>docker image load -i ./your_filepath/name.image</p>
</blockquote>
<p>现在我们来导入Ubuntu:15.10</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker images   <span style="color:#75715e">#镜像列表                                                                                                                                                                          18:05:26</span>
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>redis        latest    cedd18a74eff   <span style="color:#ae81ff">2</span> weeks ago     111MB
</span></span><span style="display:flex;"><span>alpine/git   latest    9793ee61fc75   <span style="color:#ae81ff">4</span> months ago    43.4MB
</span></span><span style="display:flex;"><span>nginx        latest    eeb9db34b331   <span style="color:#ae81ff">15</span> months ago   134MB
</span></span><span style="display:flex;"><span>mongo        latest    b66a51a1f0e6   <span style="color:#ae81ff">16</span> months ago   657MB
</span></span><span style="display:flex;"><span>ubuntu       latest    d5ca7a445605   <span style="color:#ae81ff">18</span> months ago   65.6MB
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker image load -i ./ubuntu.image      <span style="color:#75715e">#导入镜像                                                                                                                                                   18:05:33</span>
</span></span><span style="display:flex;"><span>f121afdbbd5d: Loading layer <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>  142.9MB/142.9MB
</span></span><span style="display:flex;"><span>4b955941a4d0: Loading layer <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>  15.87kB/15.87kB
</span></span><span style="display:flex;"><span>af288f00b8a7: Loading layer <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>  11.78kB/11.78kB
</span></span><span style="display:flex;"><span>98d59071f692: Loading layer <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>  4.608kB/4.608kB
</span></span><span style="display:flex;"><span>Loaded image: ubuntu:15.10
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker images                                                                                                                                                                                 18:06:57
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>redis        latest    cedd18a74eff   <span style="color:#ae81ff">2</span> weeks ago     111MB
</span></span><span style="display:flex;"><span>alpine/git   latest    9793ee61fc75   <span style="color:#ae81ff">4</span> months ago    43.4MB
</span></span><span style="display:flex;"><span>nginx        latest    eeb9db34b331   <span style="color:#ae81ff">15</span> months ago   134MB
</span></span><span style="display:flex;"><span>mongo        latest    b66a51a1f0e6   <span style="color:#ae81ff">16</span> months ago   657MB
</span></span><span style="display:flex;"><span>ubuntu       latest    d5ca7a445605   <span style="color:#ae81ff">18</span> months ago   65.6MB
</span></span><span style="display:flex;"><span>ubuntu       15.10     9b9cb95443b5   <span style="color:#ae81ff">6</span> years ago     137MB   <span style="color:#75715e">#ubuntu:15.10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>
</span></span></code></pre></div><h3 id="dockerfile构建镜像">DockerFile构建镜像</h3>
<h4 id="镜像构建">镜像构建</h4>
<p>下面我们直接来使用dockerfile构建一个python容器</p>
<p>hellp_docker.py</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;hello, docker&#34;</span>)
</span></span></code></pre></div><p>DockerFile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive apt-get install --no-install-recommends -y python3.9 python3-pip python3.9-dev<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> hello_docker.py /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;python3&#34;</span>, <span style="color:#e6db74">&#34;/hello_docker.py&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>两个文件在同一命令下然后运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker image build -t hello:1.0 .
</span></span><span style="display:flex;"><span>Sending build context to Docker daemon  4.096kB
</span></span><span style="display:flex;"><span>Step 1/4 : FROM ubuntu:20.04
</span></span><span style="display:flex;"><span>20.04: Pulling from library/ubuntu
</span></span><span style="display:flex;"><span>7b1a6ab2e44d: Pull complete
</span></span><span style="display:flex;"><span>Digest: sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322
</span></span><span style="display:flex;"><span>Status: Downloaded newer image <span style="color:#66d9ef">for</span> ubuntu:20.04
</span></span><span style="display:flex;"><span> ---&gt; ba6acccedd29
</span></span><span style="display:flex;"><span>Step 2/4 : RUN apt-get update <span style="color:#f92672">&amp;&amp;</span>     DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive apt-get install --no-install-recommends -y python3.9 python3-pip python3.9-dev
</span></span><span style="display:flex;"><span> ---&gt; Running in fd6c73a00ee1
</span></span><span style="display:flex;"><span> ……
</span></span><span style="display:flex;"><span> ……
</span></span><span style="display:flex;"><span> ……
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 最后看到Successfully构建成功</span>
</span></span><span style="display:flex;"><span>Step 4/4 : CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;python3&#34;</span>, <span style="color:#e6db74">&#34;/hello_docker.py&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> ---&gt; Running in 33d73376ceb6
</span></span><span style="display:flex;"><span>Removing intermediate container 33d73376ceb6
</span></span><span style="display:flex;"><span> ---&gt; d1d214b5b189
</span></span><span style="display:flex;"><span>Successfully built d1d214b5b189
</span></span><span style="display:flex;"><span>Successfully tagged hello:1.0
</span></span></code></pre></div><p>查看镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>hello                           1.0       d1d214b5b189   <span style="color:#ae81ff">9</span> minutes ago   253MB
</span></span><span style="display:flex;"><span>redis                           latest    7614ae9453d1   <span style="color:#ae81ff">15</span> months ago   113MB
</span></span></code></pre></div><p>创建并运行容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker container run hello:1.0
</span></span><span style="display:flex;"><span>hello, docker
</span></span></code></pre></div><p>这样的一个简单镜像就构建完成了。</p>
<h4 id="镜像分享">镜像分享</h4>
<p>将镜像构建完成后，可能需要上传到docker hub，如果我们要上传镜像需要注意：镜像名要以<code>您的docker用户名/镜像名</code>为完整的镜像名称，才能上传成功。</p>
<p>所以需要重新构建镜像为：<code>iceymoss/hello:1.0</code>，这里的构建可以使用原来的镜像直接生成新的指定tag镜像，当然我们也可以直接删除之前的镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker image rm hello:1.0
</span></span><span style="display:flex;"><span>Untagged: hello:1.0
</span></span></code></pre></div><p>构建<code>iceymoss/hello:1.0</code>镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker image build -t iceymoss/hello:1.0 .
</span></span><span style="display:flex;"><span>Sending build context to Docker daemon  4.096kB
</span></span><span style="display:flex;"><span>Step 1/4 : FROM ubuntu:20.04
</span></span><span style="display:flex;"><span> ---&gt; ba6acccedd29
</span></span><span style="display:flex;"><span>Step 2/4 : RUN apt-get update <span style="color:#f92672">&amp;&amp;</span>     DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive apt-get install --no-install-recommends -y python3.9 python3-pip python3.9-dev
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 4a6342e5abda
</span></span><span style="display:flex;"><span>Step 3/4 : ADD hello_docker.py /
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 57b6fdef7e55
</span></span><span style="display:flex;"><span>Step 4/4 : CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;python3&#34;</span>, <span style="color:#e6db74">&#34;/hello_docker.py&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; d1d214b5b189
</span></span><span style="display:flex;"><span>Successfully built d1d214b5b189
</span></span><span style="display:flex;"><span>Successfully tagged iceymoss/hello:1.0
</span></span></code></pre></div><p>查看镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker images
</span></span><span style="display:flex;"><span>REPOSITORY                      TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>iceymoss/hello                  1.0       d1d214b5b189   <span style="color:#ae81ff">20</span> minutes ago   253MB
</span></span></code></pre></div><p>上传镜像：</p>
<ul>
<li>
<p>登录dockerhub</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker login   <span style="color:#75715e">#登录dockerhub</span>
</span></span><span style="display:flex;"><span>Login with your Docker ID to push and pull images from Docker Hub. If you don<span style="color:#960050;background-color:#1e0010">&#39;</span>t have a Docker ID, head over to https://hub.docker.com to create one.
</span></span><span style="display:flex;"><span>Username: iceymoss  <span style="color:#75715e"># 输入用户名</span>
</span></span><span style="display:flex;"><span>Password:						<span style="color:#75715e"># 输入密码</span>
</span></span><span style="display:flex;"><span>WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
</span></span><span style="display:flex;"><span>Configure a credential helper to remove this warning. See
</span></span><span style="display:flex;"><span>https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Login Succeeded  <span style="color:#75715e">#成功！</span>
</span></span></code></pre></div></li>
<li>
<p>上传镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker image push iceymoss/hello:1.0  <span style="color:#75715e">#上传镜像</span>
</span></span><span style="display:flex;"><span>The push refers to repository <span style="color:#f92672">[</span>docker.io/iceymoss/hello<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>17ebfe15a563: Pushed
</span></span><span style="display:flex;"><span>bd233375145e: Pushed
</span></span><span style="display:flex;"><span>9f54eef41275: Mounted from library/ubuntu
</span></span><span style="display:flex;"><span>1.0: digest: sha256:33e432cbe808e746eec1ef85658b40447b00a3f18299d556eb9e5a057d08e5d3 size: <span style="color:#ae81ff">948</span>
</span></span></code></pre></div><p>这样我们的镜像就成功的上传到<code>docker hub</code>我们的用户下面了,我们登录:</p>
<p>进行镜像搜索：<code>iceymoss/hello</code>就可以看到上传的镜像和对应的pull命令，我们可以将容器pull来验证。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull iceymoss/hello:1.0
</span></span></code></pre></div><p>然后创建容器并运行即可。</p>
</li>
</ul>
<h3 id="通过commit生成镜像">通过commit生成镜像</h3>
<p>比如我们想将我们pull的在此基础上进行修改，例如我们运行nginx镜像，然后进入容器shell，找到nginx端口首页<code>index.html</code>，将内容修改后，我们要将修改后的内容作为我们自己需要的镜像，使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker container commit 容器id iceymoss/nginx
</span></span></code></pre></div><p><code>iceymoss/nginx</code>根据自己需要进行命名即可。</p>
<h3 id="基于scratch构建镜像">基于scratch构建镜像</h3>
<p>scratch是docker提供的一个空镜像，他什么都没有，我们无法直接通过pull拉取他，但是他可以帮助我们构建我们自己的镜像，下面以一段golang程序来基于scratch构建镜像。</p>
<p>在同一目录下：</p>
<p>main.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello, iceymoss!&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;this is a container for docker!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们需要将main.go编译成可执行文件：</p>
<pre tabindex="0"><code>go build main.go
</code></pre><p>然后在同一目录下生成一个main的可执行文件</p>
<p>接着来编写Dockerfile文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> scratch </span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> main /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ul>
<li><code>FROM scratch</code> 表示镜像来源</li>
<li><code>ADD main /  </code>表示在当前命令下添加main可执行文件到镜像<code>/</code>目录下</li>
<li><code>CMD [&quot;/main&quot;]</code>执行命令</li>
</ul>
<p>然后使用镜像构建命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss&amp; docker image build -t iceymoss/hello_go:1.0 .   <span style="color:#75715e">#构建镜像</span>
</span></span><span style="display:flex;"><span>Sending build context to Docker daemon  1.819MB
</span></span><span style="display:flex;"><span>Step 1/3 : FROM scratch
</span></span><span style="display:flex;"><span> ---&gt;
</span></span><span style="display:flex;"><span>Step 2/3 : ADD main /
</span></span><span style="display:flex;"><span> ---&gt; 3a2d990df0f1
</span></span><span style="display:flex;"><span>Step 3/3 : CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/main&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> ---&gt; Running in 1f0882b7dfcd
</span></span><span style="display:flex;"><span>Removing intermediate container 1f0882b7dfcd
</span></span><span style="display:flex;"><span> ---&gt; 138f83cc9e92
</span></span><span style="display:flex;"><span>Successfully built 138f83cc9e92
</span></span><span style="display:flex;"><span>Successfully tagged iceymoss/hello_go:1.0
</span></span></code></pre></div><p>这里我们知道scratch本身是一个空镜像，他没有占学习空间，而对于<code>iceymoss/hello_go:1.0 </code>镜像的空间其实就是main可执行文件的大小。</p>
<h2 id="dockerfile指南">Dockerfile指南</h2>
<p>在上面的一部分内容我们只是简单介绍了一下镜像的构建过程，但是并没有真正的系统学习Dockerfile的语法和细节，这里我们将着重介绍Dockerfile的使用和镜像构建的细节。</p>
<h3 id="基础镜像的选择">基础镜像的选择</h3>
<p>我们在构建镜像时，是需要选择一个基础镜像进行构建的，这里我们需要有一些选择的原则和方法。</p>
<h4 id="基本原则">基本原则</h4>
<ul>
<li>官方镜像优于非官方镜像，如果没有官方镜像，那也尽量Dockerfile开源的</li>
<li>固定版本，而不是每次都使用latest</li>
<li>尽量选择体积小的镜像</li>
</ul>
<p>例如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:alpine3.17</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> main /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><code>golang:alpine3.17</code>有100.41 MB，但是<code>golang:latest</code>版本有301.78 MB</p>
<h3 id="run指令">RUN指令</h3>
<p>RUN指令主要是在构建镜像的时候去下进行一些软件安装，文件下载等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ apt-get update
</span></span><span style="display:flex;"><span>$ apt-get install wget
</span></span><span style="display:flex;"><span>$ wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz
</span></span><span style="display:flex;"><span>$ tar zxf ipinfo_2.0.1_linux_amd64.tar.gz
</span></span><span style="display:flex;"><span>$ mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo
</span></span><span style="display:flex;"><span>$ rm -rf ipinfo_2.0.1_linux_amd64.tar.gz
</span></span></code></pre></div><p>在Dockerfile构建镜像过程中，如果我们使用的<code>RUN</code>的次数越多，那么构建的镜像的层数就越多，造成的结果就是镜像体积大。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>ipinfo       latest    97bb429363fb   <span style="color:#ae81ff">4</span> minutes ago   138MB
</span></span><span style="display:flex;"><span>ubuntu       21.04     478aa0080b60   <span style="color:#ae81ff">4</span> days ago      74.1MB
</span></span><span style="display:flex;"><span>$ docker image history 97b
</span></span><span style="display:flex;"><span>IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
</span></span><span style="display:flex;"><span>97bb429363fb   <span style="color:#ae81ff">4</span> minutes ago   RUN /bin/sh -c rm -rf ipinfo_2.0.1_linux_amd…   0B        buildkit.dockerfile.v0
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> minutes ago   RUN /bin/sh -c mv ipinfo_2.0.1_linux_amd64 /…   9.36MB    buildkit.dockerfile.v0
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> minutes ago   RUN /bin/sh -c tar zxf ipinfo_2.0.1_linux_am…   9.36MB    buildkit.dockerfile.v0
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> minutes ago   RUN /bin/sh -c wget https://github.com/ipinf…   4.85MB    buildkit.dockerfile.v0
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> minutes ago   RUN /bin/sh -c apt-get install -y wget <span style="color:#75715e"># bui…   7.58MB    buildkit.dockerfile.v0</span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> minutes ago   RUN /bin/sh -c apt-get update <span style="color:#75715e"># buildkit        33MB      buildkit.dockerfile.v0</span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> days ago      /bin/sh -c <span style="color:#75715e">#(nop)  CMD [&#34;/bin/bash&#34;]            0B</span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> days ago      /bin/sh -c mkdir -p /run/systemd <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;do…   7B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;missing&gt;      4 days ago      /bin/sh -c [ -z &#34;$(apt-get indextargets)&#34; ]     0B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;missing&gt;      4 days ago      /bin/sh -c set -xe   &amp;&amp; echo &#39;</span><span style="color:#75715e">#!/bin/sh&#39; &gt; /…   811B</span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> days ago      /bin/sh -c <span style="color:#75715e">#(nop) ADD file:d6b6ba642344138dc…   74.1MB</span>
</span></span></code></pre></div><p>我们在构建镜像时，编写Dokerfile时，尽量少用<code>RUN</code>最好将所有命令放在一个<code>RUN</code>中执行</p>
<h4 id="改进版">改进版</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>FROM ubuntu:20.04
</span></span><span style="display:flex;"><span>RUN apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y wget <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>ipinfo-new   latest    fe551bc26b92   <span style="color:#ae81ff">5</span> seconds ago    124MB
</span></span><span style="display:flex;"><span>ipinfo       latest    97bb429363fb   <span style="color:#ae81ff">16</span> minutes ago   138MB
</span></span><span style="display:flex;"><span>ubuntu       21.04     478aa0080b60   <span style="color:#ae81ff">4</span> days ago       74.1MB
</span></span><span style="display:flex;"><span>$ docker image history fe5
</span></span><span style="display:flex;"><span>IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
</span></span><span style="display:flex;"><span>fe551bc26b92   <span style="color:#ae81ff">16</span> seconds ago   RUN /bin/sh -c apt-get update <span style="color:#f92672">&amp;&amp;</span>     apt-get…   49.9MB    buildkit.dockerfile.v0
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> days ago       /bin/sh -c <span style="color:#75715e">#(nop)  CMD [&#34;/bin/bash&#34;]            0B</span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> days ago       /bin/sh -c mkdir -p /run/systemd <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;do…   7B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;missing&gt;      4 days ago       /bin/sh -c [ -z &#34;$(apt-get indextargets)&#34; ]     0B
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;missing&gt;      4 days ago       /bin/sh -c set -xe   &amp;&amp; echo &#39;</span><span style="color:#75715e">#!/bin/sh&#39; &gt; /…   811B</span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ae81ff">4</span> days ago       /bin/sh -c <span style="color:#75715e">#(nop) ADD file:d6b6ba642344138dc…   74.1MB</span>
</span></span><span style="display:flex;"><span>$
</span></span></code></pre></div><h3 id="文件的复制和目录操作">文件的复制和目录操作</h3>
<p>向镜像里复制文件的方法有两种<code>COPY</code>和<code>ADD</code></p>
<h4 id="复制普通文件">复制普通文件</h4>
<p><code>COPY</code> 和 <code>ADD</code> 都可以把local的一个文件复制到镜像里，如果目标目录不存在，则会自动创建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-alpine3.13</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> hello.py /app/hello.py<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>比如我们将本地的hello.py文件复制到镜像的<code>/app</code>目录下，实际上/app这个目录不存在，但他会自动创建</p>
<p><strong>注意：复制的文件在本地的权限也会被复制到镜像中去</strong></p>
<h4 id="复制压缩文件">复制压缩文件</h4>
<p><code>ADD</code> 比 COPY高级一点的地方就是，如果复制的是一个gzip等压缩文件时，ADD会帮助我们自动去解压缩文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-alpine3.13</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> hello.tar.gz /app/<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>将<code>hello.tar.gz</code>复制到镜像/app/下并解压</p>
<h4 id="使用原则">使用原则</h4>
<p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p>
<h4 id="目录操作">目录操作</h4>
<p>目录操作使用<code>WORKDIR</code>进行命令切换，如果没有给定的目录docker则会在镜像里面进行创建该目录， 使用该命令，镜像也会变得多一层，但是不会占用空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:alpine3.17</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /App/</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> main .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>添加到当前/App/目录下</p>
<h3 id="构建参数和环境变量">构建参数和环境变量</h3>
<p>我们先来看一下环境变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y wget <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>我们可以看到有<code>RUN</code>中有很多版本好，如果要进行镜像升级的时候，岂不是每次都要进行修改，这很麻烦的。</p>
<p>所以我们需要环境变量</p>
<h4 id="env">ENV</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> VERSION<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>.0.1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y wget <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>/ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    tar zxf ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64 /usr/bin/ipinfo <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64.tar.gz<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="arg">ARG</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> VERSION<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>.0.1<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y wget <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>/ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    tar zxf ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64.tar.gz <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mv ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64 /usr/bin/ipinfo <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    rm -rf ipinfo_<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span>_linux_amd64.tar.gz<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><code>ARG</code> 和 <code>ENV</code> 是经常容易被混淆的两个Dockerfile的语法，都可以用来设置一个“变量”。 但实际上两者有很多的不同。</p>
<h4 id="区别">区别</h4>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/docker_environment_build_args.png" alt=""></p>
<p>ARG 可以在镜像build的时候动态修改value, 通过 <code>--build-arg</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -f ./Dockerfile-arg -t ipinfo-arg-2.0.0 --build-arg VERSION<span style="color:#f92672">=</span>2.0.0 .   <span style="color:#75715e">#原版本为2.0.1</span>
</span></span><span style="display:flex;"><span>$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY         TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>ipinfo-arg-2.0.0   latest    0d9c964947e2   <span style="color:#ae81ff">6</span> seconds ago    124MB
</span></span><span style="display:flex;"><span>$ docker container run -it ipinfo-arg-2.0.0
</span></span><span style="display:flex;"><span>root@b64285579756:/#
</span></span><span style="display:flex;"><span>root@b64285579756:/# ipinfo version
</span></span><span style="display:flex;"><span>2.0.0
</span></span><span style="display:flex;"><span>root@b64285579756:/#
</span></span></code></pre></div><p>ENV 设置的变量可以在Image中保持，并在容器中的环境变量里</p>
<h3 id="容器启动命令cmd">容器启动命令CMD</h3>
<p><code>CMD</code>可以用来设置容器启动时默认会执行的命令</p>
<ul>
<li>容器启动时默认执行的命令</li>
<li>如果docker container run启动容器时指定了其它命令，则CMD命令会被忽略</li>
<li>如果定义了多个CMD，只有最后一个会被执行。(Dockerfile文件中)</li>
</ul>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> scratch </span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> main /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>构建镜像:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -t iceymoss/hello_go:1.0 .   <span style="color:#75715e">#构建镜像</span>
</span></span></code></pre></div><p>创建容器时：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container run iceymoss/hello_go:1.0
</span></span></code></pre></div><p>docker就会去的镜像shell中执行<code>/main</code></p>
<h5 id="清除退出的命令">清除退出的命令</h5>
<blockquote>
<p>docker system prune -f</p>
</blockquote>
<h5 id="清除没有使用的镜像">清除没有使用的镜像</h5>
<blockquote>
<p>docker image prune -a</p>
</blockquote>
<h3 id="容器启动命令-entrypoint">容器启动命令 ENTRYPOINT</h3>
<p>NTRYPOINT 也可以设置容器启动时要执行的命令，但是和CMD是有区别的。</p>
<ul>
<li><code>CMD</code> 设置的命令，可以在docker container run 时传入其它命令，覆盖掉 <code>CMD</code> 的命令，但是 <code>ENTRYPOINT</code> 所设置的命令是一定会被执行的。</li>
<li><code>ENTRYPOINT</code> 和 <code>CMD</code> 可以联合使用，<code>ENTRYPOINT</code> 设置执行的命令，CMD传递参数</li>
</ul>
<p>实例：</p>
<p>构建三个镜像</p>
<p>Dockerfile-cmd:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;echo&#34;</span>,<span style="color:#e6db74">&#34;hello,docker&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Dockerfile-ent:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;echo&#34;</span>,<span style="color:#e6db74">&#34;hello,docker&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [ <span style="color:#e6db74">&#34;echo&#34;</span> ]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> []<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>将他们分别构建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -f ./Dockerfile-cmd -t dome-cmd .
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -f ./Dockerfile-ent -t dome-ent .
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -f ./Dockerfile -t dome-both .  
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker images                                                                                                    
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>dome-cmd     latest    f6dc13ce942a   <span style="color:#ae81ff">18</span> months ago    65.6MB
</span></span><span style="display:flex;"><span>dome-ent     latest    f6dc13ce942a   <span style="color:#ae81ff">18</span> months ago    65.6MB
</span></span><span style="display:flex;"><span>dome-both    latest    b5cb092c67ea   <span style="color:#ae81ff">18</span> months ago    65.6MB
</span></span></code></pre></div><p>他们的大小都是一样的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container run dome-cmd echo <span style="color:#e6db74">&#34;hi,iceymoss&#34;</span>                                                              
</span></span><span style="display:flex;"><span>hi,iceymoss   <span style="color:#75715e">#原内容被覆盖了</span>
</span></span><span style="display:flex;"><span>$ docker container run demo-ent echo <span style="color:#e6db74">&#34;hi,iceymoss&#34;</span>                                                               
</span></span><span style="display:flex;"><span>hello,docker echo hi,iceymoss    <span style="color:#75715e">#打印原内容，因为容器一定会执行ENTRYPOINT的命令，所以我们运行容器时写入的命令也会被当做参数传入给ENTRYPOINT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker container run dome-both                                                                           
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">#没有输入任何参数，为空</span>
</span></span><span style="display:flex;"><span>$ docker container run dome-both <span style="color:#e6db74">&#34;吃了吗?&#34;</span>    
</span></span><span style="display:flex;"><span>吃了吗?   
</span></span></code></pre></div><h4 id="shell格式">Shell格式</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">CMD</span> echo <span style="color:#e6db74">&#34;hello docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">ENTRYPOINT</span> echo <span style="color:#e6db74">&#34;hello docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="exec格式">Exec格式</h4>
<p>以可执行命令的方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;echo&#34;</span>, <span style="color:#e6db74">&#34;hello docker&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;echo&#34;</span>, <span style="color:#e6db74">&#34;hello docker&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>注意shell脚本的问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> NAME<span style="color:#f92672">=</span>docker
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CMD</span> echo <span style="color:#e6db74">&#34;hello </span>$NAME<span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>假如我们要把上面的CMD改成Exec格式，下面这样改是不行的, 大家可以试试。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> NAME<span style="color:#f92672">=</span>docker
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;echo&#34;</span>, <span style="color:#e6db74">&#34;hello $NAME&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>它会打印出 <code>hello $NAME</code> , 而不是 <code>hello docker</code> ,那么需要怎么写呢？ 我们需要以shell脚本的方式去执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> NAME<span style="color:#f92672">=</span>docker
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo hello $NAME&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="构建一个python服务">构建一个python服务</h4>
<p>Python 程序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_world</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Hello, World!&#39;</span>
</span></span></code></pre></div><p>Dockerfile</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">python</span>:<span style="color:#ae81ff">3.9.5</span><span style="color:#f92672">-</span><span style="color:#a6e22e">slim</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">COPY</span> <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">py</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RUN</span> <span style="color:#a6e22e">pip</span> <span style="color:#a6e22e">install</span> <span style="color:#a6e22e">flask</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WORKDIR</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">src</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENV</span> <span style="color:#a6e22e">FLASK_APP</span>=<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXPOSE</span> <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>]
</span></span></code></pre></div><p>构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -t flask-demo .
</span></span></code></pre></div><p>运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d -p 5000:5000 flask-demo
</span></span></code></pre></div><h4 id="构建一个goweb服务">构建一个goweb服务</h4>
<p>由于我对go比较熟，所以使用go也来构建一个镜像吧</p>
<p>在此之前你应该需要安装gin框架</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go get -u github.com/gin-gonic/gin
</span></span></code></pre></div><p>main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// handle方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Pong</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;name&#34;</span>:   <span style="color:#e6db74">&#34;ice_moss&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;age&#34;</span>:    <span style="color:#ae81ff">18</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;school&#34;</span>: <span style="color:#e6db74">&#34;家里蹲大学&#34;</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化一个gin的server对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//Default实例化对象具有日志和返回状态功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//注册路由，并编写处理方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/ping&#34;</span>, <span style="color:#a6e22e">Pong</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//监听端口：默认端口listen and serve on 0.0.0.0:8080
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:8083&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后直接编译成可执行文件(当然我们可以将源码复制到基础镜像中再编译也可以)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go build main main.go
</span></span></code></pre></div><p>然后来编写Dockerfile文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> main /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8083</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>然后构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image build -t gin-gemo:1.0 .
</span></span></code></pre></div><p>最后如将端口映射到宿主机器端口上：8083</p>
<pre tabindex="0"><code>docker run -d -p 8083:8083 gin-demo:1.0
</code></pre><p>直接访问：127.0.0.1:8083</p>
<p>但是这里要注意：我实在Linux服务器演示的，如果您的是M1的mac就会出现CPU架构不兼容问题，你需要找到对应架构的基础镜像。</p>
<h3 id="dockerfile-技巧合理使用-dockerignore">Dockerfile 技巧——合理使用 .dockerignore</h3>
<p>Docker是client-server架构，理论上Client和Server可以不在一台机器上。</p>
<p>在构建docker镜像的时候，需要把所需要的文件由CLI（client）发给Server，这些文件实际上就是build context</p>
<p>举例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ dockerfile-demo more Dockerfile
</span></span><span style="display:flex;"><span>FROM python:3.9.5-slim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>RUN pip install flask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WORKDIR /src
</span></span><span style="display:flex;"><span>ENV FLASK_APP<span style="color:#f92672">=</span>app.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COPY app.py /src/app.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>$ dockerfile-demo more app.py
</span></span><span style="display:flex;"><span>from flask import Flask
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask<span style="color:#f92672">(</span>__name__<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@app.route<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>def hello_world<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Hello, world!&#39;</span>
</span></span></code></pre></div><p>构建的时候，第一行输出就是发送build context。11.13MB （这里是Linux环境下的log）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -t demo .
</span></span><span style="display:flex;"><span>Sending build context to Docker daemon  11.13MB
</span></span><span style="display:flex;"><span>Step 1/7 : FROM python:3.9.5-slim
</span></span><span style="display:flex;"><span> ---&gt; 609da079b03a
</span></span><span style="display:flex;"><span>Step 2/7 : RUN pip install flask
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 955ce495635e
</span></span><span style="display:flex;"><span>Step 3/7 : WORKDIR /src
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 1c2f968e9f9b
</span></span><span style="display:flex;"><span>Step 4/7 : ENV FLASK_APP<span style="color:#f92672">=</span>app.py
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; dceb15b338cf
</span></span><span style="display:flex;"><span>Step 5/7 : COPY app.py /src/app.py
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 0d4dfef28b5f
</span></span><span style="display:flex;"><span>Step 6/7 : EXPOSE <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 203e9865f0d9
</span></span><span style="display:flex;"><span>Step 7/7 : CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 35b5efae1293
</span></span><span style="display:flex;"><span>Successfully built 35b5efae1293
</span></span><span style="display:flex;"><span>Successfully tagged demo:latest
</span></span></code></pre></div><h3 id="dockerignore-文件">.dockerignore 文件</h3>
<p>相信使用git的同学都知道，.gitignore 文件， 我们使用他对应的语法，可以指定哪些文件进行上传，哪些文件涉及隐私，不需要生上传等。</p>
<p>目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker_go$ ls
</span></span><span style="display:flex;"><span>Dockerfile  go.mod  go.sum  main  main.go
</span></span><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker_go$
</span></span></code></pre></div><p>编写一个.dockerignore文件：</p>
<pre tabindex="0"><code>/go.mod
/go.sum
/main.go
</code></pre><p>下面再进行构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker_go$ docker image build -t gin-demo:1.1 .
</span></span><span style="display:flex;"><span>Sending build context to Docker daemon   10.5MB    <span style="color:#75715e">#文件大小就变小了，镜像的构建会更快</span>
</span></span><span style="display:flex;"><span>Step 1/4 : FROM ubuntu:latest
</span></span><span style="display:flex;"><span> ---&gt; ba6acccedd29
</span></span><span style="display:flex;"><span>Step 2/4 : COPY main /
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; d236d1c477d1
</span></span><span style="display:flex;"><span>Step 3/4 : EXPOSE <span style="color:#ae81ff">8083</span>
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; a1d844c6e4ca
</span></span><span style="display:flex;"><span>Step 4/4 : CMD <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;/main&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; f002e06a38b9
</span></span><span style="display:flex;"><span>Successfully built f002e06a38b9
</span></span><span style="display:flex;"><span>Successfully tagged gin-demo:1.1
</span></span><span style="display:flex;"><span>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker_go#
</span></span></code></pre></div><h3 id="多阶段构建">多阶段构建</h3>
<p>当我们本地没有对应编程语言的开发环境，但是有需要使用运行我们写出来程序，或者是本地CPU架构不一致，我们不能直接在本地直接编译成可执行文件去构建镜像，那么我们可以在基础镜像中去配置对应程序的编译和运行环境然后再将源码在镜像中镜像编译，最后运行容器即可。</p>
<p>例外我现在本地没有go的开发环境，然后我们来构建一个go的web服务的镜像。</p>
<p>main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// handle方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Pong</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;name&#34;</span>:   <span style="color:#e6db74">&#34;ice_moss&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;age&#34;</span>:    <span style="color:#ae81ff">18</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;school&#34;</span>: <span style="color:#e6db74">&#34;家里蹲大学&#34;</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化一个gin的server对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//Default实例化对象具有日志和返回状态功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//注册路由，并编写处理方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/ping&#34;</span>, <span style="color:#a6e22e">Pong</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//监听端口：默认端口listen and serve on 0.0.0.0:8080
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:8083&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:alpine3.17</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> main.go /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> go.mod /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> go.sum /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go mod download <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go build main.go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8083</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/src/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>然后构建：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image build -t gin-demo:1.0 .
</span></span></code></pre></div><p>构建成功后：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>web<span style="color:#f92672">]</span> docker images                                                                                           
</span></span><span style="display:flex;"><span>REPOSITORY        TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>gin-demo          1.0       0addd4b55b80   <span style="color:#ae81ff">4</span> minutes ago    519MB    <span style="color:#75715e">#一个简单的web应用居然这么大！我不能接受</span>
</span></span><span style="display:flex;"><span>alpine/git        latest    9793ee61fc75   <span style="color:#ae81ff">4</span> months ago     43.4MB
</span></span><span style="display:flex;"><span>nginx             latest    eeb9db34b331   <span style="color:#ae81ff">15</span> months ago    134MB
</span></span><span style="display:flex;"><span>ubuntu            latest    d5ca7a445605   <span style="color:#ae81ff">18</span> months ago    65.6MB
</span></span></code></pre></div><p>原因是基础镜像golang:alpine3.17太大了</p>
<p>我们可以创建容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker container run -d -p 8083:8083 gin-demo:1.0
</span></span></code></pre></div><h4 id="多阶段构建-1">多阶段构建</h4>
<p>我们可以先将man.go在golang:alpine3.17编译成可执行文件，然后再将可执行文件放入ubuntu:latest镜像中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:alpine3.17 AS builder</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> main.go /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> go.mod /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> go.sum /src/   <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go mod download <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go build main.go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>builder /src/main /src/main<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8083</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/src/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>然后构建：</p>
<pre tabindex="0"><code>docker image build -t gin-demo:2.0 .
</code></pre><p>可以看到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>web<span style="color:#f92672">]</span> docker images                                                                                                                                                                                                                 21:42:53
</span></span><span style="display:flex;"><span>REPOSITORY        TAG       IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>gin-demo          2.0       c49a0acbcf4c   <span style="color:#ae81ff">2</span> minutes ago    75.7MB  <span style="color:#75715e">#可以看到2.0变得很小了</span>
</span></span><span style="display:flex;"><span>gin-demo          1.0       0addd4b55b80   <span style="color:#ae81ff">19</span> minutes ago   519MB
</span></span><span style="display:flex;"><span>ubuntu            latest    d5ca7a445605   <span style="color:#ae81ff">18</span> months ago    65.6MB
</span></span></code></pre></div><p>这样我的的web应用就得到了瘦身，总体上效果还可以的，这就是多阶段构建。</p>
<h3 id="尽量使用非root用户">尽量使用非root用户</h3>
<blockquote>
<p>这里在操作需要在Linux系统下</p>
</blockquote>
<h4 id="root的危险性">Root的危险性</h4>
<p>docker的root权限一直是其遭受诟病的地方，docker的root权限有那么危险么？我们举个例子。</p>
<p>假如我们有一个用户，叫demo，它本身不具有sudo的权限，所以就有很多文件无法进行读写操作，比如/root目录它是无法查看的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$ sudo ls /root
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> demo:
</span></span><span style="display:flex;"><span>demo is not in the sudoers file.  This incident will be reported.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$
</span></span></code></pre></div><p>但是这个用户有执行docker的权限，也就是它在docker这个group里。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$ groups
</span></span><span style="display:flex;"><span>demo docker
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY   TAG       IMAGE ID       CREATED      SIZE
</span></span><span style="display:flex;"><span>busybox      latest    a9d583973f65   <span style="color:#ae81ff">2</span> days ago   1.23MB
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$
</span></span></code></pre></div><p>这时，我们就可以通过Docker做很多越权的事情了，比如，我们可以把这个无法查看的/root目录映射到docker container里，你就可以自由进行查看了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host vagrant<span style="color:#f92672">]</span>$ docker run -it -v /root/:/root/tmp busybox sh
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># cd /root/tmp</span>
</span></span><span style="display:flex;"><span>~/tmp <span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>anaconda-ks.cfg  original-ks.cfg
</span></span><span style="display:flex;"><span>~/tmp <span style="color:#75715e"># ls -l</span>
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>-rw-------    <span style="color:#ae81ff">1</span> root     root          <span style="color:#ae81ff">5570</span> Apr <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">2020</span> anaconda-ks.cfg
</span></span><span style="display:flex;"><span>-rw-------    <span style="color:#ae81ff">1</span> root     root          <span style="color:#ae81ff">5300</span> Apr <span style="color:#ae81ff">30</span>  <span style="color:#ae81ff">2020</span> original-ks.cfg
</span></span><span style="display:flex;"><span>~/tmp <span style="color:#75715e">#</span>
</span></span></code></pre></div><p>更甚至我们可以给我们自己加sudo权限。我们现在没有sudo权限</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$ sudo vim /etc/sudoers
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> demo:
</span></span><span style="display:flex;"><span>demo is not in the sudoers file.  This incident will be reported.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$
</span></span></code></pre></div><p>但是我可以给自己添加。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$ docker run -it -v /etc/sudoers:/root/sudoers busybox sh
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># echo &#34;demo    ALL=(ALL)       ALL&#34; &gt;&gt; /root/sudoers</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># more /root/sudoers | grep demo</span>
</span></span><span style="display:flex;"><span>demo    ALL<span style="color:#f92672">=(</span>ALL<span style="color:#f92672">)</span>       ALL
</span></span></code></pre></div><p>然后退出container，bingo，我们有sudo权限了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$ sudo more /etc/sudoers | grep demo
</span></span><span style="display:flex;"><span>demo    ALL<span style="color:#f92672">=(</span>ALL<span style="color:#f92672">)</span>       ALL
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>demo@docker-host ~<span style="color:#f92672">]</span>$
</span></span></code></pre></div><h4 id="如何使用非root用户">如何使用非root用户</h4>
<p>我们准备两个Dockerfile，第一个Dockerfile如下，其中app.py文件源码请参考 <a href="https://dockertips.readthedocs.io/en/latest/dockerfile-guide/python-flask.html#python-flask">一起构建一个 Python Flask 镜像</a> ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install flask<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> app.py /src/app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLASK_APP<span style="color:#f92672">=</span>app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>假设构建的镜像名字为 <code>flask-demo</code></p>
<p>第二个Dockerfile，使用非root用户来构建这个镜像，名字叫 <code>flask-no-root</code> Dockerfile如下：</p>
<ul>
<li>通过groupadd和useradd创建一个flask的组和用户</li>
<li>通过USER指定后面的命令要以flask这个用户的身份运行</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install flask <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    groupadd -r flask <span style="color:#f92672">&amp;&amp;</span> useradd -r -g flask flask <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir /src <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    chown -R flask:flask /src<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> flask</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> app.py /src/app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLASK_APP<span style="color:#f92672">=</span>app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY      TAG          IMAGE ID       CREATED          SIZE
</span></span><span style="display:flex;"><span>flask-no-root   latest       80996843356e   <span style="color:#ae81ff">41</span> minutes ago   126MB
</span></span><span style="display:flex;"><span>flask-demo      latest       2696c68b51ce   <span style="color:#ae81ff">49</span> minutes ago   125MB
</span></span><span style="display:flex;"><span>python          3.9.5-slim   609da079b03a   <span style="color:#ae81ff">2</span> weeks ago      115MB
</span></span></code></pre></div><p>分别使用这两个镜像创建两个容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d --name flask-root flask-demo
</span></span><span style="display:flex;"><span>b31588bae216951e7981ce14290d74d377eef477f71e1506b17ee505d7994774
</span></span><span style="display:flex;"><span>$ docker run -d --name flask-no-root flask-no-root
</span></span><span style="display:flex;"><span>83aaa4a116608ec98afff2a142392119b7efe53617db213e8c7276ab0ae0aaa0
</span></span><span style="display:flex;"><span>$ docker container ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS      NAMES
</span></span><span style="display:flex;"><span>83aaa4a11660   flask-no-root   <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">4</span> seconds ago    Up <span style="color:#ae81ff">3</span> seconds    5000/tcp   flask-no-root
</span></span><span style="display:flex;"><span>b31588bae216   flask-demo      <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">16</span> seconds ago   Up <span style="color:#ae81ff">15</span> seconds   5000/tcp   flask-root
</span></span></code></pre></div><h3 id="导航">导航</h3>
<p><a href="https://docs.docker.com/reference/">Dockerfile</a></p>
<p><a href="https://github.com/docker-library/official-images">github/docker</a></p>
<h2 id="docker的存储">docker的存储</h2>
<p>我们知道运行的容器时，是在image加上一层<code>read-write</code>层，我们所需要的数据也会存储在该层里面，但是这些数据随着容器的删除而删除了，例如数据库容器等，这些数据一定不能随着容器的删除而删除，这是非常危险的，所以必须要对docker容器数据进行持久化。</p>
<p>默认情况下，在运行中的容器里创建的文件，被保存在一个可写的容器层：</p>
<ul>
<li>如果容器被删除了，则数据也没有了</li>
<li>这个可写的容器层是和特定的容器绑定的，也就是这些数据无法方便的和其它容器共享</li>
</ul>
<p>Docker主要提供了两种方式做数据的持久化</p>
<ul>
<li>Data Volume, 由Docker管理，(/var/lib/docker/volumes/ Linux), 持久化数据的最好方式</li>
<li>Bind Mount，由用户指定存储的数据具体mount在系统什么位置</li>
</ul>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/types-of-mounts.png" alt=""></p>
<h3 id="持久化之data-volume">持久化之data-volume</h3>
<h4 id="volume的使用">VOLUME的使用</h4>
<p>Dockerfile：构建一个计划任务的镜像，定时向容器中<code>/app/my-cron</code>写入时间数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk update<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk --no-cache add curl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> SUPERCRONIC_URL<span style="color:#f92672">=</span>https://github.com/aptible/supercronic/releases/download/v0.1.12/supercronic-linux-amd64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    SUPERCRONIC<span style="color:#f92672">=</span>supercronic-linux-amd64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    SUPERCRONIC_SHA1SUM<span style="color:#f92672">=</span>048b95b48b708983effb2e5c935a1ef8483d9e3e<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> curl -fsSLO <span style="color:#e6db74">&#34;</span>$SUPERCRONIC_URL<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SUPERCRONIC_SHA1SUM<span style="color:#e6db74">}</span><span style="color:#e6db74">  </span><span style="color:#e6db74">${</span>SUPERCRONIC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | sha1sum -c - <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> chmod +x <span style="color:#e6db74">&#34;</span>$SUPERCRONIC<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> mv <span style="color:#e6db74">&#34;</span>$SUPERCRONIC<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;/usr/local/bin/</span><span style="color:#e6db74">${</span>SUPERCRONIC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> ln -s <span style="color:#e6db74">&#34;/usr/local/bin/</span><span style="color:#e6db74">${</span>SUPERCRONIC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> /usr/local/bin/supercronic<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> my-cron /app/my-cron<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">VOLUME</span> [<span style="color:#e6db74">&#34;/app&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># RUN cron job</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/usr/local/bin/supercronic&#34;</span>, <span style="color:#e6db74">&#34;/app/my-cron&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><strong>注意：<code>VOLUME [&quot;/app&quot;]</code>他会将容器里面的<code>/app</code>目录的所有内容持久化到宿主机磁盘</strong></p>
<h4 id="构建镜像">构建镜像</h4>
<pre tabindex="0"><code>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker-demo/ch01# ls
Dockerfile  my-cron
root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker-demo/ch01# docker image build -t my-cron .
</code></pre><h4 id="创建容器-不指定参数v">创建容器-不指定参数v</h4>
<p>这里我们要了解两个命令：</p>
<blockquote>
<p>docker volume ls    #展示docker本地持久化文件</p>
</blockquote>
<blockquote>
<p>docker volume inspect filename  #获取对应docker本地文件相关信息</p>
</blockquote>
<p>此时Docker会自动创建一个随机名字的volume，去存储我们在Dockerfile定义的volume <code>VOLUME[&quot;/app&quot;]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d my-cron   <span style="color:#75715e">#运行容器</span>
</span></span><span style="display:flex;"><span>9a8fa93f03c42427a498b21ac520660752122e20bcdbf939661646f71d277f8f
</span></span><span style="display:flex;"><span>$ docker volume ls    <span style="color:#75715e">#获取持久化的本地文件</span>
</span></span><span style="display:flex;"><span>DRIVER    VOLUME NAME
</span></span><span style="display:flex;"><span>local     4ffa38075aa01b717256f53275ed5a2860e4c4f8df61e0a312628e59b8a90ed3
</span></span><span style="display:flex;"><span>$ docker inspect 4ffa38075aa01b717256f53275ed5a2860e4c4f8df61e0a312628e59b8a90ed3   <span style="color:#75715e">#获取持久化信息</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2023-04-15T16:30:38+08:00&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Mountpoint&#34;</span>: <span style="color:#e6db74">&#34;/var/lib/docker/volumes/4ffa38075aa01b717256f53275ed5a2860e4c4f8df61e0a312628e59b8a90ed3/_data&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;4ffa38075aa01b717256f53275ed5a2860e4c4f8df61e0a312628e59b8a90ed3&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>输出的这个Volume的mountpoint可以发现容器创建的文件</p>
<h4 id="创建容器-指定参数v">创建容器-指定参数v</h4>
<p>在创建容器的时候通过 <code>-v</code> 参数我们可以手动的指定需要创建Volume的名字，以及对应于容器内的路径，这个路径是可以任意的，不必需要在Dockerfile里通过VOLUME定义</p>
<p>比如我们把上面的Dockerfile里的VOLUME删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk update<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk --no-cache add curl<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> SUPERCRONIC_URL<span style="color:#f92672">=</span>https://github.com/aptible/supercronic/releases/download/v0.1.12/supercronic-linux-amd64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    SUPERCRONIC<span style="color:#f92672">=</span>supercronic-linux-amd64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    SUPERCRONIC_SHA1SUM<span style="color:#f92672">=</span>048b95b48b708983effb2e5c935a1ef8483d9e3e<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> curl -fsSLO <span style="color:#e6db74">&#34;</span>$SUPERCRONIC_URL<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SUPERCRONIC_SHA1SUM<span style="color:#e6db74">}</span><span style="color:#e6db74">  </span><span style="color:#e6db74">${</span>SUPERCRONIC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | sha1sum -c - <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> chmod +x <span style="color:#e6db74">&#34;</span>$SUPERCRONIC<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> mv <span style="color:#e6db74">&#34;</span>$SUPERCRONIC<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;/usr/local/bin/</span><span style="color:#e6db74">${</span>SUPERCRONIC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> ln -s <span style="color:#e6db74">&#34;/usr/local/bin/</span><span style="color:#e6db74">${</span>SUPERCRONIC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> /usr/local/bin/supercronic<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> my-cron /app/my-cron<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># RUN cron job</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/usr/local/bin/supercronic&#34;</span>, <span style="color:#e6db74">&#34;/app/my-cron&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>然后从新构建容器：</p>
<pre tabindex="0"><code>root@VM-0-6-ubuntu:/home/ubuntu/iceymoss/docker-demo/ch01# docker image build -t my-cron .
</code></pre><p>重新build镜像，然后创建容器，加-v参数</p>
<blockquote>
<p>docker container run -d -v 持久化到本地文件名称:需要进行持久化的命令或者文件</p>
</blockquote>
<p>例如：</p>
<blockquote>
<p>docker container run -d -v cron-data:/app my-cron</p>
</blockquote>
<p>如果我们的容器不小心被删除了，我们之前的持久化文件还在，我们新建容器只需要使用该命令，指定相同文件或者目录即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container run -d -v cron-data:/app my-cron
</span></span><span style="display:flex;"><span>43c6d0357b0893861092a752c61ab01bdfa62ea766d01d2fcb8b3ecb6c88b3de
</span></span><span style="display:flex;"><span>$ docker volume ls
</span></span><span style="display:flex;"><span>DRIVER    VOLUME NAME
</span></span><span style="display:flex;"><span>local     cron-data
</span></span><span style="display:flex;"><span>$ docker volume inspect cron-data
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2023-04-15T16:30:38+08:00&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Mountpoint&#34;</span>: <span style="color:#e6db74">&#34;/var/lib/docker/volumes/cron-data/_data&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;cron-data&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>$ ls /var/lib/docker/volumes/cron-data/_data
</span></span><span style="display:flex;"><span>my-cron
</span></span><span style="display:flex;"><span>$ ls /var/lib/docker/volumes/cron-data/_data
</span></span><span style="display:flex;"><span>my-cron  test.txt
</span></span></code></pre></div><p>Volume也创建了。</p>
<h4 id="数据清理">数据清理</h4>
<p>强制删除所有容器，系统清理和volume清理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker rm -f <span style="color:#66d9ef">$(</span>docker container ps -aq<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>$ docker system prune -f
</span></span><span style="display:flex;"><span>$ docker volume prune -f  
</span></span></code></pre></div><h3 id="mysql数据持久化实践">mysql数据持久化实践</h3>
<p>现在我们来实践使用volume对MySQL数据库容器的数据做持久化</p>
<h4 id="拉取mysq">拉取mysq</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker pull mysql:latest
</span></span></code></pre></div><h4 id="运行mysql容器">运行mysql容器</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker container run --name demo-mysql -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> -d -p 3307:3306 -v mysql-data:/var/lib/mysql mysql:latest
</span></span></code></pre></div><h4 id="说明">说明</h4>
<ul>
<li>
<p><code>--name</code>：运行的容器名称</p>
</li>
<li>
<p><code>-e MYSQL_ROOT_PASSWORD</code>：表示当前MySQL容器的密码</p>
</li>
<li>
<p><code>-p 3307:3306</code>：有容器端口3306映射到宿主机端口</p>
</li>
<li>
<p><code>-v mysql-data:/var/lib/mysql</code>：将容器中的<code>/var/lib/mysql</code>持久化到宿主机<code>mysql-data</code>中</p>
</li>
</ul>
<p>这里由于我们本地mysql占用3306，所以我开3307</p>
<p>然后我们之间连接MySQL服务(或者直接进入MySQL容器中)，写入如下内容：建立一个user数据库，新建一个user_info表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#66d9ef">user</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">DEFAULT</span> CHARACTER <span style="color:#66d9ef">SET</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;utf8mb4&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> user_info(
</span></span><span style="display:flex;"><span>    id int <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户id&#39;</span>,
</span></span><span style="display:flex;"><span>    name VARCHAR(<span style="color:#ae81ff">30</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;姓名&#39;</span>,
</span></span><span style="display:flex;"><span>    age INT <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;年龄&#39;</span>,
</span></span><span style="display:flex;"><span>    gender VARCHAR(<span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;性别&#39;</span>
</span></span><span style="display:flex;"><span>)<span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户基本信息表&#39;</span>;
</span></span></code></pre></div><p>然后我们来查看运行持久化文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker volume ls                                                                                                                                                                              
</span></span><span style="display:flex;"><span>DRIVER    VOLUME NAME
</span></span><span style="display:flex;"><span>local     mysql-data
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> docker inspect mysql-data                                                                                                                                                                     
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2023-04-15T09:17:49Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Mountpoint&#34;</span>: <span style="color:#e6db74">&#34;/var/lib/docker/volumes/mysql-data/_data&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mysql-data&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>可以查看：<code>/var/lib/docker/volumes/mysql-data/_data</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ /var/lib/docker/volumes/mysql-data/_data
</span></span><span style="display:flex;"><span>auto.cnf    client-cert.pem  ib_buffer_pool  ibdata1  performance_schema  server-cert.pem
</span></span><span style="display:flex;"><span>ca-key.pem  client-key.pem   ib_logfile0     ibtmp1   private_key.pem     server-key.pem
</span></span><span style="display:flex;"><span>ca.pem      user             ib_logfile1     mysql    public_key.pem      sys
</span></span></code></pre></div><p><strong>注意：如果是mac和win系统是直接查看不了<code>/var/lib/docker/volumes/mysql-data/_data</code>，原因是docker运行在Linux虚拟机中</strong></p>
<p><strong>当我们把MySQL这个容器删除后，然后重新运行一个MySQL容器，持久化的数据会被导入新的容器中</strong></p>
<h3 id="持久化之bind-mount">持久化之Bind Mount</h3>
<p>前面说过：如果是mac和win系统是直接查看不了<code>/var/lib/docker/volumes/mysql-data/_data</code>；现在可以直接使用BindMount将容器中的内容映射到宿主机上的指定目录之下。</p>
<p>依然使用MySQL容器作为例子：</p>
<p>当前目录下什么都没有：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql-data<span style="color:#f92672">]</span> ls
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql-data<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql-data<span style="color:#f92672">]</span> pwd                                                                                             
</span></span><span style="display:flex;"><span>/Users/iceymoss/iceymoss/dockerlearn/mysql-data
</span></span></code></pre></div><p>然后运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>mysql-data<span style="color:#f92672">]</span> docker container run --name demo-mysql -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> -d -p 3307:3306 -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>:/var/lib/mysql mysql:latest
</span></span></code></pre></div><p>说明：</p>
<ul>
<li><code>-v $(pwd):/var/lib/mysql</code>：表示将宿主机当前目录下进行持久化映射到mysql容器中的<code>/var/lib/mysql</code></li>
</ul>
<p>只需要这样我们就完成了容器数据持久化到宿主机的指定目录下。</p>
<p>进入容器shell或者mysql连接工具，创建两个数据库：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> good
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CHARACTER</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;utf8mb4&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#66d9ef">user</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CHARACTER</span> <span style="color:#66d9ef">SET</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;utf8mb4&#39;</span>;
</span></span></code></pre></div><p>启动容器后可以查看当前目录的情况：</p>
<pre tabindex="0"><code>[mysql-data] ls                                                                                                 
#ib_16384_0.dblwr  #innodb_temp       binlog.000002      ca.pem             good               ibtmp1             mysql.sock         public_key.pem     sys                user
#ib_16384_1.dblwr  auto.cnf           binlog.index       client-cert.pem    ib_buffer_pool     mysql              performance_schema server-cert.pem    undo_001
#innodb_redo       binlog.000001      ca-key.pem         client-key.pem     ibdata1            mysql.ibd          private_key.pem    server-key.pem     undo_002
</code></pre><p>可以看到我们创建的数据库。</p>
<p>和volume一样，如果将当前MySQL的容器删除，然后重新创建一个MySQL容器，只需要将宿主机<code>/Users/iceymoss/iceymoss/dockerlearn/mysql-data</code>重新映射到容器中<code>/var/lib/mysql</code>就可以持久化数据重新加载到容器中。</p>
<h3 id="基于docker搭建开发环境">基于docker搭建开发环境</h3>
<p>假如我们在本地没有安装对应编程语言的开发环境，这里以golang例，我们可以将编写好的golang程序使用BindMout上传至有golang开发环境的基础镜像中去，然后进行编译运行。</p>
<p>举个例子：</p>
<p>main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#e6db74">&#34;main&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello,docker&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>ch01<span style="color:#f92672">]</span> docker container run -it -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>:/root golang:alpine3.17
</span></span></code></pre></div><p>进入容器：</p>
<pre tabindex="0"><code>~ # cd /root
~ # ls
main.go
~ # go run main.go
hello,docker
~ # go build main.go
~ # ls
main     main.go
~ # ./main
hello,docker
</code></pre><p>这样我们的程序就运行和编译了。</p>
<h3 id="多个机器之间的容器共享数据">多个机器之间的容器共享数据</h3>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/volumes-shared-storage.png" alt="multi-host-volume"></p>
<p>官方参考链接 <a href="https://docs.docker.com/storage/volumes/#share-data-among-machines">https://docs.docker.com/storage/volumes/#share-data-among-machines</a></p>
<p>Docker的volume支持多种driver。默认创建的volume driver都是local</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker volume inspect vscode
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2021-06-23T21:33:57Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Mountpoint&#34;</span>: <span style="color:#e6db74">&#34;/var/lib/docker/volumes/vscode/_data&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;vscode&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>这一节我们看看一个叫sshfs的driver，如何让docker使用不在同一台机器上的文件系统做volume</p>
<h4 id="环境准备">环境准备</h4>
<p>准备三台Linux机器，之间可以通过SSH相互通信。</p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>ip</th>
<th>ssh username</th>
<th>ssh password</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker-host1</td>
<td>192.168.200.10</td>
<td>vagrant</td>
<td>vagrant</td>
</tr>
<tr>
<td>docker-host2</td>
<td>192.168.200.11</td>
<td>vagrant</td>
<td>vagrant</td>
</tr>
<tr>
<td>docker-host3</td>
<td>192.168.200.12</td>
<td>vagrant</td>
<td>vagrant</td>
</tr>
</tbody>
</table>
<h4 id="安装plugin">安装plugin</h4>
<p>在其中两台机器上安装一个plugin <code>vieux/sshfs</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host1 ~<span style="color:#f92672">]</span>$ docker plugin install --grant-all-permissions vieux/sshfs
</span></span><span style="display:flex;"><span>latest: Pulling from vieux/sshfs
</span></span><span style="display:flex;"><span>Digest: sha256:1d3c3e42c12138da5ef7873b97f7f32cf99fb6edde75fa4f0bcf9ed277855811
</span></span><span style="display:flex;"><span>52d435ada6a4: Complete
</span></span><span style="display:flex;"><span>Installed plugin vieux/sshfs
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host2 ~<span style="color:#f92672">]</span>$ docker plugin install --grant-all-permissions vieux/sshfs
</span></span><span style="display:flex;"><span>latest: Pulling from vieux/sshfs
</span></span><span style="display:flex;"><span>Digest: sha256:1d3c3e42c12138da5ef7873b97f7f32cf99fb6edde75fa4f0bcf9ed277855811
</span></span><span style="display:flex;"><span>52d435ada6a4: Complete
</span></span><span style="display:flex;"><span>Installed plugin vieux/sshfs
</span></span></code></pre></div><h4 id="创建volume">创建volume</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host1 ~<span style="color:#f92672">]</span>$ docker volume create --driver vieux/sshfs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                          -o sshcmd<span style="color:#f92672">=</span>vagrant@192.168.200.12:/home/vagrant <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                          -o password<span style="color:#f92672">=</span>vagrant <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                          sshvolume
</span></span></code></pre></div><p>查看</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host1 ~<span style="color:#f92672">]</span>$ docker volume ls
</span></span><span style="display:flex;"><span>DRIVER               VOLUME NAME
</span></span><span style="display:flex;"><span>vieux/sshfs:latest   sshvolume
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host1 ~<span style="color:#f92672">]</span>$ docker volume inspect sshvolume
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;0001-01-01T00:00:00Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;vieux/sshfs:latest&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Mountpoint&#34;</span>: <span style="color:#e6db74">&#34;/mnt/volumes/f59e848643f73d73a21b881486d55b33&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;sshvolume&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;vagrant&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;sshcmd&#34;</span>: <span style="color:#e6db74">&#34;vagrant@192.168.200.12:/home/vagrant&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><h4 id="创建容器挂载volume">创建容器挂载Volume</h4>
<p>创建容器，挂载sshvolume到/app目录，然后进入容器的shell，在/app目录创建一个test.txt文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host1 ~<span style="color:#f92672">]</span>$ docker run -it -v sshvolume:/app busybox sh
</span></span><span style="display:flex;"><span>Unable to find image <span style="color:#e6db74">&#39;busybox:latest&#39;</span> locally
</span></span><span style="display:flex;"><span>latest: Pulling from library/busybox
</span></span><span style="display:flex;"><span>b71f96345d44: Pull complete
</span></span><span style="display:flex;"><span>Digest: sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d
</span></span><span style="display:flex;"><span>Status: Downloaded newer image <span style="color:#66d9ef">for</span> busybox:latest
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>app   bin   dev   etc   home  proc  root  sys   tmp   usr   var
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># cd /app</span>
</span></span><span style="display:flex;"><span>/app <span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>/app <span style="color:#75715e"># echo &#34;this is ssh volume&#34;&gt; test.txt</span>
</span></span><span style="display:flex;"><span>/app <span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>test.txt
</span></span><span style="display:flex;"><span>/app <span style="color:#75715e"># more test.txt</span>
</span></span><span style="display:flex;"><span>this is ssh volume
</span></span><span style="display:flex;"><span>/app <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>/app <span style="color:#75715e">#</span>
</span></span></code></pre></div><p>这个文件我们可以在docker-host3上看到</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host3 ~<span style="color:#f92672">]</span>$ pwd
</span></span><span style="display:flex;"><span>/home/vagrant
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host3 ~<span style="color:#f92672">]</span>$ ls
</span></span><span style="display:flex;"><span>test.txt
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@docker-host3 ~<span style="color:#f92672">]</span>$ more test.txt
</span></span><span style="display:flex;"><span>this is ssh volume
</span></span></code></pre></div><h2 id="docker网络">docker网络</h2>
<h3 id="介绍">介绍</h3>
<p>docker网络主要有：</p>
<ul>
<li>Brigde</li>
<li>Host</li>
<li>null</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span>b8ca79f73455   bridge    bridge    local
</span></span><span style="display:flex;"><span>d90ff26166e3   host      host      local
</span></span><span style="display:flex;"><span>82d6ae2e173d   none      null      local
</span></span></code></pre></div><p>在docker网络中，我们需要回答五个问题</p>
<ul>
<li>
<p>容器为什么能获取ip地址。</p>
</li>
<li>
<p>为什么宿主机可以ping通容器ip。</p>
</li>
<li>
<p>为什么docker容器之可以ping通网络。</p>
</li>
<li>
<p>为什么容器可以ping通外网地址。</p>
</li>
<li>
<p>容器端口转发是怎么回事。</p>
</li>
</ul>
<h3 id="brigde网络">Brigde网络</h3>
<p>docker默认的网络是使用一个doekr0作为网络转发，类似于路由器。其通讯类型是：<strong>bridge</strong> 。</p>
<!-- raw HTML omitted -->
<p>上图是我们的一台宿主机和运行的两个容器的网络拓扑图，下面我们准备运行的容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED        STATUS        PORTS                               NAMES
</span></span><span style="display:flex;"><span>033243ce3801   mysql:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">24</span> hours ago   Up <span style="color:#ae81ff">24</span> hours   33060/tcp, 0.0.0.0:3307-&gt;3306/tcp   server-mysql
</span></span><span style="display:flex;"><span>a51d40b5eeea   mongo:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">25</span> hours ago   Up <span style="color:#ae81ff">25</span> hours   0.0.0.0:27017-&gt;27017/tcp            keen_bouman
</span></span><span style="display:flex;"><span>0910b6c23f19   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">25</span> hours ago   Up <span style="color:#ae81ff">25</span> hours   0.0.0.0:6379-&gt;6379/tcp              keen_burnell
</span></span></code></pre></div><p>然后我们使用命令查看网络：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME      DRIVER    SCOPE
</span></span><span style="display:flex;"><span>b8ca79f73455   bridge    bridge    local
</span></span><span style="display:flex;"><span>d90ff26166e3   host      host      local
</span></span><span style="display:flex;"><span>82d6ae2e173d   none      null      local
</span></span></code></pre></div><p>使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network inspect b8ca79f73455
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;b8ca79f73455660003be1225a30a08e58d7575d9a0064b575e876b0294b22545&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2023-04-21T06:37:17.281109791Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;033243ce380110beef00dbc5f61dde95560b9f1633d3bfad70e4da0d4ccfaf42&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;server-mysql&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;f6561639185394753fafd19e44253640b51e80285d172b397504c86d440ea98e&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:04&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.4/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;0910b6c23f19f7c557fe925a1e9ed60912c62cb10e53fd9aad75e7efd1e195a6&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;keen_burnell&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;a9db648c673688f09206d06d5eb6f865aff95efbbb65583e6ab539dc14097571&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:02&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.2/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;a51d40b5eeeaa2c917284d0380dcf0a1e4ae2f6d4f674c2c27fb7bbdc7546614&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;keen_bouman&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;0b455515d4e5e73b597bb9e038a278b3a1cd4af9a23e125ce3cacecec374d063&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:03&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.3/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.default_bridge&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.enable_icc&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.enable_ip_masquerade&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.host_binding_ipv4&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.bridge.name&#34;</span>: <span style="color:#e6db74">&#34;docker0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.network.driver.mtu&#34;</span>: <span style="color:#e6db74">&#34;1500&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>由上面返回结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span></code></pre></div><p>我们看到docker0的ip和网关，<strong>连接在docker0上的容器ip统一在172.17.0.0/16网段下</strong>，这看上去类似于家庭中的网络结构，运行的容器就像是连接在家庭路由器的每一台设备。</p>
<p>同样我们可以看到，三个容器都连接在docker0上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;033243ce380110beef00dbc5f61dde95560b9f1633d3bfad70e4da0d4ccfaf42&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;server-mysql&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;f6561639185394753fafd19e44253640b51e80285d172b397504c86d440ea98e&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:04&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.4/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;0910b6c23f19f7c557fe925a1e9ed60912c62cb10e53fd9aad75e7efd1e195a6&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;keen_burnell&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;a9db648c673688f09206d06d5eb6f865aff95efbbb65583e6ab539dc14097571&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:02&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.2/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;a51d40b5eeeaa2c917284d0380dcf0a1e4ae2f6d4f674c2c27fb7bbdc7546614&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;keen_bouman&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;0b455515d4e5e73b597bb9e038a278b3a1cd4af9a23e125ce3cacecec374d063&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:11:00:03&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.3/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span></code></pre></div><h4 id="容器为什么能获取ip地址">容器为什么能获取ip地址</h4>
<p>docker默认的网络是使用一个doekr0作为网络转发，类似于路由器。其通讯类型是：<strong>bridge</strong> 。</p>
<p>Brigde网络类型，为每一个容器分配了一个局域网ip，容器之间可以通讯。</p>
<h4 id="为什么宿主机可以ping通容器ip">为什么宿主机可以ping通容器ip</h4>
<!-- raw HTML omitted -->
<p>我们看到docker0这个bridge连接到了我们的宿主机网络，就像是docker链接了一个通往外网的路由一样，就类似于家庭路由器连接到了网络运营商本地的路由器。</p>
<h4 id="为什么docker容器之可以ping通网络">为什么docker容器之可以ping通网络</h4>
<p>这个问题其实很好解释了，容器之间都连接了docker0，相当于两个容器在一个局域网内，肯定是可以连通网络的</p>
<h4 id="为什么容器可以ping通外网地址">为什么容器可以ping通外网地址</h4>
<p>当我们进入某一个容器内，例如直接ping<code>www.baidu.com</code>这也是能ping通的，这又是为什么呢？直接举个例子你就明白了。</p>
<p>在此之前，你需要明白NAT，也是会网络层的地址转换协议</p>
<p>例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
</span></span><span style="display:flex;"><span>4f3303c84e53   busybox   <span style="color:#e6db74">&#34;/bin/sh -c &#39;while t…&#34;</span>   <span style="color:#ae81ff">49</span> minutes ago   Up <span style="color:#ae81ff">49</span> minutes             box2
</span></span><span style="display:flex;"><span>03494b034694   busybox   <span style="color:#e6db74">&#34;/bin/sh -c &#39;while t…&#34;</span>   <span style="color:#ae81ff">49</span> minutes ago   Up <span style="color:#ae81ff">49</span> minutes             box1
</span></span></code></pre></div><p>box1的ip:<code>172.17.0.3</code>， box4的ip:<code>172.17.0.3</code></p>
<p>docker0的IP：<code>172.17.0.1</code>， 宿主机IP：<code>192.168.10.4</code></p>
<p>本地路由器ip公网ip:<code>1.14.120.10</code></p>
<p>当我们在容器box1中ping：<code>www.baidu.com</code>， 在百度的服务器看来其实是路由器ip:<code>1.14.120.10</code>进行的，在外网是无法感知到内网的</p>
<p>其过程是：box1的ip:<code>172.17.0.3</code>将数据报发送给docker0IP：<code>172.17.0.1</code>然后，docker0查看数据报目的地址然后将自己的ip写入数据报的源地址，然后转发给宿主机，然后宿主机将自己的ip填入数据报中的源地址，最后发给路由器ip公网ip:<code>1.14.120.10</code>路由器将自己的ip写入数据报中的源地址，最后发给<code>www.baidu.com</code>对应的服务器。</p>
<p><strong>发数据：172.17.0.3 &ndash;&gt; 172.17.0.1 &ndash;&gt;  192.168.10.4 &ndash;&gt;  1.14.120.10 &ndash;&gt;<code> www.baidu.com</code></strong></p>
<p><strong>返回数据：<code> www.baidu.com</code> &ndash;&gt;  1.14.120.10 &ndash;&gt; 192.168.10.4  &ndash;&gt; 172.17.0.1  &ndash;&gt; 172.17.0.3</strong></p>
<h4 id="容器端口转发是怎么回事">容器端口转发是怎么回事</h4>
<p>比如我现在有一个web服务器NGINX容器，他运行的NGINX容器的80端口上，现在我们从其他设备怎么进行访问到这个80端口？</p>
<h5 id="端口映射">端口映射</h5>
<p>我们来开这条命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d -p 8080:80 nginx:latest
</span></span></code></pre></div><p><code>-p 8080:80</code>:表示将宿主机上的8080端口映射到容器nginx的80端口，当有请求进来时，请求会先到我们的host:8080端口，然后通过端口转发将宿主机上的8080的请求转发到容器NGINX的80端口上。我们在外网直接对宿主机ip:8080端口就可以请求到NGINXweb服务器。</p>
<p>下面的容器都做了端口转发</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d -p 8080:80 nginx:latest
</span></span><span style="display:flex;"><span>d9f0c712b30919c8854a7e9f06e5d86772a7dca96badbf62f4bc98093b7550c2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># iceymoss @ iceymossdeMacBook-Pro in ~ [16:01:35]</span>
</span></span><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                               NAMES
</span></span><span style="display:flex;"><span>d9f0c712b309   nginx:latest   <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">4</span> seconds ago   Up <span style="color:#ae81ff">3</span> seconds   0.0.0.0:8080-&gt;80/tcp                competent_buck
</span></span><span style="display:flex;"><span>033243ce3801   mysql:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">25</span> hours ago    Up <span style="color:#ae81ff">25</span> hours    33060/tcp, 0.0.0.0:3307-&gt;3306/tcp   server-mysql
</span></span><span style="display:flex;"><span>a51d40b5eeea   mongo:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">25</span> hours ago    Up <span style="color:#ae81ff">25</span> hours    0.0.0.0:27017-&gt;27017/tcp            keen_bouman
</span></span><span style="display:flex;"><span>0910b6c23f19   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">25</span> hours ago    Up <span style="color:#ae81ff">25</span> hours    0.0.0.0:6379-&gt;6379/tcp              keen_burnell
</span></span></code></pre></div><h5 id="dockerfile">Dockerfile</h5>
<p>我们来看一下一个goweb服务的Dockerfile</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:alpine3.17</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> main.go /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> go.mod /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> go.sum /src/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go mod download <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    go build main.go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8083</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/src/main&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>仔细看<code>EXPOSE 8083</code>表示容器对外暴露的端口，他默认是TCP协议端口，如果我们需要使用UDP协议就需要:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8083/udp</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>如果我们不编写这一行，当我们在运行这个容器时只需要：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker container run -d -p 8083:8083 gin-demo:1.0
</span></span></code></pre></div><p>他依然能正常对外暴露我们指定的端口，这里的<code>EXPOSE 8083</code>更多的是提示使用者，该镜像需要进行端口映射。</p>
<h3 id="自定义brigde">自定义Brigde</h3>
<p>docker网络默认是使用docker0来做网关，但是很多时候我们需要根据业务需要自己定义一下Brigde</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network create -d bridge bridge_name
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network create -d bridge mybridge  <span style="color:#75715e">#新建一个bridge</span>
</span></span><span style="display:flex;"><span>9ad7eca18a46ff733eca849c008530deca34f67d9f895e007c0463e73630a24b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker network ls  <span style="color:#75715e">#查看docker网络</span>
</span></span><span style="display:flex;"><span>NETWORK ID     NAME       DRIVER    SCOPE
</span></span><span style="display:flex;"><span>b8ca79f73455   bridge     bridge    local
</span></span><span style="display:flex;"><span>d90ff26166e3   host       host      local
</span></span><span style="display:flex;"><span>9ad7eca18a46   mybridge   bridge    local
</span></span><span style="display:flex;"><span>82d6ae2e173d   none       null      local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker network inspect 9ad7eca18a46  <span style="color:#75715e">#查看mybridge</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mybrigde&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;9ad7eca18a46ff733eca849c008530deca34f67d9f895e007c0463e73630a24b&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2023-04-22T08:52:55.674403043Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>我们可以看到配置中的ip，当我们的容器连接到我们创建的bridge上，会为其分配该bridge子网的ip</p>
<h4 id="连接到指定brigde">连接到指定Brigde</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d --rm --name box1 busybox:latest /bin/sh -c <span style="color:#e6db74">&#34;while true; do sleep 3600; done&#34;</span>
</span></span></code></pre></div><p>会默认连接到docker0</p>
<p>需要我们指定到：mybridge</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d --rm --name box2 --network mybridge busybox:latest /bin/sh -c <span style="color:#e6db74">&#34;while true; do sleep 3600; done&#34;</span>
</span></span><span style="display:flex;"><span>3986f6f4ae91633c7c31f60faa0fa136bd884d8b971f570cbeb33563a9bf155c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker run -d --rm --name box3 --network mybridge busybox:latest /bin/sh -c <span style="color:#e6db74">&#34;while true; do sleep 3600; done&#34;</span>
</span></span><span style="display:flex;"><span>b91b45d9a8dbe5b19672e5633de4595ed42615c3d0f38dacff4b0bb08103472f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME       DRIVER    SCOPE
</span></span><span style="display:flex;"><span>b8ca79f73455   bridge     bridge    local
</span></span><span style="display:flex;"><span>d90ff26166e3   host       host      local
</span></span><span style="display:flex;"><span>9ad7eca18a46   mybridge   bridge    local
</span></span><span style="display:flex;"><span>82d6ae2e173d   none       null      local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker network inspect 9ad7eca18a46
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mybridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;9ad7eca18a46ff733eca849c008530deca34f67d9f895e007c0463e73630a24b&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2023-04-22T08:52:55.674403043Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;3986f6f4ae91633c7c31f60faa0fa136bd884d8b971f570cbeb33563a9bf155c&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;box2&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;b3ca1d035c685173124e33d81039ac090dfce7f1a3862aae26bbe3424fa95f9c&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:12:00:02&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.2/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;b91b45d9a8dbe5b19672e5633de4595ed42615c3d0f38dacff4b0bb08103472f&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;box3&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;8f76ce7a717f77d884d3b4341aa5bd4a03d829a8133a02f28aca1c81b67cbd21&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:12:00:03&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.18.0.3/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><h4 id="容器连接多个网络">容器连接多个网络</h4>
<p>可以将一个容器连接到多个网络Brigde</p>
<p>例如前面的box2已经连接了mybridge，现在我们要讲box2再连接到docker0的bridge网络上</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network connect bridge box2
</span></span></code></pre></div><h3 id="host网络">host网络</h3>
<p>前面我们学习了bridge网络，现在我们来学习一下docker的host网络，host顾名思义，就是容器直接使用宿主ip进行通讯，例如NGINX容器，使用host网络，那么他就会占用宿主机的80端口，mysq则会占用3306端口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d --name nginx-web --network host nginx:latest
</span></span><span style="display:flex;"><span>171e3babf161bbda519e4081d11618bbed8e561e276bafebf693687444054fc1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker ps   <span style="color:#75715e">#PORTS没有信息，相当于在本地启动了一个NGINX服务</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE            COMMAND                  CREATED             STATUS             PORTS                               NAMES
</span></span><span style="display:flex;"><span>171e3babf161   nginx:latest     <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">5</span> seconds ago       Up <span style="color:#ae81ff">4</span> seconds                                           nginx-web                                        box1
</span></span></code></pre></div><p>然后查看一下host相关信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME       DRIVER    SCOPE
</span></span><span style="display:flex;"><span>b8ca79f73455   bridge     bridge    local
</span></span><span style="display:flex;"><span>d90ff26166e3   host       host      local
</span></span><span style="display:flex;"><span>9ad7eca18a46   mybrigde   bridge    local
</span></span><span style="display:flex;"><span>82d6ae2e173d   none       null      local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># iceymoss @ iceymossdeMacBook-Pro in ~ [17:20:02]</span>
</span></span><span style="display:flex;"><span>$ docker network inspect d90ff26166e3
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;host&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;d90ff26166e3e699bf40b570c7987da53752e3ca207c10403a9f62e6f5296529&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2023-04-21T05:43:37.064860583Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;host&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;171e3babf161bbda519e4081d11618bbed8e561e276bafebf693687444054fc1&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nginx-web&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;62895ff820b05450de65c356c0122a5fa30626c5f1cd0639638642c6372e5bf0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><h4 id="性能分析">性能分析</h4>
<p>host网络相比于bridge性能更高，因为host直接使用宿主机的ip，不需要进行docker内部bridge复杂的网络，没有更多的消耗。</p>
<h3 id="none网络">none网络</h3>
<p>就是不需要连接任何网络，只是在后台运行一个容器，告诉docker你需要运行容器，网络方面你不需要管理，我自己需要自己配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker run -d --name nginx-web --network none nginx:latest
</span></span></code></pre></div><h3 id="实战">实战</h3>
<h4 id="python-flask--redis-练习">Python Flask + Redis 练习</h4>
<p><img src="https://dockertips.readthedocs.io/en/latest/single-host-network/_static/flask-redis.png" alt="flask-redis"></p>
<h4 id="程序准备">程序准备</h4>
<p>准备一个Python文件，名字为 <code>app.py</code> 内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> redis <span style="color:#f92672">import</span> Redis
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">=</span> Redis(host<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_HOST&#39;</span>, <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>), port<span style="color:#f92672">=</span><span style="color:#ae81ff">6379</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
</span></span><span style="display:flex;"><span>    redis<span style="color:#f92672">.</span>incr(<span style="color:#e6db74">&#39;hits&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello Container World! I have been seen </span><span style="color:#e6db74">{</span>redis<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;hits&#39;</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74"> times and my hostname is </span><span style="color:#e6db74">{</span>socket<span style="color:#f92672">.</span>gethostname()<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>准备一个Dockerfile</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install flask redis <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    groupadd -r flask <span style="color:#f92672">&amp;&amp;</span> useradd -r -g flask flask <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir /src <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    chown -R flask:flask /src<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> flask</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> app.py /src/app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLASK_APP<span style="color:#f92672">=</span>app.py REDIS_HOST<span style="color:#f92672">=</span>redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h4 id="镜像准备">镜像准备</h4>
<p>构建flask镜像，准备一个redis镜像。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image pull redis
</span></span><span style="display:flex;"><span>$ docker image build -t flask-demo .
</span></span><span style="display:flex;"><span>$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY   TAG          IMAGE ID       CREATED              SIZE
</span></span><span style="display:flex;"><span>flask-demo   latest       4778411a24c5   About a minute ago   126MB
</span></span><span style="display:flex;"><span>python       3.9.5-slim   c71955050276   <span style="color:#ae81ff">8</span> days ago           115MB
</span></span><span style="display:flex;"><span>redis        latest       08502081bff6   <span style="color:#ae81ff">2</span> weeks ago          105MB
</span></span></code></pre></div><h4 id="创建一个docker-bridge">创建一个docker bridge</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network create -d bridge demo-network
</span></span><span style="display:flex;"><span>8005f4348c44ffe3cdcbbda165beea2b0cb520179d3745b24e8f9e05a3e6456d
</span></span><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME           DRIVER    SCOPE
</span></span><span style="display:flex;"><span>2a464c0b8ec7   bridge         bridge    local
</span></span><span style="display:flex;"><span>8005f4348c44   demo-network   bridge    local
</span></span><span style="display:flex;"><span>80b63f711a37   host           host      local
</span></span><span style="display:flex;"><span>fae746a75be1   none           null      local
</span></span><span style="display:flex;"><span>$
</span></span></code></pre></div><h4 id="创建redis-container">创建redis container</h4>
<p>创建一个叫 <code>redis-server</code> 的container，连到 demo-network上</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container run -d --name redis-server --network demo-network redis
</span></span><span style="display:flex;"><span>002800c265020310231d689e6fd35bc084a0fa015e8b0a3174aa2c5e29824c0e
</span></span><span style="display:flex;"><span>$ docker container ls
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS      NAMES
</span></span><span style="display:flex;"><span>002800c26502   redis     <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">4</span> seconds ago   Up <span style="color:#ae81ff">3</span> seconds   6379/tcp   redis-server
</span></span><span style="display:flex;"><span>$
</span></span></code></pre></div><h4 id="创建flask-container">创建flask container</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container run -d --network demo-network --name flask-demo --env REDIS_HOST<span style="color:#f92672">=</span>redis-server -p 5000:5000 flask-demo
</span></span></code></pre></div><p>打开浏览器访问 <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000</a></p>
<p>应该能看到类似下面的内容，每次刷新页面，计数加1</p>
<p>Hello Container World! I have been seen 36 times and my hostname is 925ecb8d111a.</p>
<h4 id="总结">总结</h4>
<p>如果把上面的步骤合并到一起，成为一个部署脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># prepare image</span>
</span></span><span style="display:flex;"><span>docker image pull redis
</span></span><span style="display:flex;"><span>docker image build -t flask-demo .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create network</span>
</span></span><span style="display:flex;"><span>docker network create -d bridge demo-network
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create container</span>
</span></span><span style="display:flex;"><span>docker container run -d --name redis-server --network demo-network redis
</span></span><span style="display:flex;"><span>docker container run -d --network demo-network --name flask-demo --env REDIS_HOST<span style="color:#f92672">=</span>redis-server -p 5000:5000 flask-demo
</span></span></code></pre></div><h2 id="docker-compose">docker compose</h2>
<h3 id="docker-compose安装">docker compose安装</h3>
<p>Windows和Mac在默认安装了docker desktop以后，docker-compose随之自动安装</p>
<pre tabindex="0"><code>PS C:\Users\Peng Xiao\docker.tips&gt; docker-compose --version
docker-compose version 1.29.2, build 5becea4c
</code></pre><p>Linux用户需要自行安装</p>
<p>最新版本号可以在这里查询 <a href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ sudo curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ sudo chmod +x /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>$ docker-compose --version
</span></span><span style="display:flex;"><span>docker-compose version 1.29.2, build 5becea4c
</span></span></code></pre></div><p>熟悉python的朋友，可以使用pip去安装docker-Compose</p>
<pre tabindex="0"><code>$ pip install docker-compose
</code></pre><h3 id="docker-compose结构和文件">docker-compose结构和文件</h3>
<h4 id="基本语法结构">基本语法结构</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>: <span style="color:#75715e"># 容器</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servicename</span>: <span style="color:#75715e"># 服务名字，这个名字也是内部 bridge网络可以使用的 DNS name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#75715e"># 镜像的名字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#75715e"># 可选，如果设置，则会覆盖默认镜像里的 CMD命令</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>: <span style="color:#75715e"># 可选，相当于 docker run里的 --env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 可选，相当于docker run里的 -v</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>: <span style="color:#75715e"># 可选，相当于 docker run里的 --network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>: <span style="color:#75715e"># 可选，相当于 docker run里的 -p</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servicename2</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>: <span style="color:#75715e"># 可选，相当于 docker volume create</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>: <span style="color:#75715e"># 可选，相当于 docker network create</span>
</span></span></code></pre></div><p>以 Python Flask + Redis练习：为例子，改造成一个docker-compose文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker image pull redis
</span></span><span style="display:flex;"><span>docker image build -t flask-demo .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create network</span>
</span></span><span style="display:flex;"><span>docker network create -d bridge demo-network
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create container</span>
</span></span><span style="display:flex;"><span>docker container run -d --name redis-server --network demo-network redis
</span></span><span style="display:flex;"><span>docker container run -d --network demo-network --name flask-demo --env REDIS_HOST<span style="color:#f92672">=</span>redis-server -p 5000:5000 flask-demo
</span></span></code></pre></div><p>docker-compose.yml 文件如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask-demo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8080</span>:<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">demo-network</span>:
</span></span></code></pre></div><h4 id="docker-compose-语法版本">docker-compose 语法版本</h4>
<p>向后兼容</p>
<p><a href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>
<h3 id="docker-compose命令">docker compose命令</h3>
<h4 id="启动">启动</h4>
<blockquote>
<p>docker-compose up</p>
</blockquote>
<p>使用启动命令需要先进入对应的目录中，前提条件一定是本地镜像中对应的镜像了</p>
<p>我们需要进入到存储docker-compose.yml文件的目录下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker-compose up   <span style="color:#75715e">#前台启动，会打印日志，退出容器也就退出</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker-compose up -d   <span style="color:#75715e">#后台启动</span>
</span></span></code></pre></div><h4 id="拉取和构建">拉取和构建</h4>
<p>例如本地如果没有本地镜像，他会去DockerHub进行拉取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose pull <span style="color:#75715e">#拉取</span>
</span></span></code></pre></div><p>docker-compose为我们提供了一个构建需要的镜像的命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose build <span style="color:#75715e">#构建</span>
</span></span></code></pre></div><p>前提是我们需要先编写好docker-compse.yml文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask-demo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./docker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8081</span>:<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">demo-network</span>:
</span></span></code></pre></div><p>目录结构：</p>
<pre tabindex="0"><code class="language-test" data-lang="test">├── docker
│   ├── Dockerfile
│   └── app.py
├── docker-compose.yml
</code></pre><p>我们添加了，compose会默认去找./docker命令下的文件，并且需要注意我们没有指定dockerfile文件名称则默认是<code>Dockerfile</code>，但是有时候是需要我们指定的</p>
<pre tabindex="0"><code>build: ./docker
</code></pre><p>假设结构是这样的：</p>
<pre tabindex="0"><code>├── docker
│   ├── Dockerfile.dev
│   └── app.py
├── docker-compose.yml
</code></pre><p>我们需要这要编写docker-compose.yml文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask-demo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./docker</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8081</span>:<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div><h3 id="docker-compose服务更新">docker-compose服务更新</h3>
<h4 id="更新">更新</h4>
<h5 id="更新源文件">更新源文件</h5>
<p>当我们在使用docker-compos进行构建镜像的时候，当源文件更改后，要如何更新镜像</p>
<p>比如我们上面的<code>flask-demo</code>，我们直接修改app.py文件内容，然后发现更新和构建，compose提供了命令：</p>
<pre tabindex="0"><code>docker-compose up -d --build
</code></pre><p>该命令会检查镜像是否需要重新build，即使在容器在运行时也是可以进行构建的然后运行。</p>
<h5 id="更新compose文件">更新compose文件</h5>
<p>当我们更新compose文件后，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask-demo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./docker</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile.dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8081</span>:<span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>     - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">busybox</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">sh -c &#34;while true; do sleep 3600; done&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">demo-network</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">demo-network</span>:
</span></span></code></pre></div><p>我们新增了一个busybox的镜像，并执行命令，我们只需要使用：</p>
<pre tabindex="0"><code>docker-compose up -d
</code></pre><p>然后compose就会去拉取对镜像还在构建镜像</p>
<h5 id="移除镜像">移除镜像</h5>
<p>我们在上面实例的基础上移除<code>busybox</code>镜像后，运行命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose up -d  <span style="color:#75715e">#我们会看到提示</span>
</span></span><span style="display:flex;"><span>WARN<span style="color:#f92672">[</span>0000<span style="color:#f92672">]</span> Found orphan containers <span style="color:#f92672">([</span>hellopy-busybox-1<span style="color:#f92672">])</span> <span style="color:#66d9ef">for</span> this project. If you removed or renamed this service in your compose file, you can run this command with the --remove-orphans flag to clean it up.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Running 2/0
</span></span><span style="display:flex;"><span> ✔ Container hellopy-flask-demo-1    Running                                                                                                                                                           0.0s
</span></span><span style="display:flex;"><span> ✔ Container hellopy-redis-server-1  Running
</span></span></code></pre></div><p>所以我们需要使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose up -d --remove-orphans  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Running 3/1
</span></span><span style="display:flex;"><span> ✔ Container hellopy-busybox-1       Removed                                                                                                                                                          
</span></span><span style="display:flex;"><span> ✔ Container hellopy-flask-demo-1    Running                                                                                                                                                           
</span></span><span style="display:flex;"><span> ✔ Container hellopy-redis-server-1  Running                                                                                                                                                           
</span></span></code></pre></div><p>当然我们可以使用命令重启docker-compose完成内容的更新</p>
<pre tabindex="0"><code>docker-compose restart
</code></pre><h3 id="docker-compose网络">docker-compose网络</h3>
<p>Docker-compose.yml文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">box1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaopeng163/net-box:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">/bin/sh -c &#34;while true; do sleep 3600; done&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">box2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaopeng163/net-box:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">/bin/sh -c &#34;while true; do sleep 3600; done&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ pwd  <span style="color:#75715e">#当前目录下</span>
</span></span><span style="display:flex;"><span>/Users/iceymoss/moss/mybookprom1/iceymoss/dockerlearn/compose
</span></span><span style="display:flex;"><span>$ docker-compose pull
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Running 6/6
</span></span><span style="display:flex;"><span> ✔ box2 Skipped - Image is already being pulled by box1                                                                                                0.0s 
</span></span><span style="display:flex;"><span> ✔ box1 <span style="color:#ae81ff">4</span> layers <span style="color:#f92672">[</span>⣿⣿⣿⣿<span style="color:#f92672">]</span>      0B/0B      Pulled                                                                                                        31.2s 
</span></span><span style="display:flex;"><span>   ✔ a9eaa45ef418 Pull complete                                                                                                                        3.3s 
</span></span><span style="display:flex;"><span>   ✔ 44c1752ed77a Pull complete                                                                                                                        6.5s 
</span></span><span style="display:flex;"><span>   ✔ 868b03411fc7 Pull complete                                                                                                                        6.6s 
</span></span><span style="display:flex;"><span>   ✔ 63906fe482b2 Pull complete                                                                                                                        7.4s 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#我们启动compose后，docker-compose会创建一个compose_default的网桥</span>
</span></span><span style="display:flex;"><span>$ docker-compose up -d
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Running 3/3
</span></span><span style="display:flex;"><span> ✔ Network compose_default   Created                                                                                                                   0.0s 
</span></span><span style="display:flex;"><span> ✔ Container compose-box1-1  Started                                                                                                                   0.5s 
</span></span><span style="display:flex;"><span> ✔ Container compose-box2-1  Started  
</span></span></code></pre></div><p>也可以是使用命令查看</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME                   DRIVER    SCOPE
</span></span><span style="display:flex;"><span>b8ca79f73455   bridge                 bridge    local
</span></span><span style="display:flex;"><span>b6024e39aad8   compose_default        bridge    local
</span></span><span style="display:flex;"><span>718939d526ea   demo-network           bridge    local
</span></span><span style="display:flex;"><span>b96062db2804   docker_demo-network    bridge    local
</span></span><span style="display:flex;"><span>aa2909255943   hellopy_demo-network   bridge    local
</span></span><span style="display:flex;"><span>d90ff26166e3   host                   host      local
</span></span><span style="display:flex;"><span>9ad7eca18a46   mybrigde               bridge    local
</span></span><span style="display:flex;"><span>82d6ae2e173d   none                   null      local
</span></span></code></pre></div><p>然后看细节：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker network inspect compose_default
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;compose_default&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;b6024e39aad8079870ad57be523fa4c210d06eee9c16af6ea2d28fa36877c39b&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Created&#34;</span>: <span style="color:#e6db74">&#34;2023-04-30T07:13:17.531975672Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Scope&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;bridge&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;EnableIPv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;IPAM&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Driver&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Options&#34;</span>: null,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Config&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Subnet&#34;</span>: <span style="color:#e6db74">&#34;172.22.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;172.22.0.1&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Internal&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Attachable&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Ingress&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigFrom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Network&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ConfigOnly&#34;</span>: false,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Containers&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;2ec2e9f65996f00b2407a43da1bb9260389259271fdcd173ae76051409103f21&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;compose-box2-1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;d3b580cee55c5d8fb22ae7849478adf5cbf717e3d35935d77d1debfbba089183&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:16:00:03&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.22.0.3/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;61a42035833e4641ccb4d3c6d398410d36279996757bfa373b8101aae5e56718&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;compose-box1-1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;ea41525d7b6d6a69bd611e3113c3072e302442439ae683d1a2a4faab5e8e3f56&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:ac:16:00:02&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;172.22.0.2/16&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Options&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.compose.network&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.compose.project&#34;</span>: <span style="color:#e6db74">&#34;compose&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;com.docker.compose.version&#34;</span>: <span style="color:#e6db74">&#34;2.17.2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>我们在介绍docker网络的时候，其实这里就是自定义网络，但单机情况下，docker-compose默认的DRIVER是bridge</p>
<h3 id="docker-compose的横向拓展和负载均衡">docker-compose的横向拓展和负载均衡</h3>
<p>我们通过实例来介绍</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tree <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>/Users/iceymoss/compose-scale-example-1
</span></span><span style="display:flex;"><span>├── docker-compose.yml
</span></span><span style="display:flex;"><span>└── flask
</span></span><span style="display:flex;"><span>    ├── Dockerfile
</span></span><span style="display:flex;"><span>    └── app.py
</span></span></code></pre></div><p>docker-compose.yml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./flask</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">client</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">xiaopeng163/net-box:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">sh -c &#34;while true; do sleep 3600; done;&#34;</span>
</span></span></code></pre></div><p>Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install flask redis <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    groupadd -r flask <span style="color:#f92672">&amp;&amp;</span> useradd -r -g flask flask <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir /src <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    chown -R flask:flask /src<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> flask</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> app.py /src/app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLASK<span style="color:#f92672">=</span>app.py REDIS_HOST<span style="color:#f92672">=</span>redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>App.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> redis <span style="color:#f92672">import</span> Redis
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">=</span> Redis(host<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_HOST&#39;</span>, <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>), port<span style="color:#f92672">=</span><span style="color:#ae81ff">6379</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
</span></span><span style="display:flex;"><span>    redis<span style="color:#f92672">.</span>incr(<span style="color:#e6db74">&#39;hits&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello Container World! I have been seen </span><span style="color:#e6db74">{</span>redis<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;hits&#39;</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74"> times and my hostname is </span><span style="color:#e6db74">{</span>socket<span style="color:#f92672">.</span>gethostname()<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><h5 id="增加实例">增加实例</h5>
<p>我们启动3个实例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose up -d --scale flask<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Running 6/6
</span></span><span style="display:flex;"><span> ✔ Network compose-scale-example-1_default           Created                                                                                                                                           0.0s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-client-1        Started                                                                                                                                           0.6s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-flask-2         Started                                                                                                                                           0.9s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-flask-1         Started                                                                                                                                           0.6s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-flask-3         Started                                                                                                                                           0.8s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-redis-server-1  Started
</span></span></code></pre></div><p>使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose ps
</span></span><span style="display:flex;"><span>NAME                                     IMAGE                        COMMAND                  SERVICE             CREATED             STATUS              PORTS
</span></span><span style="display:flex;"><span>compose-scale-example-1-client-1         xiaopeng163/net-box:latest   <span style="color:#e6db74">&#34;sh -c &#39;while true; …&#34;</span>   client              <span style="color:#ae81ff">32</span> seconds ago      Up <span style="color:#ae81ff">31</span> seconds
</span></span><span style="display:flex;"><span>compose-scale-example-1-flask-1          flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   flask               <span style="color:#ae81ff">32</span> seconds ago      Up <span style="color:#ae81ff">31</span> seconds       5000/tcp
</span></span><span style="display:flex;"><span>compose-scale-example-1-flask-2          flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   flask               <span style="color:#ae81ff">32</span> seconds ago      Up <span style="color:#ae81ff">30</span> seconds       5000/tcp
</span></span><span style="display:flex;"><span>compose-scale-example-1-flask-3          flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   flask               <span style="color:#ae81ff">32</span> seconds ago      Up <span style="color:#ae81ff">31</span> seconds       5000/tcp
</span></span><span style="display:flex;"><span>compose-scale-example-1-redis-server-1   redis:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   redis-server        <span style="color:#ae81ff">32</span> seconds ago      Up <span style="color:#ae81ff">31</span> seconds       6379/tcp
</span></span></code></pre></div><p>可以看到有三个实例在运行</p>
<h5 id="减少实例">减少实例</h5>
<p>上面我们增加了3个实例，现在我们2两个实例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose up -d --scale flask<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Running 3/3
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-flask-1         Running                                                                                                                                           0.0s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-redis-server-1  Running                                                                                                                                           0.0s
</span></span><span style="display:flex;"><span> ✔ Container compose-scale-example-1-client-1        Running                                                                                                                                           0.0s
</span></span><span style="display:flex;"><span>$ docker-compose ps
</span></span><span style="display:flex;"><span>NAME                                     IMAGE                        COMMAND                  SERVICE             CREATED             STATUS              PORTS
</span></span><span style="display:flex;"><span>compose-scale-example-1-client-1         xiaopeng163/net-box:latest   <span style="color:#e6db74">&#34;sh -c &#39;while true; …&#34;</span>   client              <span style="color:#ae81ff">3</span> minutes ago       Up <span style="color:#ae81ff">3</span> minutes
</span></span><span style="display:flex;"><span>compose-scale-example-1-flask-1          flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   flask               <span style="color:#ae81ff">3</span> minutes ago       Up <span style="color:#ae81ff">3</span> minutes        5000/tcp
</span></span><span style="display:flex;"><span>compose-scale-example-1-redis-server-1   redis:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   redis-server        <span style="color:#ae81ff">3</span> minutes ago       Up <span style="color:#ae81ff">3</span> minutes        6379/tcp
</span></span></code></pre></div><p>进入容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                        COMMAND                  CREATED             STATUS             PORTS                               NAMES
</span></span><span style="display:flex;"><span>a3a69a577dca   flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">5</span> seconds ago       Up <span style="color:#ae81ff">4</span> seconds       5000/tcp                            compose-scale-example-1-flask-3
</span></span><span style="display:flex;"><span>26c956340150   flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">5</span> seconds ago       Up <span style="color:#ae81ff">4</span> seconds       5000/tcp                            compose-scale-example-1-flask-2
</span></span><span style="display:flex;"><span>b3f3f5b054fb   flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">10</span> minutes ago      Up <span style="color:#ae81ff">10</span> minutes      5000/tcp                            compose-scale-example-1-flask-1
</span></span><span style="display:flex;"><span>69cbaa068bee   redis:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">10</span> minutes ago      Up <span style="color:#ae81ff">10</span> minutes      6379/tcp                            compose-scale-example-1-redis-server-1
</span></span><span style="display:flex;"><span>add6225dff12   xiaopeng163/net-box:latest   <span style="color:#e6db74">&#34;sh -c &#39;while true; …&#34;</span>   <span style="color:#ae81ff">10</span> minutes ago      Up <span style="color:#ae81ff">10</span> minutes                                          compose-scale-example-1-client-1
</span></span><span style="display:flex;"><span>61a42035833e   xiaopeng163/net-box:latest   <span style="color:#e6db74">&#34;/bin/sh -c &#39;while t…&#34;</span>   About an hour ago   Up About an hour                                       compose-box1-1
</span></span><span style="display:flex;"><span>2ec2e9f65996   xiaopeng163/net-box:latest   <span style="color:#e6db74">&#34;/bin/sh -c &#39;while t…&#34;</span>   About an hour ago   Up About an hour                                       compose-box2-1
</span></span><span style="display:flex;"><span>203261814d07   redis:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">5</span> days ago          Up <span style="color:#ae81ff">5</span> days          6379/tcp                            hellopy-redis-server-1
</span></span><span style="display:flex;"><span>e674a0097a3e   flask-demo:latest            <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">5</span> days ago          Up <span style="color:#ae81ff">5</span> days          0.0.0.0:8081-&gt;5000/tcp              hellopy-flask-demo-1
</span></span><span style="display:flex;"><span>d9f0c712b309   nginx:latest                 <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">8</span> days ago          Up <span style="color:#ae81ff">8</span> days          0.0.0.0:8080-&gt;80/tcp                competent_buck
</span></span><span style="display:flex;"><span>033243ce3801   mysql:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago          Up <span style="color:#ae81ff">9</span> days          33060/tcp, 0.0.0.0:3307-&gt;3306/tcp   server-mysql
</span></span><span style="display:flex;"><span>a51d40b5eeea   mongo:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago          Up <span style="color:#ae81ff">9</span> days          0.0.0.0:27017-&gt;27017/tcp            keen_bouman
</span></span><span style="display:flex;"><span>0910b6c23f19   redis:latest                 <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">9</span> days ago          Up <span style="color:#ae81ff">9</span> days          0.0.0.0:6379-&gt;6379/tcp              keen_burnell
</span></span></code></pre></div><p>使用ping命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PING flask <span style="color:#f92672">(</span>172.23.0.4<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.4: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.370 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.4: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.414 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.4: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.348 ms
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- flask ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max <span style="color:#f92672">=</span> 0.348/0.377/0.414 ms
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># ping flask</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PING flask <span style="color:#f92672">(</span>172.23.0.5<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.5: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.402 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.5: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.369 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.5: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.556 ms
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- flask ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max <span style="color:#f92672">=</span> 0.369/0.442/0.556 ms
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># ping flask</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PING flask <span style="color:#f92672">(</span>172.23.0.6<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.6: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.598 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.6: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.357 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.23.0.6: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.374 ms
</span></span></code></pre></div><p>仔细看，我们每次ping连接到不同的实例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl flask:5000</span>
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">1</span> times and my hostname is a3a69a577dca.
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl flask:5000</span>
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">2</span> times and my hostname is a3a69a577dca.
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl flask:5000</span>
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">3</span> times and my hostname is 26c956340150.
</span></span></code></pre></div><h5 id="添加nginx">添加nginx</h5>
<p>目录结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ tree <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>/Users/iceymoss/compose-scale-example-2
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>├── docker-compose.yml
</span></span><span style="display:flex;"><span>├── flask
</span></span><span style="display:flex;"><span>│   ├── Dockerfile
</span></span><span style="display:flex;"><span>│   └── app.py
</span></span><span style="display:flex;"><span>├── nginx
</span></span><span style="display:flex;"><span>	   └── nginx.conf
</span></span></code></pre></div><p>flask和redis和上一个实例一样，这里只展示nginx/nginx.conf</p>
<pre tabindex="0"><code>server {
  listen  80 default_server;
  location / {
    proxy_pass http://flask:5000;
  }
}
</code></pre><p>docker-compose.yml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask</span>:  <span style="color:#75715e">#flask镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./flask</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>: <span style="color:#75715e">#连接的docker网络</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>: <span style="color:#75715e">#redis镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:  <span style="color:#75715e">#连接的docker网络</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nginx</span>:  <span style="color:#75715e">#nginx镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:stable-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8000</span>:<span style="color:#ae81ff">80</span> <span style="color:#75715e">#将镜像端口80映射到宿主机8000端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: <span style="color:#75715e">#执行顺序，这里指必须将flask镜像构建完成并运行后才能运行当前镜像</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">flask</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>: <span style="color:#75715e">#挂载文件</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro</span> <span style="color:#75715e">#将./nginx/nginx.conf挂载到镜像中/etc/nginx/conf.d/default.conf；ro表示read-only</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./var/log/nginx:/var/log/nginx  </span> <span style="color:#75715e">#将镜像中的/var/log/nginx持久化到宿主机./var/log/nginx下</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>: <span style="color:#75715e">#连接的docker网络</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:  <span style="color:#75715e">#创建docker网络</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">frontend</span>:
</span></span></code></pre></div><p>然后直接启动：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose up -d
</span></span></code></pre></div><p>最后我们之间访问：http://127.0.0.1:8000/</p>
<h3 id="环境变量">环境变量</h3>
<p>直接看例子，我们需要然web应用更安全，现在需要给redis设置密码，但是我们的密码不能直接写在<code>docker-compose.yml</code>的环境变量中，我们应该将密码写入和docker-compose.yml文件同目录下的：<code>.env</code>文件中，docker-compose会去读取对应参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask</span>:  <span style="color:#75715e">#flask镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./flask</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_PASS=${REDIS_PASSWORD}</span> <span style="color:#75715e">#flask应用连接到redis，需要使用密码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>: <span style="color:#75715e">#连接的docker网络</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>: <span style="color:#75715e">#redis镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">redis-server --requirepass ${REDIS_PASSWORD} </span> <span style="color:#75715e">#给Redis容器设置密码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:  <span style="color:#75715e">#连接的docker网络</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nginx</span>:  <span style="color:#75715e">#nginx镜像</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:stable-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8000</span>:<span style="color:#ae81ff">80</span> <span style="color:#75715e">#将镜像端口80映射到宿主机8000端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: <span style="color:#75715e">#执行顺序，这里指必须将flask镜像构建完成并运行后才能运行当前镜像</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">flask</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>: <span style="color:#75715e">#挂载文件</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro</span> <span style="color:#75715e">#将./nginx/nginx.conf挂载到镜像中/etc/nginx/conf.d/default.conf；ro表示read-only</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./var/log/nginx:/var/log/nginx  </span> <span style="color:#75715e">#将镜像中的/var/log/nginx持久化到宿主机./var/log/nginx下</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>: <span style="color:#75715e">#连接的docker网络</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:  <span style="color:#75715e">#创建docker网络</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">frontend</span>:
</span></span></code></pre></div><p>.env:</p>
<pre tabindex="0"><code>REDIS_PASSWORD=123456
</code></pre><p>当使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker-compose config <span style="color:#75715e">#查看配置信息</span>
</span></span><span style="display:flex;"><span>name: compose-scale-example-2
</span></span><span style="display:flex;"><span>services:
</span></span><span style="display:flex;"><span>  flask:
</span></span><span style="display:flex;"><span>    build:
</span></span><span style="display:flex;"><span>      context: /Users/iceymoss/moss/mybookprom1/iceymoss/dockerlearn/compose-scale-example-2/flask
</span></span><span style="display:flex;"><span>      dockerfile: Dockerfile
</span></span><span style="display:flex;"><span>    environment:
</span></span><span style="display:flex;"><span>      REDIS_HOST: redis-server
</span></span><span style="display:flex;"><span>      REDIS_PASS: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    image: flask-demo:latest
</span></span><span style="display:flex;"><span>    networks:
</span></span><span style="display:flex;"><span>      backend: null
</span></span><span style="display:flex;"><span>      frontend: null
</span></span><span style="display:flex;"><span>  nginx:
</span></span><span style="display:flex;"><span>    depends_on:
</span></span><span style="display:flex;"><span>      flask:
</span></span><span style="display:flex;"><span>        condition: service_started
</span></span><span style="display:flex;"><span>    image: nginx:stable-alpine
</span></span><span style="display:flex;"><span>    networks:
</span></span><span style="display:flex;"><span>      frontend: null
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>    - mode: ingress
</span></span><span style="display:flex;"><span>      target: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      published: <span style="color:#e6db74">&#34;8000&#34;</span>
</span></span><span style="display:flex;"><span>      protocol: tcp
</span></span><span style="display:flex;"><span>    volumes:
</span></span><span style="display:flex;"><span>    - type: bind
</span></span><span style="display:flex;"><span>      source: /Users/iceymoss/moss/mybookprom1/iceymoss/dockerlearn/compose-scale-example-2/nginx/nginx.conf
</span></span><span style="display:flex;"><span>      target: /etc/nginx/conf.d/default.conf
</span></span><span style="display:flex;"><span>      read_only: true
</span></span><span style="display:flex;"><span>      bind:
</span></span><span style="display:flex;"><span>        create_host_path: true
</span></span><span style="display:flex;"><span>    - type: bind
</span></span><span style="display:flex;"><span>      source: /Users/iceymoss/moss/mybookprom1/iceymoss/dockerlearn/compose-scale-example-2/var/log/nginx
</span></span><span style="display:flex;"><span>      target: /var/log/nginx
</span></span><span style="display:flex;"><span>      bind:
</span></span><span style="display:flex;"><span>        create_host_path: true
</span></span><span style="display:flex;"><span>  redis-server:
</span></span><span style="display:flex;"><span>    command:
</span></span><span style="display:flex;"><span>    - redis-server
</span></span><span style="display:flex;"><span>    - --requirepass
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span><span style="display:flex;"><span>    image: redis:latest
</span></span><span style="display:flex;"><span>    networks:
</span></span><span style="display:flex;"><span>      backend: null
</span></span><span style="display:flex;"><span>networks:
</span></span><span style="display:flex;"><span>  backend:
</span></span><span style="display:flex;"><span>    name: compose-scale-example-2_backend
</span></span><span style="display:flex;"><span>  frontend:
</span></span><span style="display:flex;"><span>    name: compose-scale-example-2_frontend
</span></span></code></pre></div><h3 id="容器的健康检查">容器的健康检查</h3>
<p>健康检查是容器运行状态的高级检查，主要是检查容器所运行的进程是否能正常的对外提供“服务”，比如一个数据库容器，我们不光 需要这个容器是up的状态，我们还要求这个容器的数据库进程能够正常对外提供服务，这就是所谓的健康检查。</p>
<h4 id="参数介绍">参数介绍</h4>
<p>容器本身有一个健康检查的功能，但是需要在Dockerfile里定义，或者在执行docker container run 的时候，通过下面的一些参数指定</p>
<pre tabindex="0"><code>--health-cmd string              Command to run to check health
--health-interval duration       Time between running the check
                                (ms|s|m|h) (default 0s)
--health-retries int             Consecutive failures needed to
                                report unhealthy
--health-start-period duration   Start period for the container to
                                initialize before starting
                                health-retries countdown
                                (ms|s|m|h) (default 0s)
--health-timeout duration        Maximum time to allow one check to
</code></pre><h4 id="实例">实例</h4>
<p>我们还是以flask框架构建的PythonWeb服务</p>
<p>app.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> redis <span style="color:#f92672">import</span> StrictRedis
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>redis <span style="color:#f92672">=</span> StrictRedis(host<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_HOST&#39;</span>, <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>),
</span></span><span style="display:flex;"><span>                    port<span style="color:#f92672">=</span><span style="color:#ae81ff">6379</span>, password<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_PASS&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
</span></span><span style="display:flex;"><span>    redis<span style="color:#f92672">.</span>incr(<span style="color:#e6db74">&#39;hits&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello Container World! I have been seen </span><span style="color:#e6db74">{</span>redis<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;hits&#39;</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74"> times and my hostname is </span><span style="color:#e6db74">{</span>socket<span style="color:#f92672">.</span>gethostname()<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>Dockerfile：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.9.5-slim</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install flask redis <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    apt-get install -y curl <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    groupadd -r flask <span style="color:#f92672">&amp;&amp;</span> useradd -r -g flask flask <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    mkdir /src <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    chown -R flask:flask /src<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> flask</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> app.py /src/app.py<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLASK_APP<span style="color:#f92672">=</span>app.py REDIS_HOST<span style="color:#f92672">=</span>redis<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">HEALTHCHECK --interval=30s --timeout=3s \
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    </span><span style="color:#66d9ef">CMD</span> curl -f http://localhost:5000/ <span style="color:#f92672">||</span> exit <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;flask&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>上面Dockerfili里的HEALTHCHECK 就是定义了一个健康检查。 会每隔30秒检查一次，如果失败就会退出，退出代码是1</p>
<h4 id="构建镜像和创建容器">构建镜像和创建容器</h4>
<p>构建镜像，创建一个bridge网络，然后启动容器连到bridge网络</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker image build -t flask-demo .
</span></span><span style="display:flex;"><span>$ docker network create mybridge
</span></span><span style="display:flex;"><span>$ docker container run -d --network mybridge --env REDIS_PASS<span style="color:#f92672">=</span>abc123 flask-demo
</span></span></code></pre></div><p>查看容器状态</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container ls
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE        COMMAND                  CREATED       STATUS                            PORTS      NAMES
</span></span><span style="display:flex;"><span>059c12486019   flask-demo   <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">4</span> hours ago   Up <span style="color:#ae81ff">8</span> seconds <span style="color:#f92672">(</span>health: starting<span style="color:#f92672">)</span>   5000/tcp   dazzling_tereshkova
</span></span></code></pre></div><p>也可以通过<code>docker container inspect 059</code> 查看详情， 其中有有关health的</p>
<pre tabindex="0"><code>&#34;Health&#34;: {
&#34;Status&#34;: &#34;starting&#34;,
&#34;FailingStreak&#34;: 1,
&#34;Log&#34;: [
    {
        &#34;Start&#34;: &#34;2021-07-14T19:04:46.4054004Z&#34;,
        &#34;End&#34;: &#34;2021-07-14T19:04:49.4055393Z&#34;,
        &#34;ExitCode&#34;: -1,
        &#34;Output&#34;: &#34;Health check exceeded timeout (3s)&#34;
    }
]
}
</code></pre><p>经过3次检查，一直是不通的，然后health的状态会从starting变为 unhealthy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker container ls
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE        COMMAND                  CREATED       STATUS                     PORTS      NAMES
</span></span><span style="display:flex;"><span>059c12486019   flask-demo   <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">4</span> hours ago   Up <span style="color:#ae81ff">2</span> minutes <span style="color:#f92672">(</span>unhealthy<span style="color:#f92672">)</span>   5000/tcp   dazzling_tereshkova
</span></span></code></pre></div><h4 id="启动redis服务器">启动redis服务器</h4>
<p>启动redis，连到mybridge上，name=redis， 注意密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container run -d --network mybridge --name redis redis:latest redis-server --requirepass abc123
</span></span></code></pre></div><p>经过几秒钟，我们的flask 变成了healthy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker container ls
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS                   PORTS      NAMES
</span></span><span style="display:flex;"><span>bc4e826ee938   redis:latest   <span style="color:#e6db74">&#34;docker-entrypoint.s…&#34;</span>   <span style="color:#ae81ff">18</span> seconds ago   Up <span style="color:#ae81ff">16</span> seconds            6379/tcp   redis
</span></span><span style="display:flex;"><span>059c12486019   flask-demo     <span style="color:#e6db74">&#34;flask run -h 0.0.0.0&#34;</span>   <span style="color:#ae81ff">4</span> hours ago      Up <span style="color:#ae81ff">6</span> minutes <span style="color:#f92672">(</span>healthy<span style="color:#f92672">)</span> 
</span></span></code></pre></div><h3 id="docker-compose服务依赖和健康检查">docker-compose服务依赖和健康检查</h3>
<h4 id="服务依赖">服务依赖</h4>
<p>指服务中的各个容器运行的依赖关系，运行顺序等，它是保证应用能完整启动的重要因素，使用参数：</p>
<blockquote>
<p>depends_on:</p>
</blockquote>
<p>例如：下面运行顺序必须是：<code>redis-server -&gt; flask -&gt; nginx</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./flask</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_PASS=${REDIS_PASSWORD}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">test</span>: [<span style="color:#e6db74">&#34;CMD&#34;</span>, <span style="color:#e6db74">&#34;curl&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#e6db74">&#34;http://localhost:5000&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">3s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">start_period</span>: <span style="color:#ae81ff">40s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: <span style="color:#75715e">#在启动flask前必须启动redis-server</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">redis-server --requirepass ${REDIS_PASSWORD}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nginx</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:stable-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8000</span>:<span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">flask</span> <span style="color:#75715e">#启动Nginx前必须启动flaskk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./var/log/nginx:/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">frontend</span>:
</span></span></code></pre></div><h4 id="健康检查">健康检查</h4>
<p>健康检查是容器运行状态的高级检查，主要是检查容器所运行的进程是否能正常的对外提供“服务”，比如一个数据库容器，我们不光 需要这个容器是up的状态，我们还要求这个容器的数据库进程能够正常对外提供服务，这就是所谓的健康检查。</p>
<p>前面我们在构建docker镜像时，介绍了如何进行容器的健康检查，来看看docker-compose是如何实现健康检查的吧。</p>
<p>还是以python的web服务为例，核心是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span> <span style="color:#f92672">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">test</span>: [<span style="color:#e6db74">&#34;CMD&#34;</span>, <span style="color:#e6db74">&#34;curl&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#e6db74">&#34;http://localhost:5000&#34;</span>]  <span style="color:#75715e">#检查地址</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s  </span> <span style="color:#75715e">#30秒重试</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">3s </span> <span style="color:#75715e">#3s无响应则超时</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">3</span>  <span style="color:#75715e">#重复3次</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">start_period</span>: <span style="color:#ae81ff">40s </span> <span style="color:#75715e">#容器运行40s后开始检查</span>
</span></span></code></pre></div><p>在nginx镜像中也有需要注意的地方：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">flask</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">service_healthy</span>
</span></span></code></pre></div><p>他不仅需要依赖flask启动后并且还flask是健康状态。</p>
<p>完整docker-compose.yml：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">flask</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./flask</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">flask-demo:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_HOST=redis-server</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">REDIS_PASS=${REDIS_PASSWORD}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">test</span>: [<span style="color:#e6db74">&#34;CMD&#34;</span>, <span style="color:#e6db74">&#34;curl&#34;</span>, <span style="color:#e6db74">&#34;-f&#34;</span>, <span style="color:#e6db74">&#34;http://localhost:5000&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">30s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeout</span>: <span style="color:#ae81ff">3s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">start_period</span>: <span style="color:#ae81ff">40s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">redis-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis-server</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: <span style="color:#ae81ff">redis-server --requirepass ${REDIS_PASSWORD}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">backend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nginx</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:stable-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8000</span>:<span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">flask</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">condition</span>: <span style="color:#ae81ff">service_healthy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./var/log/nginx:/var/log/nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">frontend</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">frontend</span>:
</span></span></code></pre></div><h3 id="投票app的构建">投票app的构建</h3>
<p>这是github上的一下docker-compose学习的项目</p>
<blockquote>
<p><a href="https://github.com/dockersamples/example-voting-app">https://github.com/dockersamples/example-voting-app</a></p>
</blockquote>
<h2 id="容器编排swarm">容器编排SWARM</h2>
<h3 id="为什么不建议在生产环境中使用docker-compose">为什么不建议在生产环境中使用docker-Compose</h3>
<ul>
<li>多机器如何管理？</li>
<li>如果跨机器做scale横向扩展？</li>
<li>容器失败退出时如何新建容器确保服务正常运行？</li>
<li>如何确保零宕机时间？</li>
<li>如何管理密码，Key等敏感数据？</li>
<li>其它</li>
</ul>
<h3 id="容器编排-swarm">容器编排 swarm</h3>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/docker-compose_swarm.png" alt="docker-swarm-intro"></p>
<p>Swarm的基本架构</p>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/swarm_arch.png" alt="docker-swarm-arch"></p>
<h3 id="docker-swarm-vs-kubernetes">docker swarm vs kubernetes</h3>
<p>k8s在容器编排领域处于绝对领先的地位</p>
<p>2021年redhat调查https://www.redhat.com/en/resources/kubernetes-adoption-security-market-trends-2021-overview</p>
<p><img src="https://dockertips.readthedocs.io/en/latest/docker-swarm/_static/docker-swarm/k8s_vs_swarm.png" alt="docker-swarm-k8s"></p>
<p>为什么还要学些了解docker swarm呢？</p>
<p>原因时docker swarm非常适合容器编排技术的入门，他比k8s简单，但同时他很多地方和K8S相似。</p>
<h3 id="swarm单节点快速搭建">swarm单节点快速搭建</h3>
<h4 id="docker-info命令查看docker配置信息"><code>docker info</code>命令查看docker配置信息</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker info
</span></span><span style="display:flex;"><span>Client:
</span></span><span style="display:flex;"><span> Context:    default
</span></span><span style="display:flex;"><span> Debug Mode: false
</span></span><span style="display:flex;"><span> Plugins:
</span></span><span style="display:flex;"><span>  buildx: Docker Buildx <span style="color:#f92672">(</span>Docker Inc., v0.10.4<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  compose: Docker Compose <span style="color:#f92672">(</span>Docker Inc., v2.17.2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  dev: Docker Dev Environments <span style="color:#f92672">(</span>Docker Inc., v0.1.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  extension: Manages Docker extensions <span style="color:#f92672">(</span>Docker Inc., v0.2.19<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  init: Creates Docker-related starter files <span style="color:#66d9ef">for</span> your project <span style="color:#f92672">(</span>Docker Inc., v0.1.0-beta.2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  sbom: View the packaged-based Software Bill Of Materials <span style="color:#f92672">(</span>SBOM<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> an image <span style="color:#f92672">(</span>Anchore Inc., 0.6.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  scan: Docker Scan <span style="color:#f92672">(</span>Docker Inc., v0.25.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  scout: Command line tool <span style="color:#66d9ef">for</span> Docker Scout <span style="color:#f92672">(</span>Docker Inc., v0.9.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server:
</span></span><span style="display:flex;"><span> Containers: <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>  Running: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>  Paused: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  Stopped: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span> Images: <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span> Server Version: 20.10.24
</span></span><span style="display:flex;"><span> Storage Driver: overlay2
</span></span><span style="display:flex;"><span>  Backing Filesystem: extfs
</span></span><span style="display:flex;"><span>  Supports d_type: true
</span></span><span style="display:flex;"><span>  Native Overlay Diff: true
</span></span><span style="display:flex;"><span>  userxattr: false
</span></span><span style="display:flex;"><span> Logging Driver: json-file
</span></span><span style="display:flex;"><span> Cgroup Driver: cgroupfs
</span></span><span style="display:flex;"><span> Cgroup Version: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> Plugins:
</span></span><span style="display:flex;"><span>  Volume: local
</span></span><span style="display:flex;"><span>  Network: bridge host ipvlan macvlan null overlay
</span></span><span style="display:flex;"><span>  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
</span></span><span style="display:flex;"><span> Swarm: inactive
</span></span><span style="display:flex;"><span> Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux runc
</span></span><span style="display:flex;"><span> Default Runtime: runc
</span></span><span style="display:flex;"><span> Init Binary: docker-init
</span></span><span style="display:flex;"><span> containerd version: 2456e983eb9e37e47538f59ea18f2043c9a73640
</span></span><span style="display:flex;"><span> runc version: v1.1.4-0-g5fd4c4d
</span></span><span style="display:flex;"><span> init version: de40ad0
</span></span><span style="display:flex;"><span> Security Options:
</span></span><span style="display:flex;"><span>  seccomp
</span></span><span style="display:flex;"><span>   Profile: default
</span></span><span style="display:flex;"><span>  cgroupns
</span></span><span style="display:flex;"><span> Kernel Version: 5.15.49-linuxkit
</span></span><span style="display:flex;"><span> Operating System: Docker Desktop
</span></span><span style="display:flex;"><span> OSType: linux
</span></span><span style="display:flex;"><span> Architecture: aarch64
</span></span><span style="display:flex;"><span> CPUs: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span> Total Memory: 3.841GiB
</span></span><span style="display:flex;"><span> Name: docker-desktop
</span></span><span style="display:flex;"><span> ID: ZZII:4R7L:5AY5:XDAI:OMS7:3XQU:X54A:ZK5B:MTXG:QNQ6:RDS6:MYS4
</span></span><span style="display:flex;"><span> Docker Root Dir: /var/lib/docker
</span></span><span style="display:flex;"><span> Debug Mode: true
</span></span><span style="display:flex;"><span>  File Descriptors: <span style="color:#ae81ff">95</span>
</span></span><span style="display:flex;"><span>  Goroutines: <span style="color:#ae81ff">95</span>
</span></span><span style="display:flex;"><span>  System Time: 2023-05-01T07:20:27.796884129Z
</span></span><span style="display:flex;"><span>  EventsListeners: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span> HTTP Proxy: http.docker.internal:3128
</span></span><span style="display:flex;"><span> HTTPS Proxy: http.docker.internal:3128
</span></span><span style="display:flex;"><span> No Proxy: hubproxy.docker.internal
</span></span><span style="display:flex;"><span> Registry: https://index.docker.io/v1/
</span></span><span style="display:flex;"><span> Labels:
</span></span><span style="display:flex;"><span> Experimental: false
</span></span><span style="display:flex;"><span> Insecure Registries:
</span></span><span style="display:flex;"><span>  hubproxy.docker.internal:5555
</span></span><span style="display:flex;"><span>  127.0.0.0/8
</span></span><span style="display:flex;"><span> Registry Mirrors:
</span></span><span style="display:flex;"><span>  https://y8jlo4rd.mirror.aliyuncs.com/
</span></span><span style="display:flex;"><span> Live Restore Enabled: false
</span></span></code></pre></div><p>直接看到：</p>
<pre tabindex="0"><code> Swarm: inactive
</code></pre><p>集群未启动状态</p>
<h4 id="docker-swarm-init命令启动"><code>docker swarm init</code>命令启动</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker swarm init
</span></span><span style="display:flex;"><span>Swarm initialized: current node <span style="color:#f92672">(</span>rphmjmifh51th5g5b9b7bsfto<span style="color:#f92672">)</span> is now a manager.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a worker to this swarm, run the following command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    docker swarm join --token SWMTKN-1-5oz72zzwjh2efd0ydcbttpm9m0pyj9r9e0zdiuj6dn21eclhrc-2bo2oriscpcqoxdjkvq03rgnd 192.168.65.4:2377
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a manager to this swarm, run <span style="color:#e6db74">&#39;docker swarm join-token manager&#39;</span> and follow the instructions.
</span></span></code></pre></div><p>输入命令后主要完成这三件事：</p>
<ul>
<li>创建一个swarm根证书</li>
<li>创建一个manager节点证书</li>
<li>其它节点加入集群需要的tokens</li>
</ul>
<h4 id="docker-node-ls查看service细节"><code>docker node ls</code>查看service细节</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker node ls
</span></span><span style="display:flex;"><span>ID                            HOSTNAME         STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
</span></span><span style="display:flex;"><span>rphmjmifh51th5g5b9b7bsfto *   docker-desktop   Ready     Active         Leader           20.10.24
</span></span></code></pre></div><h4 id="启动服务">启动服务</h4>
<p>使用命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker service create image_name:tag command
</span></span></code></pre></div><p>实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker service create nginx:latest
</span></span><span style="display:flex;"><span>kllluh78f41gvw29v3pv3n4qq
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks
</span></span><span style="display:flex;"><span>1/1: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span></code></pre></div><p>查看service信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME             MODE         REPLICAS   IMAGE          PORTS
</span></span><span style="display:flex;"><span>kllluh78f41g   competent_pike   replicated   1/1        nginx:latest
</span></span></code></pre></div><p>查看replicated信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service ps kllluh78f41g
</span></span><span style="display:flex;"><span>ID             NAME               IMAGE          NODE             DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>kbba77h8z7xp   competent_pike.1   nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">55</span> seconds ago
</span></span></code></pre></div><p>我们看到<code>competent_pike.1</code>是以<code>replicated</code>中的名称<code>competent_pike</code>命名的，可以看到具体容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker container ls
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE               COMMAND                  CREATED              STATUS              PORTS                               NAMES
</span></span><span style="display:flex;"><span>b2d8f8bf1734   nginx:latest        <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   About a minute ago   Up About a minute   80/tcp                              competent_pike.1.kbba77h8z7xp7wcpnhbnwudez
</span></span></code></pre></div><h4 id="横向扩展service">横向扩展service</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service update kll --replicas <span style="color:#ae81ff">3</span>  <span style="color:#75715e">#扩展到3个</span>
</span></span><span style="display:flex;"><span>kll
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">3</span> out of <span style="color:#ae81ff">3</span> tasks
</span></span><span style="display:flex;"><span>1/3: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2/3: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>3/3: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ls  <span style="color:#75715e">#查看service</span>
</span></span><span style="display:flex;"><span>ID             NAME             MODE         REPLICAS   IMAGE          PORTS
</span></span><span style="display:flex;"><span>kllluh78f41g   competent_pike   replicated   3/3        nginx:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ps kll  <span style="color:#75715e">#查看service的具体replicated信息</span>
</span></span><span style="display:flex;"><span>ID             NAME               IMAGE          NODE             DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>kbba77h8z7xp   competent_pike.1   nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">24</span> minutes ago
</span></span><span style="display:flex;"><span>ii7vacxfrjwl   competent_pike.2   nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">2</span> minutes ago
</span></span><span style="display:flex;"><span>lwis7lgygm85   competent_pike.3   nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">2</span> minutes ago
</span></span></code></pre></div><h4 id="维护service">维护service</h4>
<p>上面例子中，我们横向拓展了个service，我们的nginx容器也有3个实例，当我们直接kill掉一个容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE               COMMAND                  CREATED          STATUS          PORTS                               NAMES
</span></span><span style="display:flex;"><span>5ecc47afe8f1   nginx:latest        <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">4</span> minutes ago    Up <span style="color:#ae81ff">4</span> minutes    80/tcp                              competent_pike.3.lwis7lgygm85julwm8yc3jgt8
</span></span><span style="display:flex;"><span>1d5412f96dad   nginx:latest        <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">4</span> minutes ago    Up <span style="color:#ae81ff">4</span> minutes    80/tcp                              competent_pike.2.ii7vacxfrjwlc806sx7vewjwk
</span></span><span style="display:flex;"><span>b2d8f8bf1734   nginx:latest        <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">26</span> minutes ago   Up <span style="color:#ae81ff">26</span> minutes   80/tcp                              competent_pike.1.kbba77h8z7xp7wcpnhbnwudez
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker rm -f 5ecc47afe8f1
</span></span><span style="display:flex;"><span>5ecc47afe8f1
</span></span></code></pre></div><p>然后我们查看swarm的server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME             MODE         REPLICAS   IMAGE          PORTS
</span></span><span style="display:flex;"><span>kllluh78f41g   competent_pike   replicated   3/3        nginx:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ps kllluh78f41g
</span></span><span style="display:flex;"><span>ID             NAME                   IMAGE          NODE             DESIRED STATE   CURRENT STATE            ERROR                         PORTS
</span></span><span style="display:flex;"><span>kbba77h8z7xp   competent_pike.1       nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">27</span> minutes ago
</span></span><span style="display:flex;"><span>ii7vacxfrjwl   competent_pike.2       nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">5</span> minutes ago
</span></span><span style="display:flex;"><span>l1oigik3otgk   competent_pike.3       nginx:latest   docker-desktop   Running         Running <span style="color:#ae81ff">43</span> seconds ago
</span></span><span style="display:flex;"><span>lwis7lgygm85    <span style="color:#ae81ff">\_</span> competent_pike.3   nginx:latest   docker-desktop   Shutdown        Failed <span style="color:#ae81ff">48</span> seconds ago    <span style="color:#e6db74">&#34;task: non-zero exit (137)&#34;</span>
</span></span></code></pre></div><p><strong>解释：当我们的容器出现意外或者其他情况退出后，SWARM会自动帮我们维护之前的3个容器，重新创建对应挂掉的容器，来补补充原来的容器。</strong></p>
<h4 id="移除service">移除service</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME             MODE         REPLICAS   IMAGE          PORTS
</span></span><span style="display:flex;"><span>kllluh78f41g   competent_pike   replicated   3/3        nginx:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service rm kllluh78f41g
</span></span><span style="display:flex;"><span>kllluh78f41g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID        NAME      MODE      REPLICAS   IMAGE     PORTS
</span></span></code></pre></div><h3 id="swram集群搭建">SWRAM集群搭建</h3>
<h4 id="配置节点">配置节点</h4>
<p>这里的集群我们以3个节点为例：一台manager和两台node，我们需要拥有三个节点，这里提供思路：</p>
<ul>
<li><a href="https://labs.play-with-docker.com/">https://labs.play-with-docker.com/</a>  docker为我们提供了web版的虚拟节点。</li>
<li>在本机搭建虚拟机，由于我的环境是mac这里推荐<a href="https://cloud.tencent.com/developer/article/2150583#:~:text=mac%20pro%20M1%20%28ARM%29%E5%AE%89%E8%A3%85%EF%BC%9AVMWare%20Fusion%E5%8F%8Alinux%20%28centos7%2Fubuntu%29%EF%BC%88%E4%B8%80%EF%BC%89,%E5%8F%91%E5%B8%83%E4%BA%8E2022-11-03%2001%3A58%3A50%20%E9%98%85%E8%AF%BB%203.3K%200%200.%E5%BC%95%E8%A8%80%20mac%E5%8F%91%E5%B8%83%E4%BA%86m1%E8%8A%AF%E7%89%87%EF%BC%8C%E5%85%B6%E5%BC%BA%E6%82%8D%E7%9A%84%E6%80%A7%E8%83%BD%E6%94%B6%E5%88%B0%E5%BE%88%E5%A4%9A%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84%E8%BF%BD%E6%8D%A7%EF%BC%8C%E4%BD%86%E6%98%AF%E4%B9%9F%E5%9B%A0%E4%B8%BA%E5%85%B6%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9B%B4%E6%8D%A2%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%BE%88%E5%A4%9A%E8%BD%AF%E4%BB%B6%E6%88%96%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85%E6%88%90%E4%BA%86%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BB%8A%E5%A4%A9%E5%B0%B1%E6%9D%A5%E8%B0%88%E8%B0%88%E5%A6%82%E4%BD%95%E5%9C%A8m1%E4%B8%AD%E5%AE%89%E8%A3%85linux%E8%99%9A%E6%8B%9F%E6%9C%BA">mac如何安装虚拟机</a>。</li>
<li>使用云厂商，例如腾讯云和阿里云，直接使用他们的服务器，但是金钱成本较高。</li>
</ul>
<h4 id="搭建集群">搭建集群</h4>
<p>这里搭建了三台服务器(节点)，分别是：192.168.0.26、192.168.0.27、192.168.0.28</p>
<ul>
<li>
<p>选择26为manager并打开swarm：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker swarm init --advertise-addr<span style="color:#f92672">=</span>192.168.0.26 <span style="color:#75715e">#由于26d有多高对外接口，我们需要进行选择</span>
</span></span><span style="display:flex;"><span>Swarm initialized: current node <span style="color:#f92672">(</span>o0m93woly7v3wrqkdux36v4b1<span style="color:#f92672">)</span> is now a manager.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a worker to this swarm, run the following command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    docker swarm join --token SWMTKN-1-40zzj6ap43rvbpgcu43h26ajr7r63ttr1aaanr60shmckyejah-2aebmwe3k190qpf5hzvw3efg3 192.168.0.26:2377
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To add a manager to this swarm, run <span style="color:#e6db74">&#39;docker swarm join-token manager&#39;</span> and follow the instructions.
</span></span></code></pre></div></li>
<li>
<p>将27，28几点加入manager节点</p>
<p>27:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker swarm join --token SWMTKN-1-40zzj6ap43rvbpgcu43h26ajr7r63ttr1aaanr60shmckyejah-2aebmwe3k190qpf5hzvw3efg3 192.168.0.26:2377
</span></span><span style="display:flex;"><span>This node joined a swarm as a worker.
</span></span></code></pre></div><p>28:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker swarm join --token SWMTKN-1-40zzj6ap43rvbpgcu43h26ajr7r63ttr1aaanr60shmckyejah-2aebmwe3k190qpf5hzvw3efg3 192.168.0.26:2377
</span></span><span style="display:flex;"><span>This node joined a swarm as a worker.
</span></span></code></pre></div></li>
<li>
<p>查看集群</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker node ls
</span></span><span style="display:flex;"><span>ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
</span></span><span style="display:flex;"><span>zwzzjapdzgtkf2550z0koi511     node1      Ready     Active                          20.10.17
</span></span><span style="display:flex;"><span>c9x87lc67sgkr7cafl8bi5fav     node2      Ready     Active                          20.10.17
</span></span><span style="display:flex;"><span>o0m93woly7v3wrqkdux36v4b1 *   node3      Ready     Active         Leader           20.10.17
</span></span></code></pre></div><p>集群搭建完成。</p>
</li>
</ul>
<h4 id="快速上手">快速上手</h4>
<p>直接看实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service create --name ser1 nginx:latest <span style="color:#75715e">#启动service</span>
</span></span><span style="display:flex;"><span>oe8t1o4hxmq0kgi3pxan09vpz
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks 
</span></span><span style="display:flex;"><span>1/1: running   
</span></span><span style="display:flex;"><span>verify: Service converged 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node3<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.26 ~
</span></span><span style="display:flex;"><span>$ docker service ls  <span style="color:#75715e">#查看service</span>
</span></span><span style="display:flex;"><span>ID             NAME      MODE         REPLICAS   IMAGE          PORTS
</span></span><span style="display:flex;"><span>oe8t1o4hxmq0   ser1      replicated   1/1        nginx:latest   
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node3<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.26 ~
</span></span><span style="display:flex;"><span>$ docker service ps oe8 <span style="color:#75715e">#查看service细节</span>
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE          NODE      DESIRED STATE   CURRENT STATE                ERROR     PORTS
</span></span><span style="display:flex;"><span>d56u06fb5ib0   ser1.1    nginx:latest   node3     Running         Running about a minute ago             
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node3<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.26 ~
</span></span></code></pre></div><p>从上面输出可以看到：我们实际容器启动到了我们集群的node3上，可以在node3查看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS     NAMES
</span></span><span style="display:flex;"><span>3594ed694a24   nginx:latest   <span style="color:#e6db74">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#ae81ff">4</span> minutes ago   Up <span style="color:#ae81ff">4</span> minutes   80/tcp    ser1.1.d56u06fb5ib0nwk7wjizi1q4j
</span></span></code></pre></div><p>接着我们来进行横向拓展，将nginx实例增加到3个：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service update ser1 --replicas <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>ser1
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">3</span> out of <span style="color:#ae81ff">3</span> tasks 
</span></span><span style="display:flex;"><span>1/3: running   
</span></span><span style="display:flex;"><span>2/3: running   
</span></span><span style="display:flex;"><span>3/3: running   
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME      MODE         REPLICAS   IMAGE          PORTS
</span></span><span style="display:flex;"><span>oe8t1o4hxmq0   ser1      replicated   3/3        nginx:latest 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ps oe8 
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE          NODE      DESIRED STATE   CURRENT STATE                ERROR     PORTS
</span></span><span style="display:flex;"><span>d56u06fb5ib0   ser1.1    nginx:latest   node3     Running         Running <span style="color:#ae81ff">7</span> minutes ago                  
</span></span><span style="display:flex;"><span>tutfirsas80z   ser1.2    nginx:latest   node1     Running         Running about a minute ago             
</span></span><span style="display:flex;"><span>u0yzkvjv4ev1   ser1.3    nginx:latest   node2     Running         Running about a minute ago 
</span></span></code></pre></div><p>看到实例分别运行在了节点1,2,3上。</p>
<p>和单机环境一样，当集群中是实例，意外挂掉后，整个集群依然会维护3个实例，swarm集群会重新启动对应的实例。</p>
<h4 id="service命令介绍">service命令介绍</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:  docker service COMMAND
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Manage services
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Commands:
</span></span><span style="display:flex;"><span>  create      Create a new service <span style="color:#75715e">#创建service</span>
</span></span><span style="display:flex;"><span>  inspect     Display detailed information on one or more services  <span style="color:#75715e">#展示具体详细信息</span>
</span></span><span style="display:flex;"><span>  logs        Fetch the logs of a service or task <span style="color:#75715e">#日志</span>
</span></span><span style="display:flex;"><span>  ls          List services <span style="color:#75715e">#展示service列表</span>
</span></span><span style="display:flex;"><span>  ps          List the tasks of one or more services  <span style="color:#75715e">#展示具体service信息</span>
</span></span><span style="display:flex;"><span>  rm          Remove one or more services <span style="color:#75715e">#移除service</span>
</span></span><span style="display:flex;"><span>  rollback    Revert changes to a service<span style="color:#e6db74">&#39;s configuration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  scale       Scale one or multiple replicated services
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  update      Update a service #服务横向拓展
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Run &#39;</span>docker service COMMAND --help<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">for</span> more information on a command.
</span></span></code></pre></div><p>​</p>
<h3 id="swarm-的-overlay-网络详解">Swarm 的 overlay 网络详解</h3>
<p>对于理解swarm的网络来讲，个人认为最重要的两个点：</p>
<ul>
<li>第一是外部如何访问部署运行在swarm集群内的服务，可以称之为 <code>入方向</code> 流量，在swarm里我们通过 <code>ingress</code> 来解决</li>
<li>第二是部署在swarm集群里的服务，如何对外进行访问，这部分又分为两块:
<ul>
<li>第一，<code>东西向流量</code> ，也就是不同swarm节点上的容器之间如何通信，swarm通过 <code>overlay</code> 网络来解决；</li>
<li>第二，<code>南北向流量</code> ，也就是swarm集群里的容器如何对外访问，比如互联网，这个是 <code>Linux bridge + iptables NAT</code> 来解决的</li>
</ul>
</li>
</ul>
<h5 id="创建-overlay-网络">创建 overlay 网络</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker network create -d overlay mynet
</span></span></code></pre></div><p>这个网络会同步到所有的swarm节点上</p>
<h5 id="创建服务">创建服务</h5>
<p>创建一个服务连接到这个 overlay网络， name 是 test ， replicas 是 2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service create --network mynet --name test --replicas <span style="color:#ae81ff">2</span> busybox ping 8.8.8.8
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service ps test
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE            NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>yf5uqm1kzx6d   test.1    busybox:latest   swarm-worker1   Running         Running <span style="color:#ae81ff">18</span> seconds ago
</span></span><span style="display:flex;"><span>3tmp4cdqfs8a   test.2    busybox:latest   swarm-worker2   Running         Running <span style="color:#ae81ff">18</span> seconds ago
</span></span></code></pre></div><p>可以看到这两个容器分别被创建在worker1和worker2两个节点上</p>
<h5 id="网络查看">网络查看</h5>
<p>到worker1和worker2上分别查看容器的网络连接情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-worker1:~$ docker container ls
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE            COMMAND          CREATED      STATUS      PORTS     NAMES
</span></span><span style="display:flex;"><span>cac4be28ced7   busybox:latest   <span style="color:#e6db74">&#34;ping 8.8.8.8&#34;</span>   <span style="color:#ae81ff">2</span> days ago   Up <span style="color:#ae81ff">2</span> days             test.1.yf5uqm1kzx6dbt7n26e4akhsu
</span></span><span style="display:flex;"><span>vagrant@swarm-worker1:~$ docker container exec -it cac sh
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># ip a</span>
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>    valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>24: eth0@if25: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue
</span></span><span style="display:flex;"><span>    link/ether 02:42:0a:00:01:08 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 10.0.1.8/24 brd 10.0.1.255 scope global eth0
</span></span><span style="display:flex;"><span>    valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>26: eth1@if27: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue
</span></span><span style="display:flex;"><span>    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 172.18.0.3/16 brd 172.18.255.255 scope global eth1
</span></span><span style="display:flex;"><span>    valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e">#</span>
</span></span></code></pre></div><p>这个容器有两个接口 eth0和eth1， 其中eth0是连到了mynet这个网络，eth1是连到docker_gwbridge这个网络</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-worker1:~$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME              DRIVER    SCOPE
</span></span><span style="display:flex;"><span>a631a4e0b63c   bridge            bridge    local
</span></span><span style="display:flex;"><span>56945463a582   docker_gwbridge   bridge    local
</span></span><span style="display:flex;"><span>9bdfcae84f94   host              host      local
</span></span><span style="display:flex;"><span>14fy2l7a4mci   ingress           overlay   swarm
</span></span><span style="display:flex;"><span>lpirdge00y3j   mynet             overlay   swarm
</span></span><span style="display:flex;"><span>c1837f1284f8   none              null      local
</span></span></code></pre></div><p>在这个容器里是可以直接ping通worker2上容器的IP 10.0.1.9的</p>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/swarm-overlay.PNG" alt="docker-swarm-overlay"></p>
<h3 id="swarm-的-ingress网络">Swarm 的 ingress网络</h3>
<p>docker swarm的ingress网络又叫 <code>Ingress Routing Mesh</code></p>
<p>主要是为了实现把service的服务端口对外发布出去，让其能够被外部网络访问到。</p>
<p>ingress routing mesh是docker swarm网络里最复杂的一部分内容，包括多方面的内容：</p>
<ul>
<li>iptables的 Destination NAT流量转发</li>
<li>Linux bridge, network namespace</li>
<li>使用IPVS技术做负载均衡</li>
<li>包括容器间的通信（overlay）和入方向流量的端口转发</li>
</ul>
<h4 id="service创建">service创建</h4>
<p>创建一个service，指定网络是overlay的mynet， 通过-p把端口映射出来</p>
<p>我们使用的镜像 <code>containous/whoami</code> 是一个简单的web服务，能返回服务器的hostname，和基本的网络信息，比如IP地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service create --name web --network mynet -p 8080:80 --replicas <span style="color:#ae81ff">2</span> containous/whoami
</span></span><span style="display:flex;"><span>a9cn3p0ovg5jcz30rzz89lyfz
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">2</span> tasks
</span></span><span style="display:flex;"><span>1/2: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2/2: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME      MODE         REPLICAS   IMAGE                      PORTS
</span></span><span style="display:flex;"><span>a9cn3p0ovg5j   web       replicated   2/2        containous/whoami:latest   *:8080-&gt;80/tcp
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service ps web
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE                      NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>udlzvsraha1x   web.1     containous/whoami:latest   swarm-worker1   Running         Running <span style="color:#ae81ff">16</span> seconds ago
</span></span><span style="display:flex;"><span>mms2c65e5ygt   web.2     containous/whoami:latest   swarm-manager   Running         Running <span style="color:#ae81ff">16</span> seconds ago
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$
</span></span></code></pre></div><h4 id="service的访问">service的访问</h4>
<p>8080这个端口到底映射到哪里了？尝试三个swarm节点的IP加端口8080</p>
<p>可以看到三个节点IP都可以访问，并且回应的容器是不同的（hostname），也就是有负载均衡的效果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ curl 192.168.200.10:8080
</span></span><span style="display:flex;"><span>Hostname: fdf7c1354507
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.0.7
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>IP: 10.0.1.14
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.0.2:36828
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 192.168.200.10:8080
</span></span><span style="display:flex;"><span>User-Agent: curl/7.68.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ curl 192.168.200.11:8080
</span></span><span style="display:flex;"><span>Hostname: fdf7c1354507
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.0.7
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>IP: 10.0.1.14
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.0.3:54212
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 192.168.200.11:8080
</span></span><span style="display:flex;"><span>User-Agent: curl/7.68.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ curl 192.168.200.12:8080
</span></span><span style="display:flex;"><span>Hostname: c83ee052787a
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.0.6
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>IP: 10.0.1.13
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.0.4:49820
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 192.168.200.12:8080
</span></span><span style="display:flex;"><span>User-Agent: curl/7.68.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span></code></pre></div><p><img src="https://dockertips.readthedocs.io/en/latest/_images/swarm-ingress-logic.PNG" alt="docker-swarm-ingress-logic"></p>
<h4 id="ingress-数据包的走向">ingress 数据包的走向</h4>
<p>以manager节点为例，数据到底是如何达到service的container的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ sudo iptables -nvL -t nat
</span></span><span style="display:flex;"><span>Chain PREROUTING <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">388</span> packets, <span style="color:#ae81ff">35780</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">296</span> <span style="color:#ae81ff">17960</span> DOCKER-INGRESS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21365</span> 1282K DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain INPUT <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">388</span> packets, <span style="color:#ae81ff">35780</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain OUTPUT <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">340</span> packets, <span style="color:#ae81ff">20930</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">8</span>   <span style="color:#ae81ff">590</span> DOCKER-INGRESS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span>    <span style="color:#ae81ff">60</span> DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain POSTROUTING <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">340</span> packets, <span style="color:#ae81ff">20930</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">120</span> MASQUERADE  all  --  *      docker_gwbridge  0.0.0.0/0            0.0.0.0/0            ADDRTYPE match src-type LOCAL
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">252</span> MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> MASQUERADE  all  --  *      !docker_gwbridge  172.18.0.0/16        0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain DOCKER <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> references<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  docker_gwbridge *       0.0.0.0/0            0.0.0.0/0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain DOCKER-INGRESS <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> references<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">120</span> DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.18.0.2:8080
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">302</span> <span style="color:#ae81ff">18430</span> RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span></code></pre></div><p>通过iptables，可以看到一条DNAT的规则，所有访问本地8080端口的流量都被转发到 172.18.0.2:8080</p>
<p>那这个172.18.0.2 是什么？</p>
<p>首先　172.18.0.0/16　这个网段是 <code>docker_gwbridge</code> 的，所以这个地址肯定是连在了 <code>docker_gwbridge</code> 上。</p>
<p><code>docker network inspect docker_gwbridge</code> 可以看到这个网络连接了一个叫　<code>ingress-sbox</code>　的容器。它的地址就是　172.18.0.2/16</p>
<p>这个　<code>ingress-sbox</code>　其实并不是一个容器，而是一个网络的命名空间　network namespace,　我们可以通过下面的方式进入到这个命名空间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$　docker run -it --rm -v /var/run/docker/netns:/netns --privileged<span style="color:#f92672">=</span>true nicolaka/netshoot nsenter --net<span style="color:#f92672">=</span>/netns/ingress_sbox sh
</span></span><span style="display:flex;"><span>~ <span style="color:#75715e"># ip a</span>
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue state UP group default
</span></span><span style="display:flex;"><span>    link/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    inet 10.0.0.2/24 brd 10.0.0.255 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet 10.0.0.5/32 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>10: eth1@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default
</span></span><span style="display:flex;"><span>    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>通过查看地址，发现这个命名空间连接了两个网络，一个eth1是连接了　<code>docker_gwbridge</code>　，另外一个eth0连接了　<code>ingress</code> 这个网络。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~ <span style="color:#75715e"># ip route</span>
</span></span><span style="display:flex;"><span>default via 172.18.0.1 dev eth1
</span></span><span style="display:flex;"><span>10.0.0.0/24 dev eth0 proto kernel scope link src 10.0.0.2
</span></span><span style="display:flex;"><span>172.18.0.0/16 dev eth1 proto kernel scope link src 172.18.0.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~ <span style="color:#75715e"># iptables -nvL -t mangle</span>
</span></span><span style="display:flex;"><span>Chain PREROUTING <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">22</span> packets, <span style="color:#ae81ff">2084</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">12</span>   <span style="color:#ae81ff">806</span> MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 MARK set 0x100
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain INPUT <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">14</span> packets, <span style="color:#ae81ff">1038</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> MARK       all  --  *      *       0.0.0.0/0            10.0.0.5             MARK set 0x100
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain FORWARD <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">8</span> packets, <span style="color:#ae81ff">1046</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain OUTPUT <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">14</span> packets, <span style="color:#ae81ff">940</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Chain POSTROUTING <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">22</span> packets, <span style="color:#ae81ff">1986</span> bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> pkts bytes target     prot opt in     out     source               destination
</span></span><span style="display:flex;"><span>~ <span style="color:#75715e"># ipvsadm</span>
</span></span><span style="display:flex;"><span>IP Virtual Server version 1.2.1 <span style="color:#f92672">(</span>size<span style="color:#f92672">=</span>4096<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Prot LocalAddress:Port Scheduler Flags
</span></span><span style="display:flex;"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span style="display:flex;"><span>FWM  <span style="color:#ae81ff">256</span> rr
</span></span><span style="display:flex;"><span>  -&gt; 10.0.0.6:0                   Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.0.0.7:0                   Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>~ <span style="color:#75715e">#</span>
</span></span></code></pre></div><p>通过ipvs做了负载均衡</p>
<p><img src="https://dockertips.readthedocs.io/en/latest/_images/routing-mesh.PNG" alt="docker-swarm-routing-mesh"></p>
<p>关于这里的负载均衡</p>
<ul>
<li>这是一个stateless load balancing</li>
<li>这是三层的负载均衡，不是四层的 LB is at OSI Layer 3 (TCP), not Layer 4 (DNS)</li>
<li>以上两个限制可以通过Nginx或者HAProxy LB proxy解决 （https://docs.docker.com/engine/swarm/ingress/）</li>
</ul>
<h3 id="内部负载均衡和-vip">内部负载均衡和 VIP</h3>
<p>运行环境说明：</p>
<blockquote>
<p>三个节点：node1，node2，node3</p>
</blockquote>
<p>先创建一个overlay网络：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker network create -d overlay mynet
</span></span><span style="display:flex;"><span>9awkfmjvhuke7d3yb2jecvzj5
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.18 ~
</span></span><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME              DRIVER    SCOPE
</span></span><span style="display:flex;"><span>2cfb1322113a   bridge            bridge    local
</span></span><span style="display:flex;"><span>6c119cf13ecc   docker_gwbridge   bridge    local
</span></span><span style="display:flex;"><span>716510f076fd   host              host      local
</span></span><span style="display:flex;"><span>w75bgwb2ry02   ingress           overlay   swarm
</span></span><span style="display:flex;"><span>9awkfmjvhuke   mynet             overlay   swarm
</span></span><span style="display:flex;"><span>98aeb78df30b   none              null      local
</span></span></code></pre></div><p>启动服务，运行两个实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service create --name web --network mynet --replicas <span style="color:#ae81ff">2</span> containous/whoami
</span></span><span style="display:flex;"><span>t9p1vll3sfbjsi2gx7wypg5ap
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">2</span> tasks 
</span></span><span style="display:flex;"><span>1/2: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>2/2: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>verify: Service converged 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.18 ~
</span></span><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME      MODE         REPLICAS   IMAGE                      PORTS
</span></span><span style="display:flex;"><span>t9p1vll3sfbj   web       replicated   2/2        containous/whoami:latest   
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.18 ~
</span></span><span style="display:flex;"><span>$ docker service ps t9p
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE                      NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>048kh84ygctm   web.1     containous/whoami:latest   node1     Running         Running <span style="color:#ae81ff">26</span> seconds ago            
</span></span><span style="display:flex;"><span>xxontz1r3a46   web.2     containous/whoami:latest   node2     Running         Running <span style="color:#ae81ff">27</span> seconds ago 
</span></span></code></pre></div><p>实例分别运行在node1和node2节点上。</p>
<p>创建一个client服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service create --name client --network mynet xiaopeng163/net-box:latest ping 8.8.8.8
</span></span><span style="display:flex;"><span>enspjcqvgyt1w67lvnbj4wo4l
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks 
</span></span><span style="display:flex;"><span>1/1: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>verify: Service converged 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.18 ~
</span></span><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME      MODE         REPLICAS   IMAGE                        PORTS
</span></span><span style="display:flex;"><span>enspjcqvgyt1   client    replicated   1/1        xiaopeng163/net-box:latest   
</span></span><span style="display:flex;"><span>t9p1vll3sfbj   web       replicated   2/2        containous/whoami:latest     
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.18 ~
</span></span><span style="display:flex;"><span>$ docker service ps ens
</span></span><span style="display:flex;"><span>ID             NAME       IMAGE                        NODE      DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>p0dsew02i1o3   client.1   xiaopeng163/net-box:latest   node3     Running         Running <span style="color:#ae81ff">56</span> seconds ago  
</span></span></code></pre></div><p>我们看到client对应的容器运行的node3上面，去ping web这个service name， 获取到的IP 10.0.1.2，称之为VIP（虚拟IP）:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                        COMMAND          CREATED         STATUS         PORTS     NAMES
</span></span><span style="display:flex;"><span>98498aebb0e5   xiaopeng163/net-box:latest   <span style="color:#e6db74">&#34;ping 8.8.8.8&#34;</span>   <span style="color:#ae81ff">2</span> minutes ago   Up <span style="color:#ae81ff">2</span> minutes             client.1.p0dsew02i1o3sd8io3fflgwja
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker container exec -it <span style="color:#ae81ff">984</span> sh
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl web</span>
</span></span><span style="display:flex;"><span>Hostname: 12b69a220c5f
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.1.3
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.1.9:43876
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: web
</span></span><span style="display:flex;"><span>User-Agent: curl/7.87.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl web</span>
</span></span><span style="display:flex;"><span>Hostname: c059ded2b97c
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.1.4
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.1.9:43942
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: web
</span></span><span style="display:flex;"><span>User-Agent: curl/7.87.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl web</span>
</span></span><span style="display:flex;"><span>Hostname: 12b69a220c5f
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.1.3
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.1.9:43978
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: web
</span></span><span style="display:flex;"><span>User-Agent: curl/7.87.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># curl web</span>
</span></span><span style="display:flex;"><span>Hostname: c059ded2b97c
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: 10.0.1.4
</span></span><span style="display:flex;"><span>IP: 172.18.0.3
</span></span><span style="display:flex;"><span>RemoteAddr: 10.0.1.9:44032
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: web
</span></span><span style="display:flex;"><span>User-Agent: curl/7.87.0
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/omd <span style="color:#75715e"># ping web -c 2</span>
</span></span><span style="display:flex;"><span>PING web <span style="color:#f92672">(</span>10.0.1.2<span style="color:#f92672">)</span>: <span style="color:#ae81ff">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.0.1.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.337 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.0.1.2: seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.183 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- web ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> packets transmitted, <span style="color:#ae81ff">2</span> packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max <span style="color:#f92672">=</span> 0.183/0.260/0.337 ms
</span></span></code></pre></div><p>我们进入client的容器中使用<code>curl</code>命令去请求web，每次返回的<code>Hostname</code>等信息都不一样，原因是<code>swarm</code>给我们做了负载均衡，这里还要提到一个名称<code>VIP</code>虚拟IP的意思。</p>
<p>这个虚拟IP在一个特殊的网络命令空间里，这个空间连接在我们的mynet这个overlay的网络上，通过 docker network inspect mynet 可以看到这个命名空间，叫lb-mynet</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#e6db74">&#34;Containers&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;98498aebb0e55f49bd474240ad8a480d6d52aac277ec7fd959c2e284f5663b45&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;client.1.p0dsew02i1o3sd8io3fflgwja&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;29e5caa1846ec849ee05e523129fb04284d692aa0ed5cfc7fbc2036c7f361293&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:0a:00:01:08&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;10.0.1.8/24&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;lb-mynet&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mynet-endpoint&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;EndpointID&#34;</span>: <span style="color:#e6db74">&#34;5333d1fe1f88d89334e34dd60523af4bb843d3704a42e493205302efcfa4c8cc&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;MacAddress&#34;</span>: <span style="color:#e6db74">&#34;02:42:0a:00:01:09&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;IPv4Address&#34;</span>: <span style="color:#e6db74">&#34;10.0.1.9/24&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;IPv6Address&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#960050;background-color:#1e0010">,</span>
</span></span></code></pre></div><p>通过以下命令可以查看到这个命名空间：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ls /var/run/docker/netns/  <span style="color:#75715e">#查看命名空间</span>
</span></span><span style="display:flex;"><span>1-9awkfmjvhu  1-w75bgwb2ry  6a303ceebaaf  ingress_sbox  lb_9awkfmjvh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo nsenter --net<span style="color:#f92672">=</span>/var/run/docker/netns/1-w75bgwb2ry sh
</span></span><span style="display:flex;"><span>~ <span style="color:#75715e"># ip a</span>
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">65536</span> qdisc noqueue state UNKNOWN qlen <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>2: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue state UP 
</span></span><span style="display:flex;"><span>    link/ether 6e:11:4c:3a:7c:ff brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 10.0.0.1/24 brd 10.0.0.255 scope global br0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>4: vxlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue master br0 state UNKNOWN 
</span></span><span style="display:flex;"><span>    link/ether 6e:11:4c:3a:7c:ff brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>6: veth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue master br0 state UP 
</span></span><span style="display:flex;"><span>    link/ether be:93:fa🆎7a:0d brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>~ <span style="color:#75715e"># </span>
</span></span></code></pre></div><p>在命名空间中我们可以看到虚拟<code>ip:10.0.1.1</code></p>
<p>和ingress网络一样，可以查看iptables，ipvs的负载均衡， 基本就可以理解负载均衡是怎么一回事了。 Mark=0x106, 也就是262（十进制），会轮询把请求发给10.0.1.3 和 10.0.1.4</p>
<h3 id="部署多-service-应用">部署多 service 应用</h3>
<p>如何像docker-compose一样部署多服务应用，这一节我们先看手动的方式。</p>
<p>这里参考构建镜像源码： <a href="https://github.com/xiaopeng163/flask-redis">https://github.com/xiaopeng163/flask-redis</a> ，我们可以将源码下载后，然后在本地构建镜像，然后上传到dockerhub，这里我在学习的时候课程老师已经准备好了镜像，我们之间去拉取就好了。</p>
<p>我们需要先创建一个mynet的overlay网络，因为上面有创建了，这里就演示了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker network ls
</span></span><span style="display:flex;"><span>NETWORK ID     NAME              DRIVER    SCOPE
</span></span><span style="display:flex;"><span>2cfb1322113a   bridge            bridge    local
</span></span><span style="display:flex;"><span>6c119cf13ecc   docker_gwbridge   bridge    local
</span></span><span style="display:flex;"><span>716510f076fd   host              host      local
</span></span><span style="display:flex;"><span>w75bgwb2ry02   ingress           overlay   swarm
</span></span><span style="display:flex;"><span>9awkfmjvhuke   mynet             overlay   swarm
</span></span><span style="display:flex;"><span>98aeb78df30b   none              null      local
</span></span></code></pre></div><p>环境准备完成后我们先来创建一个redis的service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service create --network mynet --name redis redis:latest redis-server --requirepass <span style="color:#ae81ff">123456</span>
</span></span><span style="display:flex;"><span>1mcaqo2jubxi4jdepdvnuclqz
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks 
</span></span><span style="display:flex;"><span>1/1: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span></code></pre></div><p>然后再创建一个flask的service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service create --network mynet --name flask --env REDIS_HOST<span style="color:#f92672">=</span>redis --env REDIS_PASS<span style="color:#f92672">=</span><span style="color:#ae81ff">123456</span> -p 8082:5000 xiaopeng163/flask-redis:latest
</span></span><span style="display:flex;"><span>l6hsr4k8hlupzfmnu9mbz6vnp
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks 
</span></span><span style="display:flex;"><span>1/1: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span></code></pre></div><p>这个web项目就部署完成了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME      MODE         REPLICAS   IMAGE                            PORTS
</span></span><span style="display:flex;"><span>l6hsr4k8hlup   flask     replicated   1/1        xiaopeng163/flask-redis:latest   *:8082-&gt;5000/tcp
</span></span><span style="display:flex;"><span>1mcaqo2jubxi   redis     replicated   1/1        redis:latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker service ps l6hsr4k8hlup
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE                            NODE      DESIRED STATE   CURRENT STATE           ERROR     PORTS
</span></span><span style="display:flex;"><span>tovlp14a3ok0   flask.1   xiaopeng163/flask-redis:latest   node2     Running         Running <span style="color:#ae81ff">3</span> minutes ago             
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>node1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> root@192.168.0.18 ~/flask-redis
</span></span><span style="display:flex;"><span>$ docker service ps 1mcaqo2jubxi
</span></span><span style="display:flex;"><span>ID             NAME      IMAGE          NODE      DESIRED STATE   CURRENT STATE           ERROR     PORTS
</span></span><span style="display:flex;"><span>m9qei72ccye9   redis.1   redis:latest   node1     Running         Running <span style="color:#ae81ff">5</span> minutes ago 
</span></span></code></pre></div><p>然后我们可以两个实例分别在node2和node1上面，现在测试一下这个服务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl 127.0.0.1:8082
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">1</span> times and my hostname is 3e1f0d5b5842.
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8082
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">2</span> times and my hostname is 3e1f0d5b5842.
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8082
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">3</span> times and my hostname is 3e1f0d5b5842.
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:8082
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">4</span> times and my hostname is 3e1f0d5b5842.
</span></span></code></pre></div><p>和预期一致，简单的部署完成。</p>
<h3 id="说明-1">说明</h3>
<p>后面关于swarm内容我直接搬运了<a href="https://coding.imooc.com/learn/list/511.html">慕课网《系统入门 docker》</a>老师的课程博客。</p>
<h3 id="swarm-stack-部署多-service-应用">swarm stack 部署多 service 应用</h3>
<p>先在swarm manager节点上安装一下 docker-compose</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ sudo curl -L <span style="color:#e6db74">&#34;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ sudo chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><p>clone我们的代码仓库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ git clone https://github.com/xiaopeng163/flask-redis
</span></span><span style="display:flex;"><span>Cloning into <span style="color:#e6db74">&#39;flask-redis&#39;</span>...
</span></span><span style="display:flex;"><span>remote: Enumerating objects: 22, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Counting objects: 100% <span style="color:#f92672">(</span>22/22<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Compressing objects: 100% <span style="color:#f92672">(</span>19/19<span style="color:#f92672">)</span>, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>remote: Total <span style="color:#ae81ff">22</span> <span style="color:#f92672">(</span>delta 9<span style="color:#f92672">)</span>, reused <span style="color:#ae81ff">7</span> <span style="color:#f92672">(</span>delta 2<span style="color:#f92672">)</span>, pack-reused <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Unpacking objects: 100% <span style="color:#f92672">(</span>22/22<span style="color:#f92672">)</span>, 8.60 KiB | 1.07 MiB/s, <span style="color:#66d9ef">done</span>.
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ cd flask-redis
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ ls
</span></span><span style="display:flex;"><span>Dockerfile  LICENSE  README.md  app.py  docker-compose.yml
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$
</span></span></code></pre></div><p>环境清理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker system prune -a -f
</span></span></code></pre></div><p>镜像构建和提交， 如果你想做这一步，可以把docker-compose.yml里的 <code>xiaopeng163/flask-redis</code> 改成你的dockerhub id</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker-compose build
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker image ls
</span></span><span style="display:flex;"><span>REPOSITORY                TAG          IMAGE ID       CREATED         SIZE
</span></span><span style="display:flex;"><span>xiaopeng163/flask-redis   latest       5efb4fcbcfc3   <span style="color:#ae81ff">6</span> seconds ago   126MB
</span></span><span style="display:flex;"><span>python                    3.9.5-slim   c71955050276   <span style="color:#ae81ff">3</span> weeks ago     115MB
</span></span></code></pre></div><p>提交镜像到dockerhub</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker login
</span></span><span style="display:flex;"><span>Login with your Docker ID to push and pull images from Docker Hub. If you don<span style="color:#960050;background-color:#1e0010">&#39;</span>t have a Docker ID, head over to https://hub.docker.com to create one.
</span></span><span style="display:flex;"><span>Username: xiaopeng163
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span>WARNING! Your password will be stored unencrypted in /home/vagrant/.docker/config.json.
</span></span><span style="display:flex;"><span>Configure a credential helper to remove this warning. See
</span></span><span style="display:flex;"><span>https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Login Succeeded
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker-compose push
</span></span><span style="display:flex;"><span>WARNING: The REDIS_PASSWORD variable is not set. Defaulting to a blank string.
</span></span><span style="display:flex;"><span>Pushing flask <span style="color:#f92672">(</span>xiaopeng163/flask-redis:latest<span style="color:#f92672">)</span>...
</span></span><span style="display:flex;"><span>The push refers to repository <span style="color:#f92672">[</span>docker.io/xiaopeng163/flask-redis<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>f447d33c161b: Pushed
</span></span><span style="display:flex;"><span>f7395da2fd9c: Pushed
</span></span><span style="display:flex;"><span>5b156295b5a3: Layer already exists
</span></span><span style="display:flex;"><span>115e0863702d: Layer already exists
</span></span><span style="display:flex;"><span>e10857b94a57: Layer already exists
</span></span><span style="display:flex;"><span>8d418cbfaf25: Layer already exists
</span></span><span style="display:flex;"><span>764055ebc9a7: Layer already exists
</span></span><span style="display:flex;"><span>latest: digest: sha256:c909100fda2f4160b593b4e0fb692b89046cebb909ae90546627deca9827b676 size: <span style="color:#ae81ff">1788</span>
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$
</span></span></code></pre></div><p>通过stack启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ env REDIS_PASSWORD<span style="color:#f92672">=</span>ABC123 docker stack deploy --compose-file docker-compose.yml flask-demo
</span></span><span style="display:flex;"><span>Ignoring unsupported options: build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Creating network flask-demo_default
</span></span><span style="display:flex;"><span>Creating service flask-demo_flask
</span></span><span style="display:flex;"><span>Creating service flask-demo_redis-server
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker stack ls
</span></span><span style="display:flex;"><span>NAME         SERVICES   ORCHESTRATOR
</span></span><span style="display:flex;"><span>flask-demo   <span style="color:#ae81ff">2</span>          Swarm
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker stack ps flask-demo
</span></span><span style="display:flex;"><span>ID             NAME                        IMAGE                            NODE            DESIRED STATE   CURRENT STATE
</span></span><span style="display:flex;"><span>ERROR     PORTS
</span></span><span style="display:flex;"><span>lzm6i9inoa8e   flask-demo_flask.1          xiaopeng163/flask-redis:latest   swarm-manager   Running         Running <span style="color:#ae81ff">23</span> seconds ago
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ejojb0o5lbu0   flask-demo_redis-server.1   redis:latest                     swarm-worker2   Running         Running <span style="color:#ae81ff">21</span> seconds ago
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker stack services flask-demo
</span></span><span style="display:flex;"><span>ID             NAME                      MODE         REPLICAS   IMAGE                            PORTS
</span></span><span style="display:flex;"><span>mpx75z1rrlwn   flask-demo_flask          replicated   1/1        xiaopeng163/flask-redis:latest   *:8080-&gt;5000/tcp
</span></span><span style="display:flex;"><span>z85n16zsldr1   flask-demo_redis-server   replicated   1/1        redis:latest
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME                      MODE         REPLICAS   IMAGE                            PORTS
</span></span><span style="display:flex;"><span>mpx75z1rrlwn   flask-demo_flask          replicated   1/1        xiaopeng163/flask-redis:latest   *:8080-&gt;5000/tcp
</span></span><span style="display:flex;"><span>z85n16zsldr1   flask-demo_redis-server   replicated   1/1        redis:latest
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ curl 127.0.0.1:8080
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">1</span> times and my hostname is 21d63a8bfb57.
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ curl 127.0.0.1:8080
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">2</span> times and my hostname is 21d63a8bfb57.
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$ curl 127.0.0.1:8080
</span></span><span style="display:flex;"><span>Hello Container World! I have been seen <span style="color:#ae81ff">3</span> times and my hostname is 21d63a8bfb57.
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~/flask-redis$
</span></span></code></pre></div><h3 id="在-swarm-中使用-secret">在 swarm 中使用 secret</h3>
<p>文档 <a href="https://docs.docker.com/engine/swarm/secrets/">https://docs.docker.com/engine/swarm/secrets/</a></p>
<h4 id="创建secret">创建secret</h4>
<p>有两种方式</p>
<h5 id="从标准的收入读取">从标准的收入读取</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ echo abc123 | docker secret create mysql_pass -
</span></span><span style="display:flex;"><span>4nkx3vpdd41tbvl9qs24j7m6w
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker secret ls
</span></span><span style="display:flex;"><span>ID                          NAME         DRIVER    CREATED         UPDATED
</span></span><span style="display:flex;"><span>4nkx3vpdd41tbvl9qs24j7m6w   mysql_pass             <span style="color:#ae81ff">8</span> seconds ago   <span style="color:#ae81ff">8</span> seconds ago
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker secret inspect mysql_pass
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ID&#34;</span>: <span style="color:#e6db74">&#34;4nkx3vpdd41tbvl9qs24j7m6w&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Index&#34;</span>: <span style="color:#ae81ff">4562</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2021-07-25T22:36:51.544523646Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;UpdatedAt&#34;</span>: <span style="color:#e6db74">&#34;2021-07-25T22:36:51.544523646Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Spec&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mysql_pass&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker secret rm mysql_pass
</span></span><span style="display:flex;"><span>mysql_pass
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$
</span></span></code></pre></div><h5 id="从文件读取">从文件读取</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ ls
</span></span><span style="display:flex;"><span>mysql_pass.txt
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ more mysql_pass.txt
</span></span><span style="display:flex;"><span>abc123
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker secret create mysql_pass mysql_pass.txt
</span></span><span style="display:flex;"><span>elsodoordd7zzpgsdlwgynq3f
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker secret inspect mysql_pass
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ID&#34;</span>: <span style="color:#e6db74">&#34;elsodoordd7zzpgsdlwgynq3f&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Index&#34;</span>: <span style="color:#ae81ff">4564</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CreatedAt&#34;</span>: <span style="color:#e6db74">&#34;2021-07-25T22:38:14.143954043Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;UpdatedAt&#34;</span>: <span style="color:#e6db74">&#34;2021-07-25T22:38:14.143954043Z&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Spec&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;mysql_pass&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Labels&#34;</span>: <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$
</span></span></code></pre></div><h2 id="secret-的使用">secret 的使用</h2>
<p>参考 <a href="https://hub.docker.com/_/mysql">https://hub.docker.com/_/mysql</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service create --name mysql-demo --secret mysql_pass --env MYSQL_ROOT_PASSWORD_FILE<span style="color:#f92672">=</span>/run/secrets/mysql_pass mysql:5.7
</span></span><span style="display:flex;"><span>wb4z2ximgqaefephu9f4109c7
</span></span><span style="display:flex;"><span>overall progress: <span style="color:#ae81ff">1</span> out of <span style="color:#ae81ff">1</span> tasks
</span></span><span style="display:flex;"><span>1/1: running   <span style="color:#f92672">[==================================================</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>verify: Service converged
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service ls
</span></span><span style="display:flex;"><span>ID             NAME         MODE         REPLICAS   IMAGE       PORTS
</span></span><span style="display:flex;"><span>wb4z2ximgqae   mysql-demo   replicated   1/1        mysql:5.7
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$ docker service ps mysql-demo
</span></span><span style="display:flex;"><span>ID             NAME           IMAGE       NODE            DESIRED STATE   CURRENT STATE            ERROR     PORTS
</span></span><span style="display:flex;"><span>909429p4uovy   mysql-demo.1   mysql:5.7   swarm-worker2   Running         Running <span style="color:#ae81ff">32</span> seconds ago
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$
</span></span></code></pre></div><h3 id="swarm-使用-local-volume">swarm 使用 local volume</h3>
<p>本节源码，两个文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">docker-compose.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.8&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mysql:5.7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql_pass</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secrets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">mysql_pass</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">data:/var/lib/mysql</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">secrets</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">mysql_pass</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">file</span>: <span style="color:#ae81ff">mysql_pass.txt</span>
</span></span></code></pre></div><p>mysql_pass.txt:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@swarm-manager:~$ more mysql_pass.txt
</span></span><span style="display:flex;"><span>abc123
</span></span><span style="display:flex;"><span>vagrant@swarm-manager:~$
</span></span></code></pre></div><h2 id="参考">参考</h2>
<h2 id="说明-2">说明</h2>
<p>本文是我在慕课网学习课程《docker 系统入门》课程，总结出的，文字较少，主要是以实例代码的方式来介绍 docker，当然后其中也使用了一些老师课程资料的内容。课程目前还没写完，但是能满足日常后端开发的需求，当然您也可以在我的 <a href="https://github.com/iceymoss/Learning-notes/blob/main/blog/docker/%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0docker.md">github</a> 查看原文。同时也欢迎小伙伴们指出错误。</p>
<h3 id="参考-1">参考</h3>
<p><a href="https://coding.imooc.com/learn/list/511.html">慕课网《系统入门 docker》</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
