<!doctype html>
<html lang="zh-cn">
  <head>
    <title>快速学习Ansible工具 // iceymoss - 刻意练习，卷无止境</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.111.3">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="iceymoss" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="快速学习Ansible工具"/>
<meta name="twitter:description" content="[toc] 写在前面 最近也是在公司因为业务需求而解到了Ansible工具，改工具能快速的帮助我们远程服务器上执行我们想执行的shell命令，想象一下如"/>

    <meta property="og:title" content="快速学习Ansible工具" />
<meta property="og:description" content="[toc] 写在前面 最近也是在公司因为业务需求而解到了Ansible工具，改工具能快速的帮助我们远程服务器上执行我们想执行的shell命令，想象一下如" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iceymoss.github.io/post/%E5%BF%AB%E9%80%9F%E5%AD%A6%E4%B9%A0ansible%E5%B7%A5%E5%85%B7/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-07-17T18:07:35+08:00" />
<meta property="article:modified_time" content="2023-07-17T18:07:35+08:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://iceymoss.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="iceymoss" /></a>
      <span class="app-header-title">iceymoss - 刻意练习，卷无止境</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">首页</a>
             - 
          
          <a class="app-header-menu-item" href="/archives/">归档</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">标签</a>
             - 
          
          <a class="app-header-menu-item" href="/categories/">类别</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">关于</a>
      </nav>
      <p>iceymoss&#39;s blog, Golang Python Developer Life</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">快速学习Ansible工具</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 17, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          5 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://iceymoss.github.io/tags/ansible/">Ansible</a>
              <a class="tag" href="https://iceymoss.github.io/tags/%E5%B7%A5%E5%85%B7/">工具</a>
              <a class="tag" href="https://iceymoss.github.io/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/">命令行</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>[toc]</p>
<h2 id="写在前面">写在前面</h2>
<p>最近也是在公司因为业务需求而解到了Ansible工具，改工具能快速的帮助我们远程服务器上执行我们想执行的shell命令，想象一下如果我们有10台服务器，现在需要查看每一台服务器的运行情况，例如使用top命令，我不会要分别通过ssh命令登录这10台服务器吧，这显然太繁琐了，所以我接下来介绍Ansible工具希望可以帮助你。</p>
<h2 id="ansible安装">Ansible安装</h2>
<p>这里我以macOS为例，安装 Ansible 在 macOS 上可以使用多种方法，最常见的是使用 brew（Homebrew）包管理器进行安装。下面是在 macOS 上安装 Ansible 的步骤：</p>
<ol>
<li>
<p>安装 Homebrew（如果尚未安装）：</p>
<p>打开终端（Terminal），然后运行以下命令安装 Homebrew：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/bash -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> 
</span></span></code></pre></div></li>
<li>
<p>安装 Ansible：</p>
<p>在终端中运行以下命令来安装 Ansible：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install ansible 
</span></span></code></pre></div></li>
<li>
<p>验证安装：</p>
<p>安装完成后，可以通过运行以下命令验证 Ansible 是否已成功安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible --version
</span></span></code></pre></div><p>如果安装成功，将会显示 Ansible 的版本信息。</p>
<p>现在你已经成功在 macOS 上安装了 Ansible。如果你之前没有安装过 Homebrew，上述步骤也会自动安装 Homebrew。请确保你的终端具有管理员权限，以便在安装过程中执行必要的操作。</p>
</li>
</ol>
<h2 id="ansible知识">Ansible知识</h2>
<p>Ansible 是一个自动化运维工具，用于配置管理、应用部署、任务自动化等。它使用简单的 YAML 文件和 SSH 协议来管理和配置远程主机。以下是 Ansible 的一些常见用法：</p>
<ol>
<li>编写 Playbook： Ansible 使用 Playbook 来描述执行任务的计划。Playbook 是一个 YAML 格式的文件，可以在其中定义任务和配置。每个任务都包含一个或多个模块，模块是 Ansible 的基本组件，用于执行特定的任务。</li>
<li>定义主机清单： 在 Playbook 中，你需要定义要管理的远程主机清单。主机清单是一个文本文件，其中列出了你要管理的所有主机的 IP 地址或域名，通常文件格式以<code>ini</code>或者<code>yaml</code>格式。</li>
<li>使用模块执行任务： 在 Playbook 中，你可以使用 Ansible 提供的各种模块来执行任务。例如，你可以使用 command 模块执行命令、copy 模块复制文件、service 模块管理服务等等。</li>
<li>使用变量： Ansible 允许你定义变量来使配置更加灵活和可配置。你可以在 Playbook 中定义变量，并在任务中引用它们。</li>
<li>运行 Playbook： 定义好 Playbook 后，你可以使用 ansible-playbook 命令来运行它。该命令将按照 Playbook 的描述执行任务，并将结果返回给你。</li>
<li>Ad-Hoc 命令： 除了 Playbook，Ansible 还支持 Ad-Hoc 命令，用于在命令行中执行临时任务。例如，你可以使用 ansible 命令执行一次性的命令，而无需编写 Playbook。</li>
<li>Roles： Roles 是 Ansible 的一种组织方式，用于将相关的任务和配置分组。Roles 可以让你更好地组织和管理复杂的配置。</li>
</ol>
<h2 id="ansible实战">Ansible实战</h2>
<p>现在我们使用ansible来对远程服务器执行指定的命令，这里就以top命令为例</p>
<ol>
<li>
<p>编写服务器或者服务器组清单：hosts.ini</p>
<pre tabindex="0"><code>[webservers]
1.*.*.202 ansible_user=user_name ansible_password=password
1.*.*.203 ansible_user=user_name ansible_password=password
1.*.*.205 ansible_user=user_name ansible_password=password
1.*.*.215 ansible_user=user_name ansible_password=password
1.*.*.201 ansible_user=user_name ansible_password=password
</code></pre></li>
<li>
<p>编写一个top_command.yaml的Playbook文件：top_command.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Execute top command on servers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">webservers</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">become</span>: <span style="color:#66d9ef">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Run top command</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>: <span style="color:#ae81ff">top -n 1 -b</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">register</span>: <span style="color:#ae81ff">top_output</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Display top command output</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">var</span>: <span style="color:#ae81ff">top_output.stdout_lines</span>
</span></span></code></pre></div><p>解释一下这个 Playbook：</p>
<ul>
<li>hosts: webservers：指定了在哪些主机上执行任务，这里指定了 webservers 组，即你的三台服务器。</li>
<li>become: yes：表示在执行任务时切换到管理员权限，以便执行 top 命令。</li>
<li>tasks:：定义了一系列任务。</li>
<li>- name: Run top command：第一个任务的名称，描述了这个任务的目标。</li>
<li>command: top -n 1 -b：使用 Ansible 的 command 模块来执行 top 命令，并通过 -n 1 参数指定只执行一次，并使用 -b 参数使 top 命令以批处理模式运行。</li>
<li>register: top_output：将 top 命令的输出保存到 top_output 变量中。</li>
<li>- name: Display top command output：第二个任务的名称，描述了这个任务的目标。</li>
<li>debug: var: top_output.stdout_lines：使用 Ansible 的 debug 模块来输出 top_output 变量的 stdout_lines 属性，即 top 命令的输出结果。</li>
</ul>
<p>保存并退出文件。</p>
<p>完成两个文件后，我们直接执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook -i hosts.ini top_command.yaml
</span></span></code></pre></div><p><em><strong>注意</strong></em>：如果你遇到以下报错</p>
<pre tabindex="0"><code>FAILED! =&gt; {&#34;msg&#34;: &#34;to use the &#39;ssh&#39; connection type with passwords or pkcs11_provider, you must install the sshpass program&#34;}
</code></pre><p>你应该使用命令安装ssh工具：</p>
<pre tabindex="0"><code>brew install hudochenkov/sshpass/sshpass
</code></pre><p>可以看到输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PLAY <span style="color:#f92672">[</span>Execute top command on servers<span style="color:#f92672">]</span> **********************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#f92672">[</span>Gathering Facts<span style="color:#f92672">]</span> *************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#f92672">[</span>1.1*.*.*<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#f92672">[</span>Run top command<span style="color:#f92672">]</span> *************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>changed: <span style="color:#f92672">[</span>1.1*.*.*<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#f92672">[</span>Display top command output<span style="color:#f92672">]</span> **************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#f92672">[</span>1.1*.*.202<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;top_output.stdout_lines&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top - 17:06:42 up 212 days, 18:36,  1 user,  load average: 0.06, 0.04, 0.03&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Tasks: 146 total,   1 running, 102 sleeping,   0 stopped,   0 zombie&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;%Cpu(s):  0.6 us,  0.6 sy,  0.0 ni, 98.8 id,  0.1 wa,  0.0 hi,  0.0 si,  0.0 st&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;KiB Mem :  3514764 total,   129196 free,  2767000 used,   618568 buff/cache&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;KiB Swap:        0 total,        0 free,        0 used.   470736 avail Mem &#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    8 root      20   0       0      0      0 I   6.7  0.0  53:42.65 rcu_sched&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34; 1822 mysql     20   0 1654824 235764      0 S   6.7  6.7  97:11.73 mysqld&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    1 root      20   0  225568   6988   4312 S   0.0  0.2  11:43.94 systemd&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    2 root      20   0       0      0      0 S   0.0  0.0   0:06.10 kthreadd&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    4 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 kworker/0:+&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    6 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 mm_percpu_+&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    7 root      20   0       0      0      0 S   0.0  0.0   2:47.59 ksoftirqd/0&#34;</span>,
</span></span><span style="display:flex;"><span>        ……
</span></span><span style="display:flex;"><span>        ……
</span></span><span style="display:flex;"><span>        ……
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;29512 www-data  20   0  329756  64712  30836 S   0.0  1.8  10:11.20 php-fpm7.2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ok: <span style="color:#f92672">[</span>1.1*.*.205<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;top_output.stdout_lines&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;top - 17:06:42 up 212 days, 18:36,  1 user,  load average: 0.06, 0.04, 0.03&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Tasks: 146 total,   1 running, 102 sleeping,   0 stopped,   0 zombie&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;%Cpu(s):  0.6 us,  0.6 sy,  0.0 ni, 98.8 id,  0.1 wa,  0.0 hi,  0.0 si,  0.0 st&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;KiB Mem :  3514764 total,   129196 free,  2767000 used,   618568 buff/cache&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;KiB Swap:        0 total,        0 free,        0 used.   470736 avail Mem &#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    8 root      20   0       0      0      0 I   6.7  0.0  53:42.65 rcu_sched&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34; 1822 mysql     20   0 1654824 235764      0 S   6.7  6.7  97:11.73 mysqld&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    1 root      20   0  225568   6988   4312 S   0.0  0.2  11:43.94 systemd&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    2 root      20   0       0      0      0 S   0.0  0.0   0:06.10 kthreadd&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    4 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 kworker/0:+&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    6 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 mm_percpu_+&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;    7 root      20   0       0      0      0 S   0.0  0.0   2:47.59 ksoftirqd/0&#34;</span>,
</span></span><span style="display:flex;"><span>        ……
</span></span><span style="display:flex;"><span>        ……
</span></span><span style="display:flex;"><span>        ……
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;29512 www-data  20   0  329756  64712  30836 S   0.0  1.8  10:11.20 php-fpm7.2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>……
</span></span><span style="display:flex;"><span>……
</span></span><span style="display:flex;"><span>……
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP *************************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>1.*.*.202               : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>这样我们就可以直接操作多台服务器，避免了大量重复工作，有时间更好的摸鱼了！</p>
</li>
</ol>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
